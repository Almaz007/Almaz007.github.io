import{r as d,j as m}from"./index-DtH0rb0E.js";import{u as G}from"./store-DGTbGRR3.js";import{s as I}from"./shallow-ByBTlhTs.js";function J(t,s,o){const c=[];for(let l=0;l<t.times.length;l++){const a=t.times[l],M=l<t.times.length-1?t.times[l+1]:o,r=Math.max(a+s,M);c.push({time:a,endTime:r,value:t.values[l],dataType:t.dataType})}return c}function K(t,s=8){if(t<=0)return 1;const o=t/s,c=Math.pow(10,Math.floor(Math.log10(o))),l=[1,2,5].map(a=>a*c);for(const a of l)if(o<=a)return a;return 10*c}const Q=({signals:t,height:s=500,rowHeight:o=20,ySpacing:c=6,defaultDurationMs:l=1,initialPxPerMs:a=20,minBlockWidthPx:M=2,labelWidth:r=140})=>{const A=d.useRef(null),k=d.useRef(null),[u,B]=d.useState(a),[S,z]=d.useState(0);console.log("scroll: ",S);const j=d.useMemo(()=>t.reduce((n,e)=>{const x=e.times[e.times.length-1]??0;return Math.max(n,x+l)},0),[t,l]),O=d.useMemo(()=>{const n=new Map;for(const e of t)n.set(e.offset,J(e,l,j));return n},[t,l,j]);console.log(j);const v=Math.max(200,Math.ceil(j*u)+r);return d.useEffect(()=>{const n=k.current;if(!n)return;const e=()=>z(n.scrollLeft);return n.addEventListener("scroll",e),()=>n.removeEventListener("scroll",e)},[]),d.useEffect(()=>{const n=A.current;if(!n)return;const e=n.getContext("2d");if(!e)return;const x=window.devicePixelRatio||1;console.log("width: ",v),console.log("canvas dpr width: ",v*x),console.log("canvas dpr height: ",s*x),n.width=v*x,n.height=s*x,e.setTransform(x,0,0,x,0,0),e.clearRect(0,0,v,s);const C=k.current,$=C?C.clientWidth:v,w=(S-r)/u,E=(S+$-r)/u,P=K(E-w,8),F=Math.floor(w/P)*P;e.strokeStyle="#eee",e.fillStyle="#333",e.font="11px sans-serif",e.textAlign="center",e.textBaseline="top";for(let f=F;f<E;f+=P){const g=r+f*u;e.beginPath(),e.moveTo(g,0),e.lineTo(g,s-20),e.stroke(),e.fillText(`${f} ms`,g,s-18)}t.forEach((f,g)=>{const i=g*(o+c)+10,N=O.get(f.offset);N.forEach((p,X)=>{if(p.endTime<w||p.time>E)return;const y=r+p.time*u,h=r+p.endTime*u,b=Math.max(M,h-y);if(f.dataType==="bool"){const T=i+o,_=i,L=p.value===1?_:T;e.beginPath(),e.moveTo(y,L),e.lineTo(h,L),e.strokeStyle="#2b6cb0",e.lineWidth=2,e.stroke();const R=N[X+1];if(R&&R.value!==p.value){const q=R.value===1?_:T;e.beginPath(),e.moveTo(h,L),e.lineTo(h,q),e.stroke()}}else{const T=Math.min(5,Math.max(.5,b/2-.5));e.beginPath(),e.moveTo(y+T,i),e.lineTo(h-T,i),e.lineTo(h,i+o/2),e.lineTo(h-T,i+o),e.lineTo(y+T,i+o),e.lineTo(y,i+o/2),e.closePath(),e.fillStyle="#90cdf4",e.strokeStyle="#2b6cb0",e.fill(),e.stroke(),String(p.value).length*7<b&&(e.fillStyle="#000",e.font="11px sans-serif",e.textAlign="center",e.textBaseline="middle",e.fillText(String(p.value),y+b/2,i+o/2))}}),e.fillStyle="#444",e.font="12px sans-serif",e.textAlign="right",e.textBaseline="middle",e.fillText(f.name??`Offset ${f.offset}`,r-4,i+o/2)})},[u,S,t,O,s,o,c,M,v,r]),m.jsxs("div",{children:[m.jsxs("div",{style:{display:"flex",gap:8,marginBottom:8},children:[m.jsx("button",{onClick:()=>B(n=>Math.max(2,n/1.25)),children:"–"}),m.jsx("button",{onClick:()=>B(n=>Math.min(1e3,n*1.25)),children:"+"}),m.jsxs("div",{children:["px/ms: ",u.toFixed(1)]})]}),m.jsx("div",{ref:k,style:{width:"100%",overflow:"auto",border:"1px solid #ddd"},children:m.jsx("canvas",{ref:A,style:{width:v,height:"auto"}})})]})},U={"offset-rows":"_offset-rows_nun66_1"},W=({})=>{const[t]=G(o=>[o.oscillographicOffsets,o.toggleSend],I),s=d.useMemo(()=>Object.entries(t).map(([o,c])=>({offset:Number(o),name:c.name,times:c.timePoints,values:c.values,dataType:c.dataType})),[t]);return m.jsxs("div",{className:U["offset-rows"],style:{overflowX:"auto",maxWidth:"100%",padding:6},children:[s.length!==0&&m.jsx(Q,{signals:s}),s.length===0&&"Нет осцилографированных данных"]})};export{W as default};
