import{r as _,j as s,c as y}from"./index-uAQlHVlY.js";import{u as D}from"./store-Otes-7LU.js";import{d as v}from"./helpers-fab74NUc.js";import{c as N,s as j}from"./shallow-vNVvJPD-.js";import{B as z}from"./Button-BXPq6rVN.js";import{u as F}from"./store-wtlwPlml.js";import{u as C}from"./store-DMgJorfu.js";const k="_wrapper_zxo5y_1",A="_form_zxo5y_17",T="_drag_zxo5y_29",$="_label_zxo5y_43",B="_input_zxo5y_49",E="_info_zxo5y_93",U="_btns_zxo5y_103",c={wrapper:k,form:A,drag:T,"action-title":"_action-title_zxo5y_35",label:$,input:B,"file-list":"_file-list_zxo5y_63","download-label":"_download-label_zxo5y_73",info:E,btns:U,"button-reset":"_button-reset_zxo5y_111","button-submit":"_button-submit_zxo5y_113","dnd-tile":"_dnd-tile_zxo5y_135"},S=({handleSubmit:r,title:g})=>{const[t,n]=_.useState([]),[l,m]=_.useState(!1),f=o=>{o.preventDefault(),o.target.files&&o.target.files[0]&&n([o.target.files[0]])},d=()=>{n([])},i=function(o){o.preventDefault(),m(!0)},p=function(o){o.preventDefault(),m(!1)},b=function(o){var e;o.preventDefault(),m(!1),(e=o.dataTransfer)!=null&&e.files&&o.dataTransfer.files[0]&&n([o.dataTransfer.files[0]])};return s.jsxs("div",{className:y(c.wrapper,{[c.drag]:l}),children:[s.jsx("h2",{className:c["dnd-tile"],children:g}),s.jsxs("form",{className:y(c.form),onReset:d,onDragEnter:i,onDragOver:i,onDragLeave:p,onDrop:b,children:[s.jsx("h2",{className:c["action-title"],children:"Перетащите файлы сюда"}),s.jsx("p",{children:"или"}),s.jsxs("label",{className:c.label,children:[s.jsx("span",{className:c["download-label"],children:"Загрузите файл"}),s.jsx("input",{className:c.input,type:"file",multiple:!1,onChange:f})]}),t.length>0&&s.jsxs("div",{className:c.info,children:[s.jsx("ul",{className:c["file-list"],children:s.jsx("li",{children:t[0].name})}),s.jsxs("div",{className:c.btns,children:[s.jsx("button",{className:c["button-reset"],type:"reset",children:"Отменить"}),s.jsx("button",{className:c["button-submit"],onClick:o=>r(o,t),children:"Отправить"})]})]})]})]})},O=N((r,g)=>({ws:null,status:"disconnected",error:null,messages:[],strForDownload:[],parseOscilografFile:async t=>{const{strForDownload:n}=g();let l=await t.arrayBuffer(),m;const f=new Uint8Array(l),d=f.indexOf(44);d!==-1&&(l=l.slice(d+1),m=new TextDecoder().decode(f.slice(0,d)));const i=new DataView(l),p={};for(let e=0;e+16<=i.byteLength;e+=16){const a=i.getUint32(e,!0);if(a===0)return;const u=i.getUint32(e+4,!0),h=i.getUint32(e+8,!0),x=i.getUint32(e+12,!0),w=`номер пакета: ${m}, номер: ${a}, метка: ${u}, смещение: ${h}, значение: ${x}`;console.log(w),n.push(w),p[h]||(p[h]={timePoints:[],values:[]}),p[h].timePoints.push(u),p[h].values.push(x)}n.push(`endPart

`),r({strForDownload:n});const b=D.getState(),o=i.byteLength===1216;if(o){const u=`dataLogicAnalyzer_${new Date().toISOString().replace("T","_").replace(/:/g,"-").split(".")[0]}.txt`;v(n.join(`
`),u,"text/plain"),r({strForDownload:[]})}b.updateOscillographicData(p,o)},connect:t=>{let{ws:n,parseOscilografFile:l,status:m}=g();n||(r({status:"connecting",error:null}),n=new WebSocket(t),r({ws:n}),n.onopen=()=>{r({error:null,status:"connected"}),console.log("WebSocket connected")},n.onmessage=async f=>{f.data instanceof Blob?(r(d=>({messages:[...d.messages,`Получен бинарный пакет ${d.messages.length+1}`]})),await l(f.data)):(console.log("Получено с сервера:",f.data),r(d=>({messages:[...d.messages,f.data.toString()]})))},n.onerror=()=>{r({error:"Connection error",status:"disconnected"})},n.onclose=()=>{console.log("WebSocket closed. Status was:",m),n=null,r({ws:null,status:"disconnected"})})},disconnect:()=>{const{ws:t}=g();t&&(t.close(),r({ws:null,status:"disconnected"}))},sendMessage:t=>{const{ws:n}=g();n&&(r(l=>({messages:[...l.messages,t]})),n.send(t))},sendFile:t=>{const{ws:n}=g();n&&(r(l=>({messages:[...l.messages,"Файл отправлен"]})),n.send(t))},sendConfig:t=>{const{ws:n}=g();n&&(r(l=>({messages:[...l.messages,"Конфиг отправлен"]})),n.send(t))}})),W="_row_q0ihq_1",L={row:W},Y=()=>{const r=C(e=>e.sendFirmware),[g,t,n,l,m,f,d]=O(e=>[e.status,e.error,e.messages,e.connect,e.disconnect,e.sendConfig,e.sendFile],j),i=F(e=>e.config,j),p=()=>{const e=new TextEncoder().encode(JSON.stringify(i));if(e.length===0){console.log("конфиг не отправлен");return}const a=new TextEncoder().encode("flexibleLogic,"),u=new Uint8Array(a.length+e.length);u.set(a,0),u.set(e,a.length),f(u)},b=async(e,a)=>{if(e.preventDefault(),!a||a.length===0)return;const u=await a[0].arrayBuffer(),h=new Uint8Array(u),x=new TextEncoder().encode("firmware,"),w=new Uint8Array(x.length+h.length);w.set(x,0),w.set(h,x.length),d(w)},o=async(e,a)=>{if(e.preventDefault(),!a||a.length===0)return;const u=await a[0].arrayBuffer();r(u)};return s.jsxs("div",{children:[s.jsx("h2",{children:"WebSocket"}),s.jsxs("p",{children:["Status: ",g," ",t&&`| Error: ${t}`]}),s.jsx("button",{onClick:()=>l("wss://int-rt.ru:3010"),children:"Подключить"}),s.jsx("br",{}),s.jsx("button",{onClick:m,children:"Отключить"}),s.jsx("div",{style:{height:"300px",overflowY:"auto",border:"1px solid blue",padding:"10px",marginTop:"10px"},children:n.map((e,a)=>s.jsx("p",{children:e},a))}),s.jsx("br",{}),s.jsxs("div",{className:L.row,children:[s.jsx(S,{handleSubmit:b,title:"Отправка прошивки по web-socket"}),s.jsx(S,{handleSubmit:o,title:"Отправка прошивки по ble"}),s.jsxs("div",{children:[s.jsx(z,{disabled:!i.scripts.length,onClick:p,text:"загрузить гибкую логику"}),s.jsx("br",{}),!i.scripts.length&&s.jsx("div",{children:"необходимо сформировать гибкую логику"})]})]})]})};export{Y as default};
