import{r,j as a}from"./index-C3qQ2WG5.js";import{u as U}from"./store-DRn1rbs-.js";import{s as Z}from"./shallow-D7DO0VyS.js";function te(n,o,s){const t=[];for(let i=0;i<n.times.length;i++){const c=n.times[i],f=i<n.times.length-1?n.times[i+1]:s,x=Math.max(c+o,f);t.push({time:c,endTime:x,value:n.values[i],dataType:n.dataType,typeView:n.typeView})}return t}function ne(n,o=8){if(n<=0)return 1;const s=n/o,t=Math.pow(10,Math.floor(Math.log10(s))),i=[1,2,5].map(c=>c*t);for(const c of i)if(s<=c)return c;return 10*t}const se={"main-block":"_main-block_4w5ja_3"},oe=()=>{const n=r.useRef(null),[o,s]=r.useState(1e3);return r.useEffect(()=>{const t=n.current;if(!t)return;const i=()=>s(t.clientWidth);i();const c=new ResizeObserver(i);return c.observe(t),()=>c.disconnect()},[]),{containerWidth:o,containerRef:n}},K=1e-6,ce=(n,o,s,t,i,c=1,f)=>{const{containerWidth:x,containerRef:R}=oe(),w=r.useRef(null),b=r.useRef(null),[d,_]=r.useState(()=>Math.max(K,n)),[j,C]=r.useState(0),[A,O]=r.useState(0);r.useEffect(()=>{_(l=>l===n?l:n)},[n]),r.useEffect(()=>{const l=()=>O(e=>e+1);return window.addEventListener("resize",l),window.addEventListener("orientationchange",l),()=>{window.removeEventListener("resize",l),window.removeEventListener("orientationchange",l)}},[]);const M=r.useMemo(()=>o.reduce((l,e)=>{const $=e.times[e.times.length-1]??0;return Math.max(l,$+c)},0),[o,c]),F=r.useMemo(()=>{const l=o.map(e=>e.times[0]).filter(e=>typeof e=="number");return l.length?Math.min(...l):0},[o]),g=d>K?x/d:1/0,I=r.useMemo(()=>Math.ceil(Math.max(0,M-g)),[M,g]);r.useEffect(()=>{C(l=>Math.min(I,Math.max(F,l)))},[I,F]);const k=r.useMemo(()=>{const l=new Map;for(const e of o)l.set(e.offset,te(e,c,M));return l},[o,c,M]);r.useEffect(()=>{const l=w.current;if(!l)return;const e=l.getContext("2d");if(!e)return;const $=window.devicePixelRatio||1;l.style.width=`${x}px`,l.style.height=`${t}px`,l.width=Math.max(1,Math.round(x*$)),l.height=Math.max(1,Math.round(t*$)),e.setTransform($,0,0,$,0,0),e.clearRect(0,0,x,t);const v=j,V=Number.isFinite(g)&&g>0?j+g:j+1,P=ne(V-v,8);if(!(P>0))return;const D=()=>{e.clearRect(0,0,x,t);const H=Math.floor(v/P)*P;e.strokeStyle="#eee",e.fillStyle="#333",e.font="12px sans-serif",e.textAlign="center",e.textBaseline="top";for(let L=H;L<V;L+=P){const B=(L-v)*d;e.beginPath(),e.moveTo(B,0),e.lineTo(B,t-20),e.stroke(),e.fillText(`${L} ms`,B,t-18)}o.forEach((L,B)=>{const S=10+B*(s+i),p=k.get(L.offset);if(!(!p||p.length===0))if(L.typeView==="line"){e.lineWidth=2,e.strokeStyle="#2b6cb0";for(let h=0;h<p.length;h++){const u=p[h];if(u.endTime<v||u.time>V)continue;const y=(u.time-v)*d,m=(u.endTime-v)*d,E=S,N=S+s,z=u.value===1?E:N;e.beginPath(),e.moveTo(y,z),e.lineTo(m,z),e.stroke();const T=p[h+1];if(T&&T.value!==u.value){const q=T.value===1?E:N;e.beginPath(),e.moveTo(m,z),e.lineTo(m,q),e.stroke()}}}else if(L.typeView==="point"){if(p.length<2)return;const h=p.findIndex(T=>T.time>=v),u=p.findIndex(T=>T.time>V);let y=[];if(h===-1&&u===-1?y=p.slice(Math.max(0,p.length-2)):h===-1?y=p.slice(0,u+1):u===-1?y=p.slice(Math.max(0,h-1)):y=p.slice(Math.max(0,h-1),u+1),y.length<2)return;const m=[...y];m[0].time>v&&m.unshift({...m[0],time:v}),m[m.length-1].time<V&&m.push({...m[m.length-1],time:V});const E=m.map(T=>Number(T.value||0)),N=Math.min(...E),z=Math.max(...E);e.beginPath(),e.strokeStyle="#2b6cb0",e.lineWidth=2,m.forEach((T,q)=>{const G=(T.time-v)*d,ee=z===N?.5:(Number(T.value)-N)/(z-N),J=S+s-ee*s;q===0?e.moveTo(G,J):e.lineTo(G,J)}),e.stroke()}else p.forEach(h=>{if(h.endTime<v||h.time>V)return;const u=(h.time-v)*d,y=(h.endTime-v)*d,m=Math.max(f,y-u),E=Math.min(5,Math.max(.5,m/2-.5));e.beginPath(),e.moveTo(u+E,S),e.lineTo(y-E,S),e.lineTo(y,S+s/2),e.lineTo(y-E,S+s),e.lineTo(u+E,S+s),e.lineTo(u,S+s/2),e.closePath(),e.fillStyle="#90cdf4",e.strokeStyle="#2b6cb0",e.fill(),e.stroke();const N=String(h.value);e.font="13px sans-serif",e.measureText(N).width+6<m&&(e.fillStyle="#000",e.textAlign="center",e.textBaseline="middle",e.fillText(N,u+m/2,S+s/2))})})};return b.current&&cancelAnimationFrame(b.current),b.current=requestAnimationFrame(D),()=>{b.current&&cancelAnimationFrame(b.current),b.current=null}},[d,j,k,t,s,i,x,f,A,g,o]);const Y=r.useCallback(()=>{M<=0||(_(20),C(()=>Math.min(I,F)))},[x,M]);return{canvasRef:w,pxPerMs:d,scrollMs:j,setScrollMs:C,setPxPerMs:_,maxEndTime:M,maxScrollMs:I,minStartTime:F,containerRef:R,handleFitAll:Y,viewDurationMs:g,recordsByOffset:k}},X={"control-panel":"_control-panel_c31wo_3","control-btn":"_control-btn_c31wo_29"},ie=({viewDurationMs:n,scrollMs:o,pxPerMs:s,setPxPerMs:t,handleFitAll:i})=>a.jsxs("div",{className:X["control-panel"],children:[a.jsx("button",{onClick:()=>t(c=>Math.max(15,Math.ceil(c/1.25))),className:X["control-btn"],children:"Отдалить (–)"}),a.jsx("button",{onClick:()=>t(c=>Math.min(100,Math.ceil(c*1.25))),className:X["control-btn"],children:"Приблизить (+)"}),a.jsx("button",{onClick:i,className:X["control-btn"],children:"Сбросить"}),a.jsxs("div",{children:["Пикселей на мс: ",s.toFixed(2)," px/ms"]}),a.jsxs("div",{children:["Cколько мс: ",n.toFixed(1)," ms"]}),a.jsxs("div",{children:["Стартовая позиция в мс: ",o.toFixed(1)," ms"]})]}),le="_labels_m5mef_15",ae="_canvas_m5mef_79",W={"signal-tap-content":"_signal-tap-content_m5mef_3",labels:le,"signal-label":"_signal-label_m5mef_29","canvas-wrapper":"_canvas-wrapper_m5mef_79",canvas:ae,"view-type-change":"_view-type-change_m5mef_151"},re=({labelWidth:n,rowHeight:o,signals:s,containerRef:t,canvasRef:i})=>{const[c]=U(f=>[f.changeViewTypeForOffset],Z);return a.jsx("div",{className:W["signal-tap-content"],children:a.jsxs("div",{style:{display:"flex",gap:"20px"},children:[a.jsx("div",{style:{width:n},className:W.labels,children:s.map(f=>a.jsxs("div",{style:{height:o,lineHeight:`${o}px`},className:W["signal-label"],children:[a.jsx("div",{children:f.name??`Offset ${f.offset}`}),f.typeView!=="line"&&a.jsx("div",{onClick:()=>c(f.offset),className:W["view-type-change"],children:"изменить"})]},f.offset))}),a.jsx("div",{style:{width:"100%"},children:a.jsx("div",{ref:t,className:W["canvas-wrapper"],children:a.jsx("canvas",{ref:i,className:W.canvas})})})]})})},me="_slider_1mjjb_3",Q={"slider-container":"_slider-container_1mjjb_3",slider:me},fe=({minStartTime:n,maxScrollMs:o,scrollMs:s,setScrollMs:t})=>a.jsx("div",{className:Q["slider-container"],children:a.jsx("input",{type:"range",min:n,max:o,step:1,value:s,onChange:i=>t(Number(i.target.value)),className:Q.slider})}),de=({canvasRef:n,rowHeight:o,signals:s,recordsByOffset:t,scrollMs:i,pxPerMs:c,ySpacing:f})=>{const[x,R]=r.useState(null);return r.useEffect(()=>{const w=n.current;if(!w)return;const b=_=>{const j=w.getBoundingClientRect(),C=_.clientX-j.left,A=_.clientY-j.top;let O=!1;s.forEach((M,F)=>{const g=10+F*(o+f);t.get(M.offset).forEach(k=>{const Y=(k.time-i)*c,l=(k.endTime-i)*c,e=g,$=g+o;C>=Y&&C<=l&&A>=e&&A<=$&&(R({x:_.clientX,y:_.clientY,content:`offset: ${M.offset}
start: ${k.time} ms
end: ${k.endTime} ms
value: ${k.value}`}),O=!0)})}),O||R(null)},d=()=>R(null);return w.addEventListener("mousemove",b),w.addEventListener("mouseleave",d),()=>{w.removeEventListener("mousemove",b),w.removeEventListener("mouseleave",d)}},[s,c,i,o,f,t]),x&&a.jsx("div",{style:{position:"fixed",top:x.y+10,left:x.x+10,background:"rgba(0,0,0,0.8)",color:"white",padding:"4px 8px",borderRadius:"4px",fontSize:"12px",whiteSpace:"pre-line",pointerEvents:"none",zIndex:1e3},children:x.content})},ue=({signals:n,height:o=500,rowHeight:s=25,ySpacing:t=16,defaultDurationMs:i=1,initialPxPerMs:c=40,minBlockWidthPx:f=2,labelWidth:x=250})=>{const{canvasRef:R,containerRef:w,pxPerMs:b,scrollMs:d,setScrollMs:_,setPxPerMs:j,minStartTime:C,handleFitAll:A,maxScrollMs:O,viewDurationMs:M,recordsByOffset:F}=ce(c,n,s,o,t,i,f);return console.log(n),a.jsxs("div",{className:se["main-block"],children:[a.jsx(ie,{scrollMs:d,pxPerMs:b,setPxPerMs:j,handleFitAll:A,viewDurationMs:M}),a.jsx(re,{labelWidth:x,rowHeight:s,signals:n,containerRef:w,canvasRef:R}),a.jsx(fe,{minStartTime:C,maxScrollMs:O,scrollMs:d,setScrollMs:_}),a.jsx(de,{canvasRef:R,rowHeight:s,signals:n,recordsByOffset:F,scrollMs:d,pxPerMs:b,ySpacing:t})]})},xe={"offset-rows":"_offset-rows_nun66_1"},ye=({})=>{const[n]=U(s=>[s.oscillographicOffsetsFull,s.toggleSend],Z);console.log("вывод осцилографированных данных",n);const o=r.useMemo(()=>Object.entries(n).map(([s,t])=>({offset:Number(s),name:t.name,times:t.timePoints,values:t.values,dataType:t.dataType,typeView:t.typeView})),[n]);return a.jsxs("div",{className:xe["offset-rows"],style:{overflowX:"auto",maxWidth:"100%",padding:6},children:[o.length!==0&&a.jsx(ue,{signals:o}),o.length===0&&"Нет осцилографированных данных"]})};export{ye as default};
