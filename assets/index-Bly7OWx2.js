import{u as Q,a as U,r as q,b as Z,c as tt,g as et,d as A,j as t,P as $,e as b,F as st,L as nt,f as ot,h as at,R as ct,S as it,i as rt,B as dt,C as lt}from"./index-DSBvIpo4.js";import{g as pt,e as z,n as ut,u as gt,a as Ct,b as ft,s as e,C as xt,c as mt,G as yt,L as ht,d as Nt,f as jt,h as bt,i as Dt,p as kt}from"./index-D8XKJtyo.js";import{B as J}from"./Button-BQUXm3FT.js";import{M as Et}from"./index-D7eOBIdZ.js";import{s as w}from"./shallow-BHpKla55.js";import"./Input-CspveY7l.js";import"./validators-C1iEiny_.js";const Tt=()=>{const i=Q(o=>o.addNode,w),{screenToFlowPosition:C}=U();return{onDragOver:q.useCallback(o=>{o.preventDefault(),o.dataTransfer.dropEffect="move"},[]),onDrop:o=>{o.preventDefault();const l=o.dataTransfer.getData("application/reactflow"),p=C({x:o.clientX,y:o.clientY}),u=pt(l,p);u&&i(u)}}},W=()=>{const{nodes:i,edges:C,onNodesChange:x,onEdgesChange:m,addEdge:o,updateNodes:l,updateEdges:p,isDirty:u,setDirty:D,resetDirty:P}=Q(z,w),{nodes:I}=Z(z,w);q.useEffect(()=>{const s={discreteOutputConnect:"discreteInputConnect",analogOutputConnect:"analogInputConnect",analogOutputIntConnect:"analogInputIntConnect"},g=I.filter(n=>{const d=n.data.type==="discreteOutputConnect"||n.data.type==="analogOutputConnect"||n.data.type==="analogOutputIntConnect",a=!i.some(c=>c.id===n.id);return d&&a});if(g.length===0)return;const h=g.map(n=>{const d=s[n.data.type];return{...n,data:{...ut[d]}}});l([...i,...h])},[I,i]);const{onDragOver:R,onDrop:B}=Tt(),{getNodes:G,getEdges:V}=U(),{enqueueSnackbar:y}=tt();return{nodes:i,edges:C,onNodesChange:x,onEdgesChange:m,addEdge:o,onDragOver:R,onDrop:B,isValidConnection:s=>{var F,L,E,T;const g=G(),h=V(),n=s.source??"",d=s.target??"",a=s.sourceHandle,c=s.targetHandle,N=g.find(r=>r.id===n),f=g.find(r=>r.id===d);if(!N||!f||!a||!c)return!1;const O=((F=N.data.outputHandles[a==null?void 0:a.split(" ")[1]])==null?void 0:F.dataType)||((L=N.data.inputHandles[a==null?void 0:a.split(" ")[1]])==null?void 0:L.dataType),S=((E=f.data.inputHandles[c==null?void 0:c.split(" ")[1]])==null?void 0:E.dataType)||((T=f.data.outputHandles[c==null?void 0:c.split(" ")[1]])==null?void 0:T.dataType);if(O!==S)return!1;const k=(r,j=new Set)=>{if(j.has(r.id))return!1;j.add(r.id);for(const v of et(r,g,h))if(v.id===n||k(v,j))return!0;return!1};return n===d?!1:!k(f)},onConnectEnd:(s,g)=>{var E,T,r,j,v,X,Y,_;const{fromNode:h,fromHandle:n,toNode:d,toHandle:a,isValid:c}=g,N=M=>M==null?void 0:M.data;if(!h||!d||!(n!=null&&n.id)||!(a!=null&&a.id))return;const f=n.id.split(" ")[1],O=a.id.split(" ")[1],S=N(h),k=N(d),F=((T=(E=S.outputHandles)==null?void 0:E[f])==null?void 0:T.dataType)??((j=(r=S.inputHandles)==null?void 0:r[f])==null?void 0:j.dataType),L=((X=(v=k.inputHandles)==null?void 0:v[O])==null?void 0:X.dataType)??((_=(Y=k.outputHandles)==null?void 0:Y[O])==null?void 0:_.dataType);F!==L&&c===!1&&y("Нерроектное соединение",{variant:"error"})},updateEdges:p,updateNodes:l,isDirty:u,setDirty:D,resetDirty:P}},vt=()=>{const{nodes:i,isDirty:C,resetDirty:x}=W(),[m,o]=A(s=>[s.device,s.startFlexibleLogicNotifications],w),l=["analogInputConnect","analogInputIntConnect","discreteInputConnect","analogOutputConnect","analogOutputIntConnect","discreteOutputConnect"],p=q.useRef(null),{calculateConfig:u,sendResConfig:D}=gt(),{cut:P,copy:I,paste:R,bufferedNodes:B}=Ct(),{exportData:G,importData:V}=ft(),y=i.some(s=>s.selected&&!l.includes(s.data.type)),H=B.length>0,K=()=>{var s;(s=p.current)==null||s.click()};return t.jsxs(t.Fragment,{children:[t.jsxs($,{position:"top-center",className:e["action-panel"],children:[t.jsxs("div",{className:e["icon-block"],"data-tooltip":"импорт",children:[t.jsx(xt,{className:b(e["action-icon"],e.ie),onClick:K}),t.jsx("input",{ref:p,type:"file",onChange:V,accept:".txt",hidden:!0})]}),t.jsx("div",{className:e["icon-block"],"data-tooltip":"экспорт",onClick:G,children:t.jsx(mt,{className:b(e["action-icon"],e.ie)})}),t.jsx("div",{className:e["icon-block"],"data-tooltip":"вырезать",children:t.jsx(Et,{className:b(e["action-icon"],{[e.disabled]:!y}),onClick:()=>y&&P()})}),t.jsx("div",{className:e["icon-block"],"data-tooltip":"копировать",children:t.jsx(st,{className:b(e["action-icon"],{[e.disabled]:!y}),onClick:()=>y&&I()})}),t.jsx("div",{className:e["icon-block"],"data-tooltip":"вставить",children:t.jsx(nt,{className:b(e["action-icon"],{[e.disabled]:!H}),onClick:()=>H&&R()})}),t.jsx("div",{className:e["icon-block"],"data-tooltip":"считать гибкую логику",children:t.jsx(yt,{className:b(e["action-icon"],{[e.disabled]:!m}),onClick:()=>{ot.getState().reset(),o(at),x()}})}),t.jsx(J,{text:"Рассчитать",type:"button",onClick:()=>{u()}}),t.jsx(J,{text:"отправить",type:"button",onClick:()=>D(),disabled:!A.getState().device,className:A.getState().device?"":e["button-tooltip"],"data-tooltip":"необходимо подключиться к устройству"}),C&&t.jsx("div",{children:"Есть изменения"})]}),t.jsx($,{position:"top-right",children:t.jsx(ht,{})})]})},It=()=>{const{nodes:i,edges:C,onNodesChange:x,onEdgesChange:m,onDragOver:o,onDrop:l,isValidConnection:p,onConnectEnd:u,addEdge:D}=W();return t.jsx("div",{className:Nt["graph-editor"],children:t.jsxs(rt,{deleteKeyCode:null,proOptions:kt,nodeTypes:Dt,edgeTypes:bt,nodes:i,edges:C,onNodesChange:x,onEdgesChange:m,onConnect:D,onDragOver:o,onDrop:l,connectionLineComponent:jt,isValidConnection:p,onConnectEnd:u,fitView:!0,children:[t.jsx(vt,{}),t.jsx(dt,{}),t.jsx(lt,{})]})})},Ot=()=>t.jsx(ct,{children:t.jsx(it,{maxSnack:3,children:t.jsx(It,{})})}),Gt=()=>t.jsx(Ot,{});export{Gt as default};
