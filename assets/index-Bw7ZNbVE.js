import{r as c,j as n}from"./index-CguW7_3c.js";import{u as q}from"./store-3z_WcEi-.js";import{s as G}from"./shallow-YUsIgd3F.js";function J(s,a,o){const d=[];for(let f=0;f<s.times.length;f++){const p=s.times[f],S=f<s.times.length-1?s.times[f+1]:o,k=Math.max(p+a,S);d.push({time:p,endTime:k,value:s.values[f],dataType:s.dataType})}return d}function K(s,a=8){if(s<=0)return 1;const o=s/a,d=Math.pow(10,Math.floor(Math.log10(o))),f=[1,2,5].map(p=>p*d);for(const p of f)if(o<=p)return p;return 10*d}const Q=({signals:s,height:a=500,rowHeight:o=20,ySpacing:d=16,defaultDurationMs:f=1,initialPxPerMs:p=20,minBlockWidthPx:S=2,labelWidth:k=140})=>{const W=c.useRef(null),R=c.useRef(null),N=c.useRef(null),[r,E]=c.useState(p),[i,M]=c.useState(0),[x,X]=c.useState(1e3);c.useEffect(()=>{const t=R.current;if(!t)return;const e=()=>X(t.clientWidth);e();const l=new ResizeObserver(e);return l.observe(t),()=>l.disconnect()},[]);const j=c.useMemo(()=>s.reduce((t,e)=>{const l=e.times[e.times.length-1]??0;return Math.max(t,l+f)},0),[s,f]),u=x/r,h=Math.max(0,j-u);c.useEffect(()=>{i>h&&M(h)},[h,i]);const z=c.useMemo(()=>{const t=new Map;for(const e of s)t.set(e.offset,J(e,f,j));return t},[s,f,j]);c.useEffect(()=>{const t=W.current;if(!t)return;const e=t.getContext("2d");if(!e)return;const l=window.devicePixelRatio||1;t.width=x*l,t.height=a*l,e.setTransform(l,0,0,l,0,0),e.clearRect(0,0,x,a);const w=i,C=i+u;s.forEach((y,P)=>{const m=10+P*(o+d),F=z.get(y.offset);F.forEach((v,V)=>{if(v.endTime<w||v.time>C)return;const T=(v.time-w)*r,g=(v.endTime-w)*r,L=Math.max(S,g-T);if(y.dataType==="bool"){const b=m+o,B=m,O=v.value===1?B:b;e.beginPath(),e.moveTo(T,O),e.lineTo(g,O),e.strokeStyle="#2b6cb0",e.lineWidth=2,e.stroke();const A=F[V+1];if(A&&A.value!==v.value){const Y=A.value===1?B:b;e.beginPath(),e.moveTo(g,O),e.lineTo(g,Y),e.stroke()}}else{const b=Math.min(5,Math.max(.5,L/2-.5));e.beginPath(),e.moveTo(T+b,m),e.lineTo(g-b,m),e.lineTo(g,m+o/2),e.lineTo(g-b,m+o),e.lineTo(T+b,m+o),e.lineTo(T,m+o/2),e.closePath(),e.fillStyle="#90cdf4",e.strokeStyle="#2b6cb0",e.fill(),e.stroke(),String(v.value).length*7<L&&(e.fillStyle="#000",e.font="11px sans-serif",e.textAlign="center",e.textBaseline="middle",e.fillText(String(v.value),T+L/2,m+o/2))}})})},[r,i,s,z,a,o,d,S,x,u,j]),c.useEffect(()=>{const t=R.current;if(!t)return;const e=()=>{const l=t.scrollLeft/r;Math.abs(l-i)>.1&&M(Math.min(h,Math.max(0,l)))};return t.addEventListener("scroll",e,{passive:!0}),()=>t.removeEventListener("scroll",e)},[r,h,i]),c.useEffect(()=>{const t=R.current;if(!t)return;const e=i*r;Math.abs(t.scrollLeft-e)>1&&(t.scrollLeft=e)},[i,r]);const $=()=>{M(t=>Math.max(0,t-u*.2))},_=()=>{M(t=>Math.min(h,t+u*.2))},I=()=>{if(j<=0)return;const t=x/j;E(Math.max(2,Math.min(1e3,t))),M(0)},Z=c.useMemo(()=>{const t=i,e=i+u,l=K(u,8),w=Math.floor(t/l)*l,C=[];for(let y=w;y<=e+l/2;y+=l){const P=(y-t)*r;C.push({time:y,x:P})}return C},[i,u,r]);return n.jsxs("div",{style:{fontFamily:"sans-serif",display:"flex",flexDirection:"column"},children:[n.jsxs("div",{style:{display:"flex",gap:8,marginBottom:12,flexWrap:"wrap",alignItems:"center"},children:[n.jsx("button",{onClick:()=>E(t=>Math.max(2,t/1.25)),style:{padding:"6px 12px"},children:"Zoom Out (–)"}),n.jsx("button",{onClick:()=>E(t=>Math.min(1e3,t*1.25)),style:{padding:"6px 12px"},children:"Zoom In (+)"}),n.jsx("button",{onClick:I,style:{padding:"6px 12px"},children:"Fit All"}),n.jsxs("div",{children:["Scale: ",r.toFixed(2)," px/ms"]}),n.jsxs("div",{children:["View: ",u.toFixed(1)," ms"]}),n.jsxs("div",{children:["Pos: ",i.toFixed(1)," ms"]})]}),n.jsx("div",{style:{display:"flex",flexDirection:"column",border:"1px solid #ddd",borderRadius:4},children:n.jsxs("div",{style:{display:"flex"},children:[n.jsx("div",{style:{width:k,backgroundColor:"#fafafa",borderRight:"1px solid #eee",display:"flex",flexDirection:"column",justifyContent:"flex-start",paddingTop:10,gap:"16px"},children:s.map(t=>n.jsx("div",{style:{height:o,lineHeight:`${o}px`,textAlign:"right",paddingRight:8,color:"#444",fontSize:"12px",fontWeight:"normal",whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:t.name??`Offset ${t.offset}`},t.offset))}),n.jsxs("div",{style:{width:"100%"},children:[n.jsx("div",{style:{width:"100%",overflow:"hidden",height:30,backgroundColor:"#fafafa",borderBottom:"1px solid #eee",position:"relative",paddingLeft:k},ref:N,children:Z.map(t=>n.jsxs("div",{style:{position:"absolute",left:t.x,top:0,transform:"translateX(-50%)",textAlign:"center",fontSize:"11px",color:"#555",whiteSpace:"nowrap"},children:[n.jsx("div",{style:{position:"absolute",bottom:-8,left:"50%",transform:"translateX(-50%)",width:1,height:8,backgroundColor:"#ccc"}}),t.time," ms"]},t.time))}),n.jsx("div",{ref:R,style:{flex:1,overflowX:"auto",overflowY:"hidden",height:a,position:"relative",backgroundColor:"#fff"},children:n.jsx("canvas",{ref:W,style:{display:"block",height:a,width:"100%"}})})]})]})}),n.jsx("div",{style:{marginTop:12},children:n.jsx("input",{type:"range",min:0,max:x,step:1,value:i*r,onChange:t=>M(Number(t.target.value)/r),style:{width:"100%",height:12,borderRadius:6,background:`linear-gradient(to right, #3182ce 0%, #3182ce ${x>0?i*r/x*100:0}%, #e2e8f0 ${x>0?i*r/x*100:0}%, #e2e8f0 100%)`,outline:"none",WebkitAppearance:"none",appearance:"none",cursor:"pointer"}})}),n.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginTop:8},children:[n.jsx("button",{onClick:$,disabled:i<=0,style:{padding:"4px 16px",opacity:i<=0?.5:1},children:"◀◀"}),n.jsx("button",{onClick:_,disabled:i>=h,style:{padding:"4px 16px",opacity:i>=h?.5:1},children:"▶▶"})]})]})},U={"offset-rows":"_offset-rows_nun66_1"},te=({})=>{const[s]=q(o=>[o.oscillographicOffsets,o.toggleSend],G),a=c.useMemo(()=>Object.entries(s).map(([o,d])=>({offset:Number(o),name:d.name,times:d.timePoints,values:d.values,dataType:d.dataType})),[s]);return n.jsxs("div",{className:U["offset-rows"],style:{overflowX:"auto",maxWidth:"100%",padding:6},children:[a.length!==0&&n.jsx(Q,{signals:a}),a.length===0&&"Нет осцилографированных данных"]})};export{te as default};
