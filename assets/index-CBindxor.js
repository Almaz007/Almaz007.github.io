import{u as Q,a as U,r as q,b as Z,g as tt,c as A,j as t,P as $,d as b,F as et,L as ot,R as st,i as nt,B as at,C as it}from"./index-CrREYRkc.js";import{g as ct,e as z,n as rt,u as dt,a as lt,b as pt,c as ut,s as e,C as gt,d as Ct,G as ft,f as xt,h as mt,L as yt,S as ht,i as jt,j as Nt,k as bt,l as Dt,p as kt}from"./getFlexLogicData-o3l-hjAT.js";import{B as J}from"./Button-C6bKAtMY.js";import{M as Et}from"./index-CpuWGWuR.js";import{s as w}from"./shallow-BHpKla55.js";import"./store-BUSY_6ZW.js";import"./store-CwyoiMnS.js";import"./store-CG8v_uPG.js";import"./store-Du-GoxsD.js";import"./pako.esm-B2G-gnns.js";import"./Input-i71ZKPRw.js";import"./types-CM2LPTMF.js";const Tt=()=>{const c=Q(n=>n.addNode,w),{screenToFlowPosition:C}=U();return{onDragOver:q.useCallback(n=>{n.preventDefault(),n.dataTransfer.dropEffect="move"},[]),onDrop:n=>{n.preventDefault();const l=n.dataTransfer.getData("application/reactflow"),p=C({x:n.clientX,y:n.clientY}),u=ct(l,p);u&&c(u)}}},W=()=>{const{nodes:c,edges:C,onNodesChange:x,onEdgesChange:m,addEdge:n,updateNodes:l,updateEdges:p,isDirty:u,setDirty:D,resetDirty:P}=Q(z,w),{nodes:I}=Z(z,w);q.useEffect(()=>{const o={discreteOutputConnect:"discreteInputConnect",analogOutputConnect:"analogInputConnect",analogOutputIntConnect:"analogInputIntConnect"},g=I.filter(s=>{const d=s.data.type==="discreteOutputConnect"||s.data.type==="analogOutputConnect"||s.data.type==="analogOutputIntConnect",a=!c.some(i=>i.id===s.id);return d&&a});if(g.length===0)return;const h=g.map(s=>{const d=o[s.data.type];return{...s,data:{...rt[d]}}});l([...c,...h])},[I,c]);const{onDragOver:R,onDrop:B}=Tt(),{getNodes:G,getEdges:V}=U(),{enqueueSnackbar:y}=dt();return{nodes:c,edges:C,onNodesChange:x,onEdgesChange:m,addEdge:n,onDragOver:R,onDrop:B,isValidConnection:o=>{var F,L,E,T;const g=G(),h=V(),s=o.source??"",d=o.target??"",a=o.sourceHandle,i=o.targetHandle,j=g.find(r=>r.id===s),f=g.find(r=>r.id===d);if(!j||!f||!a||!i)return!1;const O=((F=j.data.outputHandles[a==null?void 0:a.split(" ")[1]])==null?void 0:F.dataType)||((L=j.data.inputHandles[a==null?void 0:a.split(" ")[1]])==null?void 0:L.dataType),S=((E=f.data.inputHandles[i==null?void 0:i.split(" ")[1]])==null?void 0:E.dataType)||((T=f.data.outputHandles[i==null?void 0:i.split(" ")[1]])==null?void 0:T.dataType);if(O!==S)return!1;const k=(r,N=new Set)=>{if(N.has(r.id))return!1;N.add(r.id);for(const v of tt(r,g,h))if(v.id===s||k(v,N))return!0;return!1};return s===d?!1:!k(f)},onConnectEnd:(o,g)=>{var E,T,r,N,v,X,Y,_;const{fromNode:h,fromHandle:s,toNode:d,toHandle:a,isValid:i}=g,j=M=>M==null?void 0:M.data;if(!h||!d||!(s!=null&&s.id)||!(a!=null&&a.id))return;const f=s.id.split(" ")[1],O=a.id.split(" ")[1],S=j(h),k=j(d),F=((T=(E=S.outputHandles)==null?void 0:E[f])==null?void 0:T.dataType)??((N=(r=S.inputHandles)==null?void 0:r[f])==null?void 0:N.dataType),L=((X=(v=k.inputHandles)==null?void 0:v[O])==null?void 0:X.dataType)??((_=(Y=k.outputHandles)==null?void 0:Y[O])==null?void 0:_.dataType);F!==L&&i===!1&&y("Нерроектное соединение",{variant:"error"})},updateEdges:p,updateNodes:l,isDirty:u,setDirty:D,resetDirty:P}},vt=()=>{const{nodes:c,isDirty:C,resetDirty:x}=W(),[m,n]=A(o=>[o.device,o.startFlexibleLogicNotifications],w),l=["analogInputConnect","analogInputIntConnect","discreteInputConnect","analogOutputConnect","analogOutputIntConnect","discreteOutputConnect"],p=q.useRef(null),{calculateConfig:u,sendResConfig:D}=lt(),{cut:P,copy:I,paste:R,bufferedNodes:B}=pt(),{exportData:G,importData:V}=ut(),y=c.some(o=>o.selected&&!l.includes(o.data.type)),H=B.length>0,K=()=>{var o;(o=p.current)==null||o.click()};return t.jsxs(t.Fragment,{children:[t.jsxs($,{position:"top-center",className:e["action-panel"],children:[t.jsxs("div",{className:e["icon-block"],"data-tooltip":"импорт",children:[t.jsx(gt,{className:b(e["action-icon"],e.ie),onClick:K}),t.jsx("input",{ref:p,type:"file",onChange:V,accept:".txt",hidden:!0})]}),t.jsx("div",{className:e["icon-block"],"data-tooltip":"экспорт",onClick:G,children:t.jsx(Ct,{className:b(e["action-icon"],e.ie)})}),t.jsx("div",{className:e["icon-block"],"data-tooltip":"вырезать",children:t.jsx(Et,{className:b(e["action-icon"],{[e.disabled]:!y}),onClick:()=>y&&P()})}),t.jsx("div",{className:e["icon-block"],"data-tooltip":"копировать",children:t.jsx(et,{className:b(e["action-icon"],{[e.disabled]:!y}),onClick:()=>y&&I()})}),t.jsx("div",{className:e["icon-block"],"data-tooltip":"вставить",children:t.jsx(ot,{className:b(e["action-icon"],{[e.disabled]:!H}),onClick:()=>H&&R()})}),t.jsx("div",{className:e["icon-block"],"data-tooltip":"считать гибкую логику",children:t.jsx(ft,{className:b(e["action-icon"],{[e.disabled]:!m}),onClick:()=>{xt.getState().reset(),n(mt),x()}})}),t.jsx(J,{text:"Рассчитать",type:"button",onClick:()=>{u()}}),t.jsx(J,{text:"отправить",type:"button",onClick:()=>D(),disabled:!A.getState().device,className:A.getState().device?"":e["button-tooltip"],"data-tooltip":"необходимо подключиться к устройству"}),C&&t.jsx("div",{children:"Есть изменения"})]}),t.jsx($,{position:"top-right",children:t.jsx(yt,{})})]})},It=()=>{const{nodes:c,edges:C,onNodesChange:x,onEdgesChange:m,onDragOver:n,onDrop:l,isValidConnection:p,onConnectEnd:u,addEdge:D}=W();return t.jsx("div",{className:jt["graph-editor"],children:t.jsxs(nt,{deleteKeyCode:null,proOptions:kt,nodeTypes:Dt,edgeTypes:bt,nodes:c,edges:C,onNodesChange:x,onEdgesChange:m,onConnect:D,onDragOver:n,onDrop:l,connectionLineComponent:Nt,isValidConnection:p,onConnectEnd:u,fitView:!0,children:[t.jsx(vt,{}),t.jsx(at,{}),t.jsx(it,{})]})})},Ot=()=>t.jsx(st,{children:t.jsx(ht,{maxSnack:3,children:t.jsx(It,{})})}),qt=()=>t.jsx(Ot,{});export{qt as default};
