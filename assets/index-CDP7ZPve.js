import{r as _,j as e,c as y}from"./index-Car71Rau.js";import{u as v}from"./store-C1FDmUnI.js";import{c as D,s as j}from"./shallow-DU2pzESy.js";import{B as z}from"./Button-BRve0vAp.js";import{u as N}from"./store-CjQxIEZL.js";import{u as C}from"./store-BqkF-msJ.js";import"./helpers-fab74NUc.js";const k="_wrapper_zxo5y_1",F="_form_zxo5y_17",B="_drag_zxo5y_29",E="_label_zxo5y_43",A="_input_zxo5y_49",T="_info_zxo5y_93",U="_btns_zxo5y_103",d={wrapper:k,form:F,drag:B,"action-title":"_action-title_zxo5y_35",label:E,input:A,"file-list":"_file-list_zxo5y_63","download-label":"_download-label_zxo5y_73",info:T,btns:U,"button-reset":"_button-reset_zxo5y_111","button-submit":"_button-submit_zxo5y_113","dnd-tile":"_dnd-tile_zxo5y_135"},S=({handleSubmit:a,title:f})=>{const[o,n]=_.useState([]),[r,l]=_.useState(!1),u=t=>{t.preventDefault(),t.target.files&&t.target.files[0]&&n([t.target.files[0]])},g=()=>{n([])},i=function(t){t.preventDefault(),l(!0)},h=function(t){t.preventDefault(),l(!1)},x=function(t){var s;t.preventDefault(),l(!1),(s=t.dataTransfer)!=null&&s.files&&t.dataTransfer.files[0]&&n([t.dataTransfer.files[0]])};return e.jsxs("div",{className:y(d.wrapper,{[d.drag]:r}),children:[e.jsx("h2",{className:d["dnd-tile"],children:f}),e.jsxs("form",{className:y(d.form),onReset:g,onDragEnter:i,onDragOver:i,onDragLeave:h,onDrop:x,children:[e.jsx("h2",{className:d["action-title"],children:"Перетащите файлы сюда"}),e.jsx("p",{children:"или"}),e.jsxs("label",{className:d.label,children:[e.jsx("span",{className:d["download-label"],children:"Загрузите файл"}),e.jsx("input",{className:d.input,type:"file",multiple:!1,onChange:u})]}),o.length>0&&e.jsxs("div",{className:d.info,children:[e.jsx("ul",{className:d["file-list"],children:e.jsx("li",{children:o[0].name})}),e.jsxs("div",{className:d.btns,children:[e.jsx("button",{className:d["button-reset"],type:"reset",children:"Отменить"}),e.jsx("button",{className:d["button-submit"],onClick:t=>a(t,o),children:"Отправить"})]})]})]})]})},W=D((a,f)=>({ws:null,status:"disconnected",error:null,messages:[],parseOscilografFile:async o=>{const n=await o.arrayBuffer(),r=new DataView(n);console.log(n);const l={};for(let i=0;i+16<=r.byteLength;i+=16){const h=r.getUint32(i,!0);if(h===0)return;const x=r.getUint32(i+4,!0),t=r.getUint32(i+8,!0),s=r.getUint32(i+12,!0);console.log(`номер: ${h}, метка: ${x}, смещение: ${t}, значение: ${s}`),l[t]||(l[t]={timePoints:[],values:[]}),l[t].timePoints.push(x),l[t].values.push(s)}const u=v.getState(),g=r.byteLength===1216;u.updateOscillographicData(l,g)},connect:o=>{let{ws:n,parseOscilografFile:r,status:l}=f();n||(a({status:"connecting",error:null}),n=new WebSocket(o),a({ws:n}),n.onopen=()=>{a({error:null,status:"connected"}),console.log("WebSocket connected")},n.onmessage=async u=>{u.data instanceof Blob?(a(g=>({messages:[...g.messages,"Получен бинарный пакет"]})),await r(u.data)):(console.log("Получено с сервера:",u.data),a(g=>({messages:[...g.messages,u.data.toString()]})))},n.onerror=()=>{a({error:"Connection error",status:"disconnected"})},n.onclose=()=>{console.log("WebSocket closed. Status was:",l),n=null,a({ws:null})})},disconnect:()=>{const{ws:o}=f();o&&(o.close(),a({ws:null,status:"disconnected"}))},sendMessage:o=>{const{ws:n}=f();n&&(a(r=>({messages:[...r.messages,o]})),n.send(o))},sendFile:o=>{const{ws:n}=f();n&&(a(r=>({messages:[...r.messages,"Файл отправлен"]})),n.send(o))},sendConfig:o=>{const{ws:n}=f();n&&(a(r=>({messages:[...r.messages,"Конфиг отправлен"]})),n.send(o))}})),$="_row_q0ihq_1",L={row:$},Y=()=>{const a=C(s=>s.sendFirmware),[f,o,n,r,l,u,g]=W(s=>[s.status,s.error,s.messages,s.connect,s.disconnect,s.sendConfig,s.sendFile],j),i=N(s=>s.config,j),h=()=>{const s=new TextEncoder().encode(JSON.stringify(i));if(s.length===0){console.log("конфиг не отправлен");return}const c=new TextEncoder().encode("flexibleLogic,"),m=new Uint8Array(c.length+s.length);m.set(c,0),m.set(s,c.length),u(m)},x=async(s,c)=>{if(s.preventDefault(),!c||c.length===0)return;const m=await c[0].arrayBuffer(),w=new Uint8Array(m),p=new TextEncoder().encode("firmware,"),b=new Uint8Array(p.length+w.length);b.set(p,0),b.set(w,p.length),g(b)},t=async(s,c)=>{if(s.preventDefault(),!c||c.length===0)return;const m=await c[0].arrayBuffer();a(m)};return e.jsxs("div",{children:[e.jsx("h2",{children:"WebSocket"}),e.jsxs("p",{children:["Status: ",f," ",o&&`| Error: ${o}`]}),e.jsx("button",{onClick:()=>r("wss://int-rt.ru:3010"),children:"Подключить"}),e.jsx("br",{}),e.jsx("button",{onClick:l,children:"Отключить"}),e.jsx("div",{style:{height:"300px",overflowY:"auto",border:"1px solid blue",padding:"10px",marginTop:"10px"},children:n.map((s,c)=>e.jsx("p",{children:s},c))}),e.jsx("br",{}),e.jsxs("div",{className:L.row,children:[e.jsx(S,{handleSubmit:x,title:"Отправка прошивки по web-socket"}),e.jsx(S,{handleSubmit:t,title:"Отправка прошивки по ble"}),e.jsxs("div",{children:[e.jsx(z,{disabled:!i.scripts.length,onClick:h,text:"загрузить гибкую логику"}),e.jsx("br",{}),!i.scripts.length&&e.jsx("div",{children:"необходимо сформировать гибкую логику"})]})]})]})};export{Y as default};
