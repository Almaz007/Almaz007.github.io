import{r as m,j as l,n as Z}from"./index-Cbj21JmJ.js";import{s as K}from"./shallow-BHpKla55.js";function te(n,i,t){const s=[];for(let o=0;o<n.times.length;o++){const c=n.times[o],f=o<n.times.length-1?n.times[o+1]:t,r=Math.max(c+i,f);s.push({time:c,endTime:r,value:n.values[o],dataType:n.dataType,typeView:n.typeView})}return s}function ne(n,i=8){if(n<=0)return 1;const t=n/i,s=Math.pow(10,Math.floor(Math.log10(t))),o=[1,2,5].map(c=>c*s);for(const c of o)if(t<=c)return c;return 10*s}const se={"main-block":"_main-block_4w5ja_3"},oe=()=>{const n=m.useRef(null),[i,t]=m.useState(1e3);return m.useEffect(()=>{const s=n.current;if(!s)return;const o=()=>t(s.clientWidth);o();const c=new ResizeObserver(o);return c.observe(s),()=>c.disconnect()},[]),{containerWidth:i,containerRef:n}},Q=1e-6,ce=(n,i,t,s,o,c=1,f)=>{const{containerWidth:r,containerRef:F}=oe(),_=m.useRef(null),T=m.useRef(null),[u,g]=m.useState(()=>Math.max(Q,n)),[S,$]=m.useState(0),[O,A]=m.useState(0);m.useEffect(()=>{g(a=>a===n?a:n)},[n]),m.useEffect(()=>{const a=()=>A(e=>e+1);return window.addEventListener("resize",a),window.addEventListener("orientationchange",a),()=>{window.removeEventListener("resize",a),window.removeEventListener("orientationchange",a)}},[]);const M=m.useMemo(()=>i.reduce((a,e)=>{const V=e.times[e.times.length-1]??0;return Math.max(a,V+c)},0),[i,c]),R=m.useMemo(()=>{const a=i.map(e=>e.times[0]).filter(e=>typeof e=="number");return a.length?Math.min(...a):0},[i]),E=u>Q?r/u:1/0,B=m.useMemo(()=>Math.ceil(Math.max(0,M-E)),[M,E]);m.useEffect(()=>{$(a=>Math.min(B,Math.max(R,a)))},[B,R]);const L=m.useMemo(()=>{const a=new Map;for(const e of i)a.set(e.offset,te(e,c,M));return a},[i,c,M]);m.useEffect(()=>{const a=_.current;if(!a)return;const e=a.getContext("2d");if(!e)return;const V=window.devicePixelRatio||1;a.style.width=`${r}px`,a.style.height=`${s}px`,a.width=Math.max(1,Math.round(r*V)),a.height=Math.max(1,Math.round(s*V)),e.setTransform(V,0,0,V,0,0),e.clearRect(0,0,r,s);const y=S,W=Number.isFinite(E)&&E>0?S+E:S+1,P=ne(W-y,8);if(!(P>0))return;const D=()=>{e.clearRect(0,0,r,s),i.forEach((k,w)=>{const p=10+w*(t+o),h=t+o;w%2===0?e.fillStyle="#f9fafb":e.fillStyle="#f3f4f6",e.fillRect(0,p-5,r,h)});const H=Math.floor(y/P)*P;e.strokeStyle="#e5e7eb",e.fillStyle="#333",e.font="12px sans-serif",e.textAlign="center",e.textBaseline="top";for(let k=H;k<W;k+=P){const w=(k-y)*u;e.beginPath(),e.moveTo(w,0),e.lineTo(w,s-20),e.stroke(),e.fillText(`${k} ms`,w,s-18)}i.forEach((k,w)=>{if(w>0){const p=10+w*(t+o)-o/2;e.strokeStyle="#616161ff",e.lineWidth=1,e.beginPath(),e.moveTo(0,p),e.lineTo(r,p),e.stroke()}}),i.forEach((k,w)=>{const p=10+w*(t+o),h=L.get(k.offset);if(!(!h||h.length===0))if(k.typeView==="line"){e.lineWidth=2,e.strokeStyle="#2b6cb0";for(let v=0;v<h.length;v++){const x=h[v];if(x.endTime<y||x.time>W)continue;const b=(x.time-y)*u,d=(x.endTime-y)*u,N=p,C=p+t,z=x.value===1?N:C;e.beginPath(),e.moveTo(b,z),e.lineTo(d,z),e.stroke();const j=h[v+1];if(j&&j.value!==x.value){const q=j.value===1?N:C;e.beginPath(),e.moveTo(d,z),e.lineTo(d,q),e.stroke()}}}else if(k.typeView==="point"){if(h.length<2)return;const v=h.findIndex(j=>j.time>=y),x=h.findIndex(j=>j.time>W);let b=[];if(v===-1&&x===-1?b=h.slice(Math.max(0,h.length-2)):v===-1?b=h.slice(0,x+1):x===-1?b=h.slice(Math.max(0,v-1)):b=h.slice(Math.max(0,v-1),x+1),b.length<2)return;const d=[...b];d[0].time>y&&d.unshift({...d[0],time:y}),d[d.length-1].time<W&&d.push({...d[d.length-1],time:W});const N=d.map(j=>Number(j.value||0)),C=Math.min(...N),z=Math.max(...N);e.beginPath(),e.strokeStyle="#2b6cb0",e.lineWidth=2,d.forEach((j,q)=>{const G=(j.time-y)*u,ee=z===C?.5:(Number(j.value)-C)/(z-C),J=p+t-ee*t;q===0?e.moveTo(G,J):e.lineTo(G,J)}),e.stroke()}else h.forEach(v=>{if(v.endTime<y||v.time>W)return;const x=(v.time-y)*u,b=(v.endTime-y)*u,d=Math.max(f,b-x),N=Math.min(5,Math.max(.5,d/2-.5));e.beginPath(),e.moveTo(x+N,p),e.lineTo(b-N,p),e.lineTo(b,p+t/2),e.lineTo(b-N,p+t),e.lineTo(x+N,p+t),e.lineTo(x,p+t/2),e.closePath(),e.fillStyle="#90cdf4",e.strokeStyle="#2b6cb0",e.fill(),e.stroke();const C=String(v.value);e.font="13px sans-serif",e.measureText(C).width+6<d&&(e.fillStyle="#000",e.textAlign="center",e.textBaseline="middle",e.fillText(C,x+d/2,p+t/2))})})};return T.current&&cancelAnimationFrame(T.current),T.current=requestAnimationFrame(D),()=>{T.current&&cancelAnimationFrame(T.current),T.current=null}},[u,S,L,s,t,o,r,f,O,E,i]);const Y=m.useCallback(()=>{M<=0||(g(20),$(()=>Math.min(B,R)))},[r,M,B,R]);return{canvasRef:_,pxPerMs:u,scrollMs:S,setScrollMs:$,setPxPerMs:g,maxEndTime:M,maxScrollMs:B,minStartTime:R,containerRef:F,handleFitAll:Y,viewDurationMs:E,recordsByOffset:L}},X={"control-panel":"_control-panel_c31wo_3","control-btn":"_control-btn_c31wo_29"},ie=({viewDurationMs:n,scrollMs:i,pxPerMs:t,setPxPerMs:s,handleFitAll:o})=>l.jsxs("div",{className:X["control-panel"],children:[l.jsx("button",{onClick:()=>s(c=>Math.max(4,Math.ceil(c/1.25))),className:X["control-btn"],children:"Отдалить (–)"}),l.jsx("button",{onClick:()=>s(c=>Math.min(100,Math.ceil(c*1.25))),className:X["control-btn"],children:"Приблизить (+)"}),l.jsx("button",{onClick:o,className:X["control-btn"],children:"Сбросить"}),l.jsxs("div",{children:["Пикселей на мс: ",t.toFixed(2)," пикселей/мс"]}),l.jsxs("div",{children:["Cколько мс: ",n.toFixed(1)," мс"]}),l.jsxs("div",{children:["Стартовая позиция в мс: ",i.toFixed(1)," мс"]})]}),le="_labels_m5mef_15",ae="_canvas_m5mef_79",I={"signal-tap-content":"_signal-tap-content_m5mef_3",labels:le,"signal-label":"_signal-label_m5mef_29","canvas-wrapper":"_canvas-wrapper_m5mef_79",canvas:ae,"view-type-change":"_view-type-change_m5mef_151"},re=({labelWidth:n,rowHeight:i,signals:t,containerRef:s,canvasRef:o})=>{const[c]=Z(f=>[f.changeViewTypeForMacOffset],K);return l.jsx("div",{className:I["signal-tap-content"],children:l.jsxs("div",{style:{display:"flex",gap:"20px"},children:[l.jsx("div",{style:{width:n},className:I.labels,children:t.map((f,r)=>l.jsxs("div",{style:{height:i,lineHeight:`${i}px`,borderLeft:"4px solid #2b6cb0",paddingLeft:"8px",background:r%2===0?"#f9fafb":"#f3f4f6"},className:I["signal-label"],children:[l.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px",fontWeight:500},children:[l.jsx("span",{children:f.name??`Offset ${f.offset}`}),l.jsx("span",{style:{fontSize:"10px",color:"#9ca3af",textTransform:"uppercase",letterSpacing:"0.5px",marginLeft:"4px"},children:f.dataType})]}),f.typeView!=="line"&&l.jsx("div",{onClick:()=>c(f.mac,f.offset),className:I["view-type-change"],children:"изменить"})]},f.offset))}),l.jsx("div",{style:{width:"100%"},children:l.jsx("div",{ref:s,className:I["canvas-wrapper"],children:l.jsx("canvas",{ref:o,className:I.canvas})})})]})})},me="_slider_1mjjb_3",U={"slider-container":"_slider-container_1mjjb_3",slider:me},fe=({minStartTime:n,maxScrollMs:i,scrollMs:t,setScrollMs:s})=>l.jsx("div",{className:U["slider-container"],children:l.jsx("input",{type:"range",min:n,max:i,step:1,value:t,onChange:o=>s(Number(o.target.value)),className:U.slider})}),de=({canvasRef:n,rowHeight:i,signals:t,recordsByOffset:s,scrollMs:o,pxPerMs:c,ySpacing:f})=>{const[r,F]=m.useState(null);return m.useEffect(()=>{const _=n.current;if(!_)return;const T=g=>{const S=_.getBoundingClientRect(),$=g.clientX-S.left,O=g.clientY-S.top;let A=!1;t.forEach((M,R)=>{const E=10+R*(i+f);s.get(M.offset).forEach(L=>{const Y=(L.time-o)*c,a=(L.endTime-o)*c,e=E,V=E+i;$>=Y&&$<=a&&O>=e&&O<=V&&(F({x:g.clientX,y:g.clientY,content:`offset: ${M.offset}
start: ${L.time} ms
end: ${L.endTime} ms
value: ${L.value}`}),A=!0)})}),A||F(null)},u=()=>F(null);return _.addEventListener("mousemove",T),_.addEventListener("mouseleave",u),()=>{_.removeEventListener("mousemove",T),_.removeEventListener("mouseleave",u)}},[t,c,o,i,f,s]),r&&l.jsx("div",{style:{position:"fixed",top:r.y+10,left:r.x+10,background:"rgba(0,0,0,0.8)",color:"white",padding:"4px 8px",borderRadius:"4px",fontSize:"12px",whiteSpace:"pre-line",pointerEvents:"none",zIndex:1e3},children:r.content})},ue=({signals:n,height:i=500,rowHeight:t=25,ySpacing:s=16,defaultDurationMs:o=1,initialPxPerMs:c=40,minBlockWidthPx:f=2,labelWidth:r=250})=>{const{canvasRef:F,containerRef:_,pxPerMs:T,scrollMs:u,setScrollMs:g,setPxPerMs:S,minStartTime:$,handleFitAll:O,maxScrollMs:A,viewDurationMs:M,recordsByOffset:R}=ce(c,n,t,i,s,o,f);return l.jsxs("div",{className:se["main-block"],children:[l.jsx(ie,{scrollMs:u,pxPerMs:T,setPxPerMs:S,handleFitAll:O,viewDurationMs:M}),l.jsx(re,{labelWidth:r,rowHeight:t,signals:n,containerRef:_,canvasRef:F}),l.jsx(fe,{minStartTime:$,maxScrollMs:A,scrollMs:u,setScrollMs:g}),l.jsx(de,{canvasRef:F,rowHeight:t,signals:n,recordsByOffset:R,scrollMs:u,pxPerMs:T,ySpacing:s})]})},xe={"offset-rows":"_offset-rows_nun66_1"},ve=({})=>{const[n]=Z(t=>[t.oscillographicOffsetsFull],K);console.log(n);const i=m.useMemo(()=>n?Object.entries(n).map(([t,s])=>Object.entries(s).map(([o,c])=>({mac:t,offset:Number(o),name:c.name??`signal_${o}`,times:c.timePoints??[],values:c.values??[],dataType:c.dataType??"bool",typeView:c.typeView??"digital"}))):[],[n]);return l.jsx("div",{className:xe["offset-rows"],style:{overflowX:"auto",maxWidth:"100%",padding:6},children:i.length>0?i.map((t,s)=>l.jsxs("div",{style:{marginBottom:"10px"},children:[l.jsxs("h2",{style:{marginBottom:"10px"},children:["Устройство: ",t[0].mac]}),l.jsx(ue,{signals:t})]},s)):"Нет осцилографированных данных"})};export{ve as default};
