import{r as c,j as n}from"./index-Cu1-bFhH.js";import{u as G}from"./store-rnMnIRlH.js";import{s as J}from"./shallow-raCwAqTK.js";function K(o,a,s){const f=[];for(let d=0;d<o.times.length;d++){const x=o.times[d],S=d<o.times.length-1?o.times[d+1]:s,k=Math.max(x+a,S);f.push({time:x,endTime:k,value:o.values[d],dataType:o.dataType})}return f}function Q(o,a=8){if(o<=0)return 1;const s=o/a,f=Math.pow(10,Math.floor(Math.log10(s))),d=[1,2,5].map(x=>x*f);for(const x of d)if(s<=x)return x;return 10*f}const U=({signals:o,height:a=500,rowHeight:s=20,ySpacing:f=16,defaultDurationMs:d=1,initialPxPerMs:x=20,minBlockWidthPx:S=2,labelWidth:k=140})=>{const z=c.useRef(null),R=c.useRef(null),X=c.useRef(null),[r,E]=c.useState(x),[i,v]=c.useState(0),[T,$]=c.useState(1e3);c.useEffect(()=>{const t=R.current;if(!t)return;const e=()=>$(t.clientWidth);e();const l=new ResizeObserver(e);return l.observe(t),()=>l.disconnect()},[]);const y=c.useMemo(()=>o.reduce((t,e)=>{const l=e.times[e.times.length-1]??0;return Math.max(t,l+d)},0),[o,d]),P=c.useMemo(()=>o.reduce((t,e)=>{const l=e.times[0]??t;return Math.min(t,l)},o[0].times[0]),[o,d]);c.useEffect(()=>{v(P)},[o]);const m=T/r,u=Math.max(0,y-m);c.useEffect(()=>{i>u&&v(u)},[u,i]);const F=c.useMemo(()=>{const t=new Map;for(const e of o)t.set(e.offset,K(e,d,y));return t},[o,d,y]);c.useEffect(()=>{const t=z.current;if(!t)return;const e=t.getContext("2d");if(!e)return;const l=window.devicePixelRatio||1;t.width=T*l,t.height=a*l,e.setTransform(l,0,0,l,0,0),e.clearRect(0,0,T,a);const w=i,C=i+m;o.forEach((g,L)=>{const p=10+L*(s+f),B=F.get(g.offset);B.forEach((h,Y)=>{if(h.endTime<w||h.time>C)return;const j=(h.time-w)*r,b=(h.endTime-w)*r,O=Math.max(S,b-j);if(g.dataType==="bool"){const M=p+s,N=p,A=h.value===1?N:M;e.beginPath(),e.moveTo(j,A),e.lineTo(b,A),e.strokeStyle="#2b6cb0",e.lineWidth=2,e.stroke();const W=B[Y+1];if(W&&W.value!==h.value){const q=W.value===1?N:M;e.beginPath(),e.moveTo(b,A),e.lineTo(b,q),e.stroke()}}else{const M=Math.min(5,Math.max(.5,O/2-.5));e.beginPath(),e.moveTo(j+M,p),e.lineTo(b-M,p),e.lineTo(b,p+s/2),e.lineTo(b-M,p+s),e.lineTo(j+M,p+s),e.lineTo(j,p+s/2),e.closePath(),e.fillStyle="#90cdf4",e.strokeStyle="#2b6cb0",e.fill(),e.stroke(),String(h.value).length*7<O&&(e.fillStyle="#000",e.font="11px sans-serif",e.textAlign="center",e.textBaseline="middle",e.fillText(String(h.value),j+O/2,p+s/2))}})})},[r,i,o,F,a,s,f,S,T,m,y]),c.useEffect(()=>{const t=R.current;if(!t)return;const e=()=>{const l=t.scrollLeft/r;Math.abs(l-i)>.1&&v(Math.min(u,Math.max(0,l)))};return t.addEventListener("scroll",e,{passive:!0}),()=>t.removeEventListener("scroll",e)},[r,u,i]),c.useEffect(()=>{const t=R.current;if(!t)return;const e=i*r;Math.abs(t.scrollLeft-e)>1&&(t.scrollLeft=e)},[i,r]);const _=()=>{v(t=>Math.max(0,t-m*.2))},I=()=>{v(t=>Math.min(u,t+m*.2))},Z=()=>{if(y<=0)return;const t=T/y;E(Math.max(2,Math.min(1e3,t))),v(0)},V=c.useMemo(()=>{const t=i,e=i+m,l=Q(m,8),w=Math.floor(t/l)*l,C=[];for(let g=w;g<=e+l/2;g+=l){const L=(g-t)*r;C.push({time:g,x:L})}return C},[i,m,r]);return console.log("scrollMs: "),console.log("min: ",P),console.log("max: ",y),n.jsxs("div",{style:{fontFamily:"sans-serif",display:"flex",flexDirection:"column"},children:[n.jsxs("div",{style:{display:"flex",gap:8,marginBottom:12,flexWrap:"wrap",alignItems:"center"},children:[n.jsx("button",{onClick:()=>E(t=>Math.max(2,t/1.25)),style:{padding:"6px 12px"},children:"Zoom Out (–)"}),n.jsx("button",{onClick:()=>E(t=>Math.min(1e3,t*1.25)),style:{padding:"6px 12px"},children:"Zoom In (+)"}),n.jsx("button",{onClick:Z,style:{padding:"6px 12px"},children:"Fit All"}),n.jsxs("div",{children:["Scale: ",r.toFixed(2)," px/ms"]}),n.jsxs("div",{children:["View: ",m.toFixed(1)," ms"]}),n.jsxs("div",{children:["Pos: ",i.toFixed(1)," ms"]})]}),n.jsx("div",{style:{display:"flex",flexDirection:"column",border:"1px solid #ddd",borderRadius:4},children:n.jsxs("div",{style:{display:"flex"},children:[n.jsx("div",{style:{width:k,backgroundColor:"#fafafa",borderRight:"1px solid #eee",display:"flex",flexDirection:"column",justifyContent:"flex-start",paddingTop:10,gap:"16px"},children:o.map(t=>n.jsx("div",{style:{height:s,lineHeight:`${s}px`,textAlign:"right",paddingRight:8,color:"#444",fontSize:"12px",fontWeight:"normal",whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:t.name??`Offset ${t.offset}`},t.offset))}),n.jsxs("div",{style:{width:"100%"},children:[n.jsx("div",{style:{width:"100%",overflow:"hidden",height:30,backgroundColor:"#fafafa",borderBottom:"1px solid #eee",position:"relative",paddingLeft:k},ref:X,children:V.map(t=>n.jsxs("div",{style:{position:"absolute",left:t.x,top:0,transform:"translateX(-50%)",textAlign:"center",fontSize:"11px",color:"#555",whiteSpace:"nowrap"},children:[n.jsx("div",{style:{position:"absolute",bottom:-8,left:"50%",transform:"translateX(-50%)",width:1,height:8,backgroundColor:"#ccc"}}),t.time," ms"]},t.time))}),n.jsx("div",{ref:R,style:{flex:1,overflowX:"auto",overflowY:"hidden",height:a,position:"relative",backgroundColor:"#fff"},children:n.jsx("canvas",{ref:z,style:{display:"block",height:a,width:"100%"}})})]})]})}),n.jsx("div",{style:{marginTop:12},children:n.jsx("input",{type:"range",min:P,max:u*r,step:1,value:i*r,onChange:t=>v(Number(t.target.value)/r),style:{width:"100%",height:12,borderRadius:6,background:`linear-gradient(to right, #3182ce 0%, #3182ce ${u>0?i*r/(u*r)*100:0}%, #e2e8f0 ${u>0?i*r/(u*r)*100:0}%, #e2e8f0 100%)`,outline:"none",WebkitAppearance:"none",appearance:"none",cursor:"pointer"}})}),n.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginTop:8},children:[n.jsx("button",{onClick:_,disabled:i<=0,style:{padding:"4px 16px",opacity:i<=0?.5:1},children:"◀◀"}),n.jsx("button",{onClick:I,disabled:i>=u,style:{padding:"4px 16px",opacity:i>=u?.5:1},children:"▶▶"})]})]})},D={"offset-rows":"_offset-rows_nun66_1"},ne=({})=>{const[o]=G(s=>[s.oscillographicOffsets,s.toggleSend],J),a=c.useMemo(()=>Object.entries(o).map(([s,f])=>({offset:Number(s),name:f.name,times:f.timePoints,values:f.values,dataType:f.dataType})),[o]);return console.log("Данные на странице анализатора: ",a),n.jsxs("div",{className:D["offset-rows"],style:{overflowX:"auto",maxWidth:"100%",padding:6},children:[a.length!==0&&n.jsx(U,{signals:a}),a.length===0&&"Нет осцилографированных данных"]})};export{ne as default};
