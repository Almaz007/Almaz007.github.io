import{r,j as l}from"./index-DRwTyAy4.js";import{u as H}from"./store-BY9kv9hB.js";import{s as ee}from"./shallow-DyjSOCTL.js";function te(s,o,t){const n=[];for(let i=0;i<s.times.length;i++){const c=s.times[i],w=i<s.times.length-1?s.times[i+1]:t,d=Math.max(c+o,w);n.push({time:c,endTime:d,value:s.values[i],dataType:s.dataType})}return n}function ne(s,o=8){if(s<=0)return 1;const t=s/o,n=Math.pow(10,Math.floor(Math.log10(t))),i=[1,2,5].map(c=>c*n);for(const c of i)if(t<=c)return c;return 10*n}const se={"main-block":"_main-block_4w5ja_3"},oe=()=>{const s=r.useRef(null),[o,t]=r.useState(1e3);return r.useEffect(()=>{const n=s.current;if(!n)return;const i=()=>t(n.clientWidth);i();const c=new ResizeObserver(i);return c.observe(n),()=>c.disconnect()},[]),{containerWidth:o,containerRef:s}},G=1e-6,ce=(s,o,t,n,i,c=1,w)=>{const{containerWidth:d,containerRef:R}=oe(),T=r.useRef(null),y=r.useRef(null),[u,_]=r.useState(()=>Math.max(G,s)),[j,C]=r.useState(0),[W,O]=r.useState(0);r.useEffect(()=>{_(a=>a===s?a:s)},[s]),r.useEffect(()=>{const a=()=>O(e=>e+1);return window.addEventListener("resize",a),window.addEventListener("orientationchange",a),()=>{window.removeEventListener("resize",a),window.removeEventListener("orientationchange",a)}},[]);const v=r.useMemo(()=>o.reduce((a,e)=>{const $=e.times[e.times.length-1]??0;return Math.max(a,$+c)},0),[o,c]),F=r.useMemo(()=>{const a=o.map(e=>e.times[0]).filter(e=>typeof e=="number");return a.length?Math.min(...a):0},[o]),S=u>G?d/u:1/0,P=r.useMemo(()=>Math.ceil(Math.max(0,v-S)),[v,S]);r.useEffect(()=>{C(a=>Math.min(P,Math.max(F,a)))},[P,F]);const E=r.useMemo(()=>{const a=new Map;for(const e of o)a.set(e.offset,te(e,c,v));return a},[o,c,v]);r.useEffect(()=>{const a=T.current;if(!a)return;const e=a.getContext("2d");if(!e)return;const $=window.devicePixelRatio||1;a.style.width=`${d}px`,a.style.height=`${n}px`,a.width=Math.max(1,Math.round(d*$)),a.height=Math.max(1,Math.round(n*$)),e.setTransform($,0,0,$,0,0),e.clearRect(0,0,d,n);const p=j,z=Number.isFinite(S)&&S>0?j+S:j+1,X=ne(z-p,8);if(!(X>0))return;const U=()=>{e.clearRect(0,0,d,n);const Z=Math.floor(p/X)*X;e.strokeStyle="#eee",e.fillStyle="#333",e.font="12px sans-serif",e.textAlign="center",e.textBaseline="top";for(let L=Z;L<z;L+=X){const I=(L-p)*u;e.beginPath(),e.moveTo(I,0),e.lineTo(I,n-20),e.stroke(),e.fillText(`${L} ms`,I,n-18)}o.forEach((L,I)=>{const g=10+I*(t+i),h=E.get(L.offset);if(!(!h||h.length===0))if(L.dataType==="bool"){e.lineWidth=2,e.strokeStyle="#2b6cb0";for(let x=0;x<h.length;x++){const f=h[x];if(f.endTime<p||f.time>z)continue;const b=(f.time-p)*u,m=(f.endTime-p)*u,k=g,N=g+t,A=f.value===1?k:N;e.beginPath(),e.moveTo(b,A),e.lineTo(m,A),e.stroke();const M=h[x+1];if(M&&M.value!==f.value){const q=M.value===1?k:N;e.beginPath(),e.moveTo(m,A),e.lineTo(m,q),e.stroke()}}}else if(L.dataType==="analog"){if(h.length<2)return;const x=h.findIndex(M=>M.time>=p),f=h.findIndex(M=>M.time>z);let b=[];if(x===-1&&f===-1?b=h.slice(Math.max(0,h.length-2)):x===-1?b=h.slice(0,f+1):f===-1?b=h.slice(Math.max(0,x-1)):b=h.slice(Math.max(0,x-1),f+1),b.length<2)return;const m=[...b];m[0].time>p&&m.unshift({...m[0],time:p}),m[m.length-1].time<z&&m.push({...m[m.length-1],time:z});const k=m.map(M=>Number(M.value||0)),N=Math.min(...k),A=Math.max(...k);e.beginPath(),e.strokeStyle="#e53e3e",e.lineWidth=2,m.forEach((M,q)=>{const J=(M.time-p)*u,D=A===N?.5:(Number(M.value)-N)/(A-N),K=g+t-D*t;q===0?e.moveTo(J,K):e.lineTo(J,K)}),e.stroke()}else h.forEach(x=>{if(x.endTime<p||x.time>z)return;const f=(x.time-p)*u,b=(x.endTime-p)*u,m=Math.max(w,b-f),k=Math.min(5,Math.max(.5,m/2-.5));e.beginPath(),e.moveTo(f+k,g),e.lineTo(b-k,g),e.lineTo(b,g+t/2),e.lineTo(b-k,g+t),e.lineTo(f+k,g+t),e.lineTo(f,g+t/2),e.closePath(),e.fillStyle="#90cdf4",e.strokeStyle="#2b6cb0",e.fill(),e.stroke();const N=String(x.value);e.font="11px sans-serif",e.measureText(N).width+6<m&&(e.fillStyle="#000",e.textAlign="center",e.textBaseline="middle",e.fillText(N,f+m/2,g+t/2))})})};return y.current&&cancelAnimationFrame(y.current),y.current=requestAnimationFrame(U),()=>{y.current&&cancelAnimationFrame(y.current),y.current=null}},[u,j,E,n,t,i,d,w,W,S,o]);const Y=r.useCallback(()=>{if(v<=0)return;const a=Math.max(G,d/v);_(a),C(0)},[d,v]);return{canvasRef:T,pxPerMs:u,scrollMs:j,setScrollMs:C,setPxPerMs:_,maxEndTime:v,maxScrollMs:P,minStartTime:F,containerRef:R,handleFitAll:Y,viewDurationMs:S,recordsByOffset:E}},V={"control-panel":"_control-panel_c31wo_3","control-btn":"_control-btn_c31wo_29"},ae=({viewDurationMs:s,scrollMs:o,pxPerMs:t,setPxPerMs:n,handleFitAll:i})=>l.jsxs("div",{className:V["control-panel"],children:[l.jsx("button",{onClick:()=>n(c=>Math.max(15,Math.ceil(c/1.25))),className:V["control-btn"],children:"Отдалить (–)"}),l.jsx("button",{onClick:()=>n(c=>Math.min(100,Math.ceil(c*1.25))),className:V["control-btn"],children:"Приблизить (+)"}),l.jsx("button",{onClick:i,className:V["control-btn"],children:"Сбросить"}),l.jsxs("div",{children:["Пикселей на мс: ",t.toFixed(2)," px/ms"]}),l.jsxs("div",{children:["Cколько мс: ",s.toFixed(1)," ms"]}),l.jsxs("div",{children:["Стартовая позиция в мс: ",o.toFixed(1)," ms"]})]}),ie="_labels_2x3kd_15",le="_canvas_2x3kd_57",B={"signal-tap-content":"_signal-tap-content_2x3kd_3",labels:ie,"signal-label":"_signal-label_2x3kd_29","canvas-wrapper":"_canvas-wrapper_2x3kd_57",canvas:le},re=({labelWidth:s,rowHeight:o,signals:t,containerRef:n,canvasRef:i})=>l.jsx("div",{className:B["signal-tap-content"],children:l.jsxs("div",{style:{display:"flex",gap:"20px"},children:[l.jsx("div",{style:{width:s},className:B.labels,children:t.map(c=>l.jsx("div",{style:{height:o,lineHeight:`${o}px`},className:B["signal-label"],children:c.name??`Offset ${c.offset}`},c.offset))}),l.jsx("div",{style:{width:"100%"},children:l.jsx("div",{ref:n,className:B["canvas-wrapper"],children:l.jsx("canvas",{ref:i,className:B.canvas})})})]})}),me="_slider_1mjjb_3",Q={"slider-container":"_slider-container_1mjjb_3",slider:me},de=({minStartTime:s,maxScrollMs:o,scrollMs:t,setScrollMs:n})=>l.jsx("div",{className:Q["slider-container"],children:l.jsx("input",{type:"range",min:s,max:o,step:1,value:t,onChange:i=>n(Number(i.target.value)),className:Q.slider})}),ue=({canvasRef:s,rowHeight:o,signals:t,recordsByOffset:n,scrollMs:i,pxPerMs:c,ySpacing:w})=>{const[d,R]=r.useState(null);return r.useEffect(()=>{const T=s.current;if(!T)return;const y=_=>{const j=T.getBoundingClientRect(),C=_.clientX-j.left,W=_.clientY-j.top;let O=!1;t.forEach((v,F)=>{const S=10+F*(o+w);n.get(v.offset).forEach(E=>{const Y=(E.time-i)*c,a=(E.endTime-i)*c,e=S,$=S+o;C>=Y&&C<=a&&W>=e&&W<=$&&(R({x:_.clientX,y:_.clientY,content:`offset: ${v.offset}
start: ${E.time} ms
end: ${E.endTime} ms
value: ${E.value}`}),O=!0)})}),O||R(null)},u=()=>R(null);return T.addEventListener("mousemove",y),T.addEventListener("mouseleave",u),()=>{T.removeEventListener("mousemove",y),T.removeEventListener("mouseleave",u)}},[t,c,i,o,w,n]),d&&l.jsx("div",{style:{position:"fixed",top:d.y+10,left:d.x+10,background:"rgba(0,0,0,0.8)",color:"white",padding:"4px 8px",borderRadius:"4px",fontSize:"12px",whiteSpace:"pre-line",pointerEvents:"none",zIndex:1e3},children:d.content})},fe=({signals:s,height:o=500,rowHeight:t=20,ySpacing:n=16,defaultDurationMs:i=1,initialPxPerMs:c=20,minBlockWidthPx:w=2,labelWidth:d=140})=>{const{canvasRef:R,containerRef:T,pxPerMs:y,scrollMs:u,setScrollMs:_,setPxPerMs:j,minStartTime:C,handleFitAll:W,maxScrollMs:O,viewDurationMs:v,recordsByOffset:F}=ce(c,s,t,o,n,i,w);return console.log(s),l.jsxs("div",{className:se["main-block"],children:[l.jsx(ae,{scrollMs:u,pxPerMs:y,setPxPerMs:j,handleFitAll:W,viewDurationMs:v}),l.jsx(re,{labelWidth:d,rowHeight:t,signals:s,containerRef:T,canvasRef:R}),l.jsx(de,{minStartTime:C,maxScrollMs:O,scrollMs:u,setScrollMs:_}),l.jsx(ue,{canvasRef:R,rowHeight:t,signals:s,recordsByOffset:F,scrollMs:u,pxPerMs:y,ySpacing:n})]})},xe={"offset-rows":"_offset-rows_nun66_1"},be=({})=>{const[s]=H(t=>[t.oscillographicOffsets,t.toggleSend],ee),o=r.useMemo(()=>Object.entries(s).map(([t,n])=>({offset:Number(t),name:n.name,times:n.timePoints,values:n.values,dataType:n.dataType})),[s]);return l.jsxs("div",{className:xe["offset-rows"],style:{overflowX:"auto",maxWidth:"100%",padding:6},children:[o.length!==0&&l.jsx(fe,{signals:o}),o.length===0&&"Нет осцилографированных данных"]})};export{be as default};
