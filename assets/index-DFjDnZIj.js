import{r as x,j as e,c as _}from"./index-DG-hptjM.js";import{u as v}from"./store-D0imbOJq.js";import{c as y,s as w}from"./shallow-CjbkFOmN.js";import{B as S}from"./Button-Cu8J8qDM.js";import{u as D}from"./store-C0d-2I0O.js";const N="_wrapper_1r16a_1",C="_form_1r16a_17",k="_drag_1r16a_29",E="_label_1r16a_43",F="_input_1r16a_49",A="_info_1r16a_93",T="_btns_1r16a_103",c={wrapper:N,form:C,drag:k,"action-title":"_action-title_1r16a_35",label:E,input:F,"file-list":"_file-list_1r16a_63","download-label":"_download-label_1r16a_73",info:A,btns:T,"button-reset":"_button-reset_1r16a_111","button-submit":"_button-submit_1r16a_113"},j=y((a,l)=>({ws:null,status:"disconnected",error:null,messages:[],parseOscilografFile:async r=>{const s=await r.arrayBuffer(),o=new DataView(s);console.log(s);const d={};for(let i=0;i+16<=o.byteLength;i+=16){const n=o.getUint32(i,!0);if(n===0)return;const g=o.getUint32(i+4,!0),f=o.getUint32(i+8,!0),t=o.getUint32(i+12,!0);console.log(`номер: ${n}, метка: ${g}, смещение: ${f}, значение: ${t}`),d[f]||(d[f]={timePoints:[],values:[]}),d[f].timePoints.push(g),d[f].values.push(t)}v.getState().updateOscillographicData(d)},connect:r=>{let{ws:s,parseOscilografFile:o,status:d}=l();s||(a({status:"connecting",error:null}),s=new WebSocket(r),a({ws:s}),s.onopen=()=>{a({error:null,status:"connected"}),console.log("WebSocket connected")},s.onmessage=async u=>{u.data instanceof Blob?(a(i=>({messages:[...i.messages,"Получен бинарный пакет"]})),await o(u.data)):(console.log("Получено с сервера:",u.data),a(i=>({messages:[...i.messages,u.data.toString()]})))},s.onerror=()=>{a({error:"Connection error",status:"disconnected"})},s.onclose=()=>{console.log("WebSocket closed. Status was:",d),s=null,a({ws:null})})},disconnect:()=>{const{ws:r}=l();r&&(r.close(),a({ws:null,status:"disconnected"}))},sendMessage:r=>{const{ws:s}=l();s&&(a(o=>({messages:[...o.messages,r]})),s.send(r))},sendFile:r=>{const{ws:s}=l();s&&(a(o=>({messages:[...o.messages,"Файл отправлен"]})),s.send(r))},sendConfig:r=>{const{ws:s}=l();s&&(a(o=>({messages:[...o.messages,"Конфиг отправлен"]})),s.send(r))}})),U=()=>{const a=j(t=>t.sendFile),[l,r]=x.useState([]),[s,o]=x.useState(!1),d=t=>{t.preventDefault(),t.target.files&&t.target.files[0]&&r([t.target.files[0]])},u=()=>{r([])},i=async t=>{if(t.preventDefault(),!l||l.length===0)return;const m=await l[0].arrayBuffer(),b=new Uint8Array(m),p=new TextEncoder().encode("firmware,"),h=new Uint8Array(p.length+b.length);h.set(p,0),h.set(b,p.length),a(h)},n=function(t){t.preventDefault(),o(!0)},g=function(t){t.preventDefault(),o(!1)},f=function(t){var m;t.preventDefault(),o(!1),(m=t.dataTransfer)!=null&&m.files&&t.dataTransfer.files[0]&&r([t.dataTransfer.files[0]])};return e.jsx("div",{className:_(c.wrapper,{[c.drag]:s}),children:e.jsxs("form",{className:_(c.form),onReset:u,onSubmit:i,onDragEnter:n,onDragOver:n,onDragLeave:g,onDrop:f,children:[e.jsx("h2",{className:c["action-title"],children:"Перетащите файлы сюда"}),e.jsx("p",{children:"или"}),e.jsxs("label",{className:c.label,children:[e.jsx("span",{className:c["download-label"],children:"Загрузите файл"}),e.jsx("input",{className:c.input,type:"file",multiple:!1,onChange:d})]}),l.length>0&&e.jsxs("div",{className:c.info,children:[e.jsx("ul",{className:c["file-list"],children:e.jsx("li",{children:l[0].name})}),e.jsxs("div",{className:c.btns,children:[e.jsx("button",{className:c["button-reset"],type:"reset",children:"Отменить"}),e.jsx("button",{className:c["button-submit"],type:"submit",children:"Отправить"})]})]})]})})},W="_row_q0ihq_1",B={row:W},P=()=>{const[a,l,r,s,o,d]=j(n=>[n.status,n.error,n.messages,n.connect,n.disconnect,n.sendConfig],w),u=D(n=>n.config,w),i=()=>{const n=new TextEncoder().encode(JSON.stringify(u));if(n.length===0){console.log("конфиг не отправлен");return}const g=new TextEncoder().encode("flexibleLogic,"),f=new Uint8Array(g.length+n.length);f.set(g,0),f.set(n,g.length),d(f)};return e.jsxs("div",{children:[e.jsx("h2",{children:"WebSocket"}),e.jsxs("p",{children:["Status: ",a," ",l&&`| Error: ${l}`]}),e.jsx("button",{onClick:()=>s("wss://int-rt.ru:3010"),children:"Подключить"}),e.jsx("br",{}),e.jsx("button",{onClick:o,children:"Отключить"}),e.jsx("div",{style:{height:"300px",overflowY:"auto",border:"1px solid blue",padding:"10px",marginTop:"10px"},children:r.map((n,g)=>e.jsx("p",{children:n},g))}),e.jsx("br",{}),e.jsxs("div",{className:B.row,children:[e.jsx(U,{}),e.jsxs("div",{children:[e.jsx(S,{disabled:!u.scripts.length,onClick:i,text:"загрузить гибкую логику"}),e.jsx("br",{}),!u.scripts.length&&e.jsx("div",{children:"необходимо сформировать гибкую логику"})]})]})]})};export{P as default};
