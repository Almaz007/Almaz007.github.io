import{r as m,j as u}from"./index-BU8NbYXv.js";import{u as G}from"./store-Dai1LUXj.js";import{s as I}from"./shallow-CwuyXiz3.js";function J(t,s,o){const c=[];for(let l=0;l<t.times.length;l++){const a=t.times[l],M=l<t.times.length-1?t.times[l+1]:o,r=Math.max(a+s,M);c.push({time:a,endTime:r,value:t.values[l],dataType:t.dataType})}return c}function K(t,s=8){if(t<=0)return 1;const o=t/s,c=Math.pow(10,Math.floor(Math.log10(o))),l=[1,2,5].map(a=>a*c);for(const a of l)if(o<=a)return a;return 10*c}const Q=({signals:t,height:s=500,rowHeight:o=20,ySpacing:c=6,defaultDurationMs:l=1,initialPxPerMs:a=20,minBlockWidthPx:M=2,labelWidth:r=140})=>{const A=m.useRef(null),w=m.useRef(null),[d,B]=m.useState(a),[S,$]=m.useState(0),j=m.useMemo(()=>t.reduce((n,e)=>{const T=e.times[e.times.length-1]??0;return Math.max(n,T+l)},0),[t,l]),O=m.useMemo(()=>{const n=new Map;for(const e of t)n.set(e.offset,J(e,l,j));return n},[t,l,j]);console.log(j);const y=Math.max(200,Math.ceil(j*d)+r);return m.useEffect(()=>{const n=w.current;if(!n)return;const e=()=>$(n.scrollLeft);return n.addEventListener("scroll",e),()=>n.removeEventListener("scroll",e)},[]),m.useEffect(()=>{const n=A.current;if(!n)return;const e=n.getContext("2d");if(!e)return;const T=window.devicePixelRatio||1;n.width=y*T,n.height=s*T,e.setTransform(T,0,0,T,0,0),e.clearRect(0,0,y,s);const C=w.current,N=C?C.clientWidth:y;console.log("ширина container: ",N),console.log("ширина лейбла: ",r),console.log("scrollLeft: ",S);const k=(S-r)/d,E=(S+N-r)/d;console.log("startMs: ",k);const P=K(E-k,8),F=Math.floor(k/P)*P;e.strokeStyle="#eee",e.fillStyle="#333",e.font="11px sans-serif",e.textAlign="center",e.textBaseline="top";for(let f=F;f<E;f+=P){const g=r+f*d;e.beginPath(),e.moveTo(g,0),e.lineTo(g,s-20),e.stroke(),e.fillText(`${f} ms`,g,s-18)}t.forEach((f,g)=>{const i=g*(o+c)+10,_=O.get(f.offset);_.forEach((x,X)=>{if(x.endTime<k||x.time>E)return;const h=r+x.time*d,p=r+x.endTime*d,L=Math.max(M,p-h);if(f.dataType==="bool"){const v=i+o,z=i,R=x.value===1?z:v;e.beginPath(),e.moveTo(h,R),e.lineTo(p,R),e.strokeStyle="#2b6cb0",e.lineWidth=2,e.stroke();const b=_[X+1];if(b&&b.value!==x.value){const q=b.value===1?z:v;e.beginPath(),e.moveTo(p,R),e.lineTo(p,q),e.stroke()}}else{const v=Math.min(5,Math.max(.5,L/2-.5));e.beginPath(),e.moveTo(h+v,i),e.lineTo(p-v,i),e.lineTo(p,i+o/2),e.lineTo(p-v,i+o),e.lineTo(h+v,i+o),e.lineTo(h,i+o/2),e.closePath(),e.fillStyle="#90cdf4",e.strokeStyle="#2b6cb0",e.fill(),e.stroke(),String(x.value).length*7<L&&(e.fillStyle="#000",e.font="11px sans-serif",e.textAlign="center",e.textBaseline="middle",e.fillText(String(x.value),h+L/2,i+o/2))}}),e.fillStyle="#444",e.font="12px sans-serif",e.textAlign="right",e.textBaseline="middle",e.fillText(f.name??`Offset ${f.offset}`,r-4,i+o/2)})},[d,S,t,O,s,o,c,M,y,r]),u.jsxs("div",{children:[u.jsxs("div",{style:{display:"flex",gap:8,marginBottom:8},children:[u.jsx("button",{onClick:()=>B(n=>Math.max(2,n/1.25)),children:"–"}),u.jsx("button",{onClick:()=>B(n=>Math.min(1e3,n*1.25)),children:"+"}),u.jsxs("div",{children:["px/ms: ",d.toFixed(1)]})]}),u.jsx("div",{ref:w,style:{width:"100%",overflow:"auto",border:"1px solid #ddd"},children:u.jsx("canvas",{ref:A,style:{width:y,height:"auto"}})})]})},U={"offset-rows":"_offset-rows_nun66_1"},W=({})=>{const[t]=G(o=>[o.oscillographicOffsets,o.toggleSend],I),s=m.useMemo(()=>Object.entries(t).map(([o,c])=>({offset:Number(o),name:c.name,times:c.timePoints,values:c.values,dataType:c.dataType})),[t]);return u.jsxs("div",{className:U["offset-rows"],style:{overflowX:"auto",maxWidth:"100%",padding:6},children:[s.length!==0&&u.jsx(Q,{signals:s}),s.length===0&&"Нет осцилографированных данных"]})};export{W as default};
