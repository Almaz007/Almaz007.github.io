import{r as F,j as e,d as v,U as z,Q as C,c as L}from"./index-CrREYRkc.js";import{u as S}from"./store-Du-GoxsD.js";import{B as A}from"./Button-C6bKAtMY.js";import{u as T,p as M}from"./pako.esm-B2G-gnns.js";import{s as N}from"./shallow-BHpKla55.js";const O="_wrapper_zxo5y_1",B="_form_zxo5y_17",U="_drag_zxo5y_29",E="_label_zxo5y_43",W="_input_zxo5y_49",I="_info_zxo5y_93",P="_btns_zxo5y_103",f={wrapper:O,form:B,drag:U,"action-title":"_action-title_zxo5y_35",label:E,input:W,"file-list":"_file-list_zxo5y_63","download-label":"_download-label_zxo5y_73",info:I,btns:P,"button-reset":"_button-reset_zxo5y_111","button-submit":"_button-submit_zxo5y_113","dnd-tile":"_dnd-tile_zxo5y_135"},$=({handleSubmit:l,title:p})=>{const[r,n]=F.useState([]),[i,d]=F.useState(!1),x=s=>{s.preventDefault(),s.target.files&&s.target.files[0]&&n([s.target.files[0]])},o=()=>{n([])},b=function(s){s.preventDefault(),d(!0)},y=function(s){s.preventDefault(),d(!1)},h=function(s){var w;s.preventDefault(),d(!1),(w=s.dataTransfer)!=null&&w.files&&s.dataTransfer.files[0]&&n([s.dataTransfer.files[0]])};return e.jsxs("div",{className:v(f.wrapper,{[f.drag]:i}),children:[e.jsx("h2",{className:f["dnd-tile"],children:p}),e.jsxs("form",{className:v(f.form),onReset:o,onDragEnter:b,onDragOver:b,onDragLeave:y,onDrop:h,children:[e.jsx("h2",{className:f["action-title"],children:"Перетащите файлы сюда"}),e.jsx("p",{children:"или"}),e.jsxs("label",{className:f.label,children:[e.jsx("span",{className:f["download-label"],children:"Загрузите файл"}),e.jsx("input",{className:f.input,type:"file",multiple:!1,onChange:x})]}),r.length>0&&e.jsxs("div",{className:f.info,children:[e.jsx("ul",{className:f["file-list"],children:e.jsx("li",{children:r[0].name})}),e.jsxs("div",{className:f.btns,children:[e.jsx("button",{className:f["button-reset"],type:"reset",children:"Отменить"}),e.jsx("button",{className:f["button-submit"],onClick:s=>l(s,r),children:"Отправить"})]})]})]})]})},R=z((l,p)=>({ws:null,status:"disconnected",error:null,messages:[],strForDownload:{},clearMessages:()=>l({messages:[]}),parseOscilografFile:async r=>{const n=await r.arrayBuffer(),i=new DataView(n);console.log("Получен буфер размером:",n,n.byteLength,"байт");let d=-1;for(let c=0;c<i.byteLength;c++)if(i.getUint8(c)===44){d=c;break}if(d===-1){console.warn("Запятая не найдена в буфере - пропускаем пакет");return}console.log("Запятая найдена на позиции:",d);const x=new Uint8Array(n,0,d),o=new TextDecoder().decode(x).trim();if(!o){console.warn("ID пустой - пропускаем пакет");return}console.log("Извлечен ID:",o);const b=d+1,y=i.byteLength-b;if(y<=0){console.warn("Нет данных после запятой - пропускаем пакет");return}console.log("Данные начинаются с байта:",b,"длина:",y);const h=new DataView(n,b,y),s=[],w={};for(let c=0;c+16<=h.byteLength;c+=16){const t=h.getUint32(c,!0);if(t===0){console.log("Найден нулевой номер - завершаем парсинг");break}const a=h.getUint32(c+4),g=h.getUint32(c+8,!0),m=h.getUint32(c+12,!0),u=`номер: ${t}, метка: ${a}, смещение: ${g}, значение: ${m}`;s.push(u),w[g]||(w[g]={timePoints:[],values:[]}),w[g].timePoints.push(a),w[g].values.push(m)}console.log(`Спарсено записей для MAC ${o}:`,s.length),console.log(`Размер данных: ${h.byteLength} байт`);const D=h.byteLength!==1344;S.getState().appendMacPacket(o,w,D),console.log(`Это последний пакет: ${D}`),l(c=>{const a=[...c.strForDownload[o]??[],...s];if(console.log(`Всего накоплено записей для ${o}: ${a.length}`),D&&a.length>0){console.log(`СКАЧИВАЕМ файл для MAC: ${o}, записей: ${a.length}`);try{const m=new Date().toISOString().replace("T","_").replace(/:/g,"-").split(".")[0],u=`dataLogicAnalyzer_${o}_${m}.txt`,_=a.join(`
`);C(_,u,"text/plain"),console.log(`Файл успешно скачан: ${u}`);const{[o]:J,...k}=c.strForDownload;return{strForDownload:k}}catch(g){console.error("Ошибка при скачивании файла для MAC",o,g);const{[o]:m,...u}=c.strForDownload;return{strForDownload:u}}}return{strForDownload:{...c.strForDownload,[o]:a}}})},downloadStr:()=>{const{strForDownload:r}=p(),i=new Date().toISOString().replace("T","_").replace(/:/g,"-").split(".")[0],d=Object.entries(r).map(([o,b])=>`MAC: ${o}
${b.join(`
`)}
`).join(`
`);C(d,`dataLogicAnalyzer_all_${i}.txt`,"text/plain"),S.getState().clearTempOscillographic(),l({strForDownload:{}})},connect:r=>{let{ws:n,parseOscilografFile:i,status:d}=p();n||(l({status:"connecting",error:null}),n=new WebSocket(r),l({ws:n}),n.onopen=()=>{l({error:null,status:"connected"}),console.log("WebSocket connected")},n.onmessage=async x=>{x.data instanceof Blob?(l(o=>({messages:[...o.messages,`Получен бинарный пакет ${o.messages.length+1}`]})),await i(x.data)):l(o=>({messages:[...o.messages,x.data.toString()]}))},n.onerror=()=>l({error:"Connection error",status:"disconnected"}),n.onclose=()=>{console.log("WebSocket closed. Status was:",d),n=null,l({ws:null,status:"disconnected"})})},disconnect:()=>{const{ws:r}=p();r&&(r.close(),l({ws:null,status:"disconnected"}))},sendMessage:r=>{const{ws:n}=p();n&&(l(i=>({messages:[...i.messages,r]})),n.send(r))},sendFile:r=>{const{ws:n}=p();n&&(l(i=>({messages:[...i.messages,"Файл отправлен"]})),n.send(r))},sendConfig:r=>{const{ws:n}=p();n&&(l(i=>({messages:[...i.messages,"Конфиг отправлен"]})),n.send(r))}})),V="_row_5hypj_1",j={row:V,"action-btn":"_action-btn_5hypj_11","actions-memory":"_actions-memory_5hypj_29"},K=()=>{const l=L(t=>t.sendFirmware),p=S(t=>t.clearTempOscillographic),[r,n,i,d,x,o,b,y,h]=R(t=>[t.status,t.error,t.messages,t.connect,t.disconnect,t.sendConfig,t.sendFile,t.clearMessages,t.downloadStr],N),s=T(t=>t.config,N),w=()=>{const t=M.deflate(JSON.stringify(s.flexLogic)),a=btoa(String.fromCharCode(...t)),g={...s,flexLogic:a},m=new TextEncoder().encode(JSON.stringify(g));if(m.length===0){console.log("конфиг не отправлен");return}const u=new TextEncoder().encode("flexibleLogic,"),_=new Uint8Array(u.length+m.length);_.set(u,0),_.set(m,u.length),o(_)},D=async(t,a)=>{if(t.preventDefault(),!a||a.length===0)return;const g=await a[0].arrayBuffer(),m=new Uint8Array(g),u=new TextEncoder().encode("firmware,"),_=new Uint8Array(u.length+m.length);_.set(u,0),_.set(m,u.length),b(_)},c=async(t,a)=>{if(t.preventDefault(),!a||a.length===0)return;const g=await a[0].arrayBuffer();l(g)};return e.jsxs("div",{children:[e.jsx("h2",{children:"WebSocket"}),e.jsxs("p",{children:["Status: ",r," ",n&&`| Error: ${n}`]}),e.jsx("br",{}),e.jsx("button",{className:j["action-btn"],onClick:()=>d("ws://10.3.211.60:3010"),children:"Подключить"}),e.jsx("br",{}),e.jsx("button",{className:j["action-btn"],onClick:x,children:"Отключить"}),e.jsx("br",{}),e.jsx("br",{}),e.jsxs("div",{className:j["actions-memory"],children:[e.jsx("button",{className:j["action-btn"],onClick:p,children:"Очистить временную память"}),e.jsx("br",{}),e.jsx("button",{className:j["action-btn"],onClick:y,children:"Очистить логи"}),e.jsx("button",{className:j["action-btn"],onClick:h,children:"Скачать данные из временной памяти"})]}),e.jsx("div",{style:{height:"300px",overflowY:"auto",border:"1px solid blue",padding:"10px",marginTop:"10px"},children:i.map((t,a)=>e.jsx("p",{children:t},a))}),e.jsx("br",{}),e.jsxs("div",{className:j.row,children:[e.jsx($,{handleSubmit:D,title:"Отправка прошивки по web-socket"}),e.jsx($,{handleSubmit:c,title:"Отправка прошивки по ble"}),e.jsxs("div",{children:[e.jsx(A,{disabled:!s.scripts_1ms.length&&!s.scripts_250us.length,onClick:w,text:"загрузить"}),e.jsx("br",{}),!s.scripts_1ms.length&&!s.scripts_250us.length&&e.jsx("div",{children:"необходимо сформировать гибкую логику"})]})]})]})};export{K as default};
