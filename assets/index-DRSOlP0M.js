import{r as f,j as i}from"./index-DuHUl5M-.js";import{u as U}from"./store-CBJm4gsN.js";import{s as Z}from"./shallow-BXe0x4RE.js";function te(s,o,t){const n=[];for(let c=0;c<s.times.length;c++){const l=s.times[c],m=c<s.times.length-1?s.times[c+1]:t,r=Math.max(l+o,m);n.push({time:l,endTime:r,value:s.values[c],dataType:s.dataType,typeView:s.typeView})}return n}function ne(s,o=8){if(s<=0)return 1;const t=s/o,n=Math.pow(10,Math.floor(Math.log10(t))),c=[1,2,5].map(l=>l*n);for(const l of c)if(t<=l)return l;return 10*n}const se={"main-block":"_main-block_4w5ja_3"},oe=()=>{const s=f.useRef(null),[o,t]=f.useState(1e3);return f.useEffect(()=>{const n=s.current;if(!n)return;const c=()=>t(n.clientWidth);c();const l=new ResizeObserver(c);return l.observe(n),()=>l.disconnect()},[]),{containerWidth:o,containerRef:s}},K=1e-6,ce=(s,o,t,n,c,l=1,m)=>{const{containerWidth:r,containerRef:F}=oe(),j=f.useRef(null),T=f.useRef(null),[u,g]=f.useState(()=>Math.max(K,s)),[S,$]=f.useState(0),[A,O]=f.useState(0);f.useEffect(()=>{g(a=>a===s?a:s)},[s]),f.useEffect(()=>{const a=()=>O(e=>e+1);return window.addEventListener("resize",a),window.addEventListener("orientationchange",a),()=>{window.removeEventListener("resize",a),window.removeEventListener("orientationchange",a)}},[]);const M=f.useMemo(()=>o.reduce((a,e)=>{const V=e.times[e.times.length-1]??0;return Math.max(a,V+l)},0),[o,l]),R=f.useMemo(()=>{const a=o.map(e=>e.times[0]).filter(e=>typeof e=="number");return a.length?Math.min(...a):0},[o]),E=u>K?r/u:1/0,I=f.useMemo(()=>Math.ceil(Math.max(0,M-E)),[M,E]);f.useEffect(()=>{$(a=>Math.min(I,Math.max(R,a)))},[I,R]);const L=f.useMemo(()=>{const a=new Map;for(const e of o)a.set(e.offset,te(e,l,M));return a},[o,l,M]);f.useEffect(()=>{const a=j.current;if(!a)return;const e=a.getContext("2d");if(!e)return;const V=window.devicePixelRatio||1;a.style.width=`${r}px`,a.style.height=`${n}px`,a.width=Math.max(1,Math.round(r*V)),a.height=Math.max(1,Math.round(n*V)),e.setTransform(V,0,0,V,0,0),e.clearRect(0,0,r,n);const y=S,W=Number.isFinite(E)&&E>0?S+E:S+1,P=ne(W-y,8);if(!(P>0))return;const D=()=>{e.clearRect(0,0,r,n),o.forEach((k,w)=>{const p=10+w*(t+c),h=t+c;w%2===0?e.fillStyle="#f9fafb":e.fillStyle="#f3f4f6",e.fillRect(0,p-5,r,h)});const H=Math.floor(y/P)*P;e.strokeStyle="#e5e7eb",e.fillStyle="#333",e.font="12px sans-serif",e.textAlign="center",e.textBaseline="top";for(let k=H;k<W;k+=P){const w=(k-y)*u;e.beginPath(),e.moveTo(w,0),e.lineTo(w,n-20),e.stroke(),e.fillText(`${k} ms`,w,n-18)}o.forEach((k,w)=>{if(w>0){const p=10+w*(t+c)-c/2;e.strokeStyle="#616161ff",e.lineWidth=1,e.beginPath(),e.moveTo(0,p),e.lineTo(r,p),e.stroke()}}),o.forEach((k,w)=>{const p=10+w*(t+c),h=L.get(k.offset);if(!(!h||h.length===0))if(k.typeView==="line"){e.lineWidth=2,e.strokeStyle="#2b6cb0";for(let v=0;v<h.length;v++){const x=h[v];if(x.endTime<y||x.time>W)continue;const b=(x.time-y)*u,d=(x.endTime-y)*u,N=p,C=p+t,z=x.value===1?N:C;e.beginPath(),e.moveTo(b,z),e.lineTo(d,z),e.stroke();const _=h[v+1];if(_&&_.value!==x.value){const q=_.value===1?N:C;e.beginPath(),e.moveTo(d,z),e.lineTo(d,q),e.stroke()}}}else if(k.typeView==="point"){if(h.length<2)return;const v=h.findIndex(_=>_.time>=y),x=h.findIndex(_=>_.time>W);let b=[];if(v===-1&&x===-1?b=h.slice(Math.max(0,h.length-2)):v===-1?b=h.slice(0,x+1):x===-1?b=h.slice(Math.max(0,v-1)):b=h.slice(Math.max(0,v-1),x+1),b.length<2)return;const d=[...b];d[0].time>y&&d.unshift({...d[0],time:y}),d[d.length-1].time<W&&d.push({...d[d.length-1],time:W});const N=d.map(_=>Number(_.value||0)),C=Math.min(...N),z=Math.max(...N);e.beginPath(),e.strokeStyle="#2b6cb0",e.lineWidth=2,d.forEach((_,q)=>{const G=(_.time-y)*u,ee=z===C?.5:(Number(_.value)-C)/(z-C),J=p+t-ee*t;q===0?e.moveTo(G,J):e.lineTo(G,J)}),e.stroke()}else h.forEach(v=>{if(v.endTime<y||v.time>W)return;const x=(v.time-y)*u,b=(v.endTime-y)*u,d=Math.max(m,b-x),N=Math.min(5,Math.max(.5,d/2-.5));e.beginPath(),e.moveTo(x+N,p),e.lineTo(b-N,p),e.lineTo(b,p+t/2),e.lineTo(b-N,p+t),e.lineTo(x+N,p+t),e.lineTo(x,p+t/2),e.closePath(),e.fillStyle="#90cdf4",e.strokeStyle="#2b6cb0",e.fill(),e.stroke();const C=String(v.value);e.font="13px sans-serif",e.measureText(C).width+6<d&&(e.fillStyle="#000",e.textAlign="center",e.textBaseline="middle",e.fillText(C,x+d/2,p+t/2))})})};return T.current&&cancelAnimationFrame(T.current),T.current=requestAnimationFrame(D),()=>{T.current&&cancelAnimationFrame(T.current),T.current=null}},[u,S,L,n,t,c,r,m,A,E,o]);const Y=f.useCallback(()=>{M<=0||(g(20),$(()=>Math.min(I,R)))},[r,M,I,R]);return{canvasRef:j,pxPerMs:u,scrollMs:S,setScrollMs:$,setPxPerMs:g,maxEndTime:M,maxScrollMs:I,minStartTime:R,containerRef:F,handleFitAll:Y,viewDurationMs:E,recordsByOffset:L}},X={"control-panel":"_control-panel_c31wo_3","control-btn":"_control-btn_c31wo_29"},ie=({viewDurationMs:s,scrollMs:o,pxPerMs:t,setPxPerMs:n,handleFitAll:c})=>i.jsxs("div",{className:X["control-panel"],children:[i.jsx("button",{onClick:()=>n(l=>Math.max(15,Math.ceil(l/1.25))),className:X["control-btn"],children:"Отдалить (–)"}),i.jsx("button",{onClick:()=>n(l=>Math.min(100,Math.ceil(l*1.25))),className:X["control-btn"],children:"Приблизить (+)"}),i.jsx("button",{onClick:c,className:X["control-btn"],children:"Сбросить"}),i.jsxs("div",{children:["Пикселей на мс: ",t.toFixed(2)," px/ms"]}),i.jsxs("div",{children:["Cколько мс: ",s.toFixed(1)," ms"]}),i.jsxs("div",{children:["Стартовая позиция в мс: ",o.toFixed(1)," ms"]})]}),le="_labels_m5mef_15",ae="_canvas_m5mef_79",B={"signal-tap-content":"_signal-tap-content_m5mef_3",labels:le,"signal-label":"_signal-label_m5mef_29","canvas-wrapper":"_canvas-wrapper_m5mef_79",canvas:ae,"view-type-change":"_view-type-change_m5mef_151"},re=({labelWidth:s,rowHeight:o,signals:t,containerRef:n,canvasRef:c})=>{const[l]=U(m=>[m.changeViewTypeForOffset],Z);return i.jsx("div",{className:B["signal-tap-content"],children:i.jsxs("div",{style:{display:"flex",gap:"20px"},children:[i.jsx("div",{style:{width:s},className:B.labels,children:t.map((m,r)=>i.jsxs("div",{style:{height:o,lineHeight:`${o}px`,borderLeft:"4px solid #2b6cb0",paddingLeft:"8px",background:r%2===0?"#f9fafb":"#f3f4f6"},className:B["signal-label"],children:[i.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px",fontWeight:500},children:[i.jsx("span",{children:m.name??`Offset ${m.offset}`}),i.jsx("span",{style:{fontSize:"10px",color:"#9ca3af",textTransform:"uppercase",letterSpacing:"0.5px",marginLeft:"4px"},children:m.dataType})]}),m.typeView!=="line"&&i.jsx("div",{onClick:()=>l(m.offset),className:B["view-type-change"],children:"изменить"})]},m.offset))}),i.jsx("div",{style:{width:"100%"},children:i.jsx("div",{ref:n,className:B["canvas-wrapper"],children:i.jsx("canvas",{ref:c,className:B.canvas})})})]})})},fe="_slider_1mjjb_3",Q={"slider-container":"_slider-container_1mjjb_3",slider:fe},me=({minStartTime:s,maxScrollMs:o,scrollMs:t,setScrollMs:n})=>i.jsx("div",{className:Q["slider-container"],children:i.jsx("input",{type:"range",min:s,max:o,step:1,value:t,onChange:c=>n(Number(c.target.value)),className:Q.slider})}),de=({canvasRef:s,rowHeight:o,signals:t,recordsByOffset:n,scrollMs:c,pxPerMs:l,ySpacing:m})=>{const[r,F]=f.useState(null);return f.useEffect(()=>{const j=s.current;if(!j)return;const T=g=>{const S=j.getBoundingClientRect(),$=g.clientX-S.left,A=g.clientY-S.top;let O=!1;t.forEach((M,R)=>{const E=10+R*(o+m);n.get(M.offset).forEach(L=>{const Y=(L.time-c)*l,a=(L.endTime-c)*l,e=E,V=E+o;$>=Y&&$<=a&&A>=e&&A<=V&&(F({x:g.clientX,y:g.clientY,content:`offset: ${M.offset}
start: ${L.time} ms
end: ${L.endTime} ms
value: ${L.value}`}),O=!0)})}),O||F(null)},u=()=>F(null);return j.addEventListener("mousemove",T),j.addEventListener("mouseleave",u),()=>{j.removeEventListener("mousemove",T),j.removeEventListener("mouseleave",u)}},[t,l,c,o,m,n]),r&&i.jsx("div",{style:{position:"fixed",top:r.y+10,left:r.x+10,background:"rgba(0,0,0,0.8)",color:"white",padding:"4px 8px",borderRadius:"4px",fontSize:"12px",whiteSpace:"pre-line",pointerEvents:"none",zIndex:1e3},children:r.content})},ue=({signals:s,height:o=500,rowHeight:t=25,ySpacing:n=16,defaultDurationMs:c=1,initialPxPerMs:l=40,minBlockWidthPx:m=2,labelWidth:r=250})=>{const{canvasRef:F,containerRef:j,pxPerMs:T,scrollMs:u,setScrollMs:g,setPxPerMs:S,minStartTime:$,handleFitAll:A,maxScrollMs:O,viewDurationMs:M,recordsByOffset:R}=ce(l,s,t,o,n,c,m);return console.log(s),i.jsxs("div",{className:se["main-block"],children:[i.jsx(ie,{scrollMs:u,pxPerMs:T,setPxPerMs:S,handleFitAll:A,viewDurationMs:M}),i.jsx(re,{labelWidth:r,rowHeight:t,signals:s,containerRef:j,canvasRef:F}),i.jsx(me,{minStartTime:$,maxScrollMs:O,scrollMs:u,setScrollMs:g}),i.jsx(de,{canvasRef:F,rowHeight:t,signals:s,recordsByOffset:R,scrollMs:u,pxPerMs:T,ySpacing:n})]})},xe={"offset-rows":"_offset-rows_nun66_1"},ye=({})=>{const[s]=U(t=>[t.oscillographicOffsetsFull,t.toggleSend],Z);console.log("вывод осцилографированных данных",s);const o=f.useMemo(()=>Object.entries(s).map(([t,n])=>({offset:Number(t),name:n.name,times:n.timePoints,values:n.values,dataType:n.dataType,typeView:n.typeView})),[s]);return i.jsxs("div",{className:xe["offset-rows"],style:{overflowX:"auto",maxWidth:"100%",padding:6},children:[o.length!==0&&i.jsx(ue,{signals:o}),o.length===0&&"Нет осцилографированных данных"]})};export{ye as default};
