import{r as m,j as d}from"./index-o3mwq-nM.js";import{u as G}from"./store-D6OyahM7.js";import{s as I}from"./shallow-DV_ax3xe.js";function J(t,s,n){const c=[];for(let l=0;l<t.times.length;l++){const a=t.times[l],g=l<t.times.length-1?t.times[l+1]:n,r=Math.max(a+s,g);c.push({time:a,endTime:r,value:t.values[l],dataType:t.dataType})}return c}function K(t,s=8){if(console.log("диапазон",t),t<=0)return 1;const n=t/s,c=Math.pow(10,Math.floor(Math.log10(n))),l=[1,2,5].map(a=>a*c);for(const a of l)if(n<=a)return a;return 10*c}const Q=({signals:t,height:s=500,rowHeight:n=20,ySpacing:c=16,defaultDurationMs:l=1,initialPxPerMs:a=20,minBlockWidthPx:g=2,labelWidth:r=140})=>{const A=m.useRef(null),k=m.useRef(null),[u,B]=m.useState(a),[w,$]=m.useState(0),S=m.useMemo(()=>t.reduce((o,e)=>{const T=e.times[e.times.length-1]??0;return Math.max(o,T+l)},0),[t,l]),O=m.useMemo(()=>{const o=new Map;for(const e of t)o.set(e.offset,J(e,l,S));return o},[t,l,S]);console.log(S);const y=Math.max(200,Math.ceil(S*u)+r);return m.useEffect(()=>{const o=k.current;if(!o)return;const e=()=>$(o.scrollLeft);return o.addEventListener("scroll",e),()=>o.removeEventListener("scroll",e)},[]),m.useEffect(()=>{const o=A.current;if(!o)return;const e=o.getContext("2d");if(!e)return;const T=window.devicePixelRatio||1;o.width=y*T,o.height=s*T,e.setTransform(T,0,0,T,0,0),e.clearRect(0,0,y,s);const C=k.current,F=C?C.clientWidth:y,j=(w-r)/u,E=(w-r+F)/u,P=K(E-j,8),N=Math.floor(j/P)*P;e.strokeStyle="#eee",e.fillStyle="#333",e.font="12px sans-serif",e.textAlign="center",e.textBaseline="top",console.log("start  in ms: ",j),console.log("firstTick: ",N);for(let f=N;f<E;f+=P){const M=r+f*u;e.beginPath(),e.moveTo(M,0),e.lineTo(M,s-20),e.stroke(),e.fillText(`${f} ms`,M,s-18)}t.forEach((f,M)=>{const i=10+M*(n+c),_=O.get(f.offset);_.forEach((x,X)=>{if(x.endTime<j||x.time>E)return;const h=r+x.time*u,p=r+x.endTime*u,b=Math.max(g,p-h);if(f.dataType==="bool"){const v=i+n,z=i,L=x.value===1?z:v;e.beginPath(),e.moveTo(h,L),e.lineTo(p,L),e.strokeStyle="#2b6cb0",e.lineWidth=2,e.stroke();const R=_[X+1];if(R&&R.value!==x.value){const q=R.value===1?z:v;e.beginPath(),e.moveTo(p,L),e.lineTo(p,q),e.stroke()}}else{const v=Math.min(5,Math.max(.5,b/2-.5));e.beginPath(),e.moveTo(h+v,i),e.lineTo(p-v,i),e.lineTo(p,i+n/2),e.lineTo(p-v,i+n),e.lineTo(h+v,i+n),e.lineTo(h,i+n/2),e.closePath(),e.fillStyle="#90cdf4",e.strokeStyle="#2b6cb0",e.fill(),e.stroke(),String(x.value).length*7<b&&(e.fillStyle="#000",e.font="11px sans-serif",e.textAlign="center",e.textBaseline="middle",e.fillText(String(x.value),h+b/2,i+n/2))}}),e.fillStyle="#444",e.font="12px sans-serif",e.textAlign="right",e.textBaseline="middle",e.fillText(f.name??`Offset ${f.offset}`,r-4,i+n/2)})},[u,w,t,O,s,n,c,g,y,r]),d.jsxs("div",{children:[d.jsxs("div",{style:{display:"flex",gap:8,marginBottom:8},children:[d.jsx("button",{onClick:()=>B(o=>Math.max(2,o/1.25)),children:"–"}),d.jsx("button",{onClick:()=>B(o=>Math.min(1e3,o*1.25)),children:"+"}),d.jsxs("div",{children:["px/ms: ",u.toFixed(1)]})]}),d.jsx("div",{ref:k,style:{width:"100%",overflow:"auto",border:"1px solid #ddd"},children:d.jsx("canvas",{ref:A,style:{width:y,height:"auto"}})})]})},U={"offset-rows":"_offset-rows_nun66_1"},W=({})=>{const[t]=G(n=>[n.oscillographicOffsets,n.toggleSend],I),s=m.useMemo(()=>Object.entries(t).map(([n,c])=>({offset:Number(n),name:c.name,times:c.timePoints,values:c.values,dataType:c.dataType})),[t]);return d.jsxs("div",{className:U["offset-rows"],style:{overflowX:"auto",maxWidth:"100%",padding:6},children:[s.length!==0&&d.jsx(Q,{signals:s}),s.length===0&&"Нет осцилографированных данных"]})};export{W as default};
