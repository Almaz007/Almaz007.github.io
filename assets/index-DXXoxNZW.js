import{r as c,j as n}from"./index-tdPgJAJf.js";import{u as G}from"./store-BnBVGmwZ.js";import{s as J}from"./shallow-CiuIP7wf.js";function K(s,a,o){const f=[];for(let d=0;d<s.times.length;d++){const x=s.times[d],S=d<s.times.length-1?s.times[d+1]:o,k=Math.max(x+a,S);f.push({time:x,endTime:k,value:s.values[d],dataType:s.dataType})}return f}function Q(s,a=8){if(s<=0)return 1;const o=s/a,f=Math.pow(10,Math.floor(Math.log10(o))),d=[1,2,5].map(x=>x*f);for(const x of d)if(o<=x)return x;return 10*f}const U=({signals:s,height:a=500,rowHeight:o=20,ySpacing:f=16,defaultDurationMs:d=1,initialPxPerMs:x=20,minBlockWidthPx:S=2,labelWidth:k=140})=>{const W=c.useRef(null),R=c.useRef(null),N=c.useRef(null),[l,E]=c.useState(x),[i,v]=c.useState(0),[T,X]=c.useState(1e3);c.useEffect(()=>{const t=R.current;if(!t)return;const e=()=>X(t.clientWidth);e();const r=new ResizeObserver(e);return r.observe(t),()=>r.disconnect()},[]);const M=c.useMemo(()=>s.reduce((t,e)=>{const r=e.times[e.times.length-1]??0;return Math.max(t,r+d)},0),[s,d]),$=c.useMemo(()=>s.reduce((t,e)=>{const r=e.times[0]??0;return Math.min(t,r)},s[0].times[0]),[s,d]);c.useEffect(()=>{v($)},[s]);const m=T/l,u=Math.max(0,M-m);c.useEffect(()=>{i>u&&v(u)},[u,i]);const z=c.useMemo(()=>{const t=new Map;for(const e of s)t.set(e.offset,K(e,d,M));return t},[s,d,M]);c.useEffect(()=>{const t=W.current;if(!t)return;const e=t.getContext("2d");if(!e)return;const r=window.devicePixelRatio||1;t.width=T*r,t.height=a*r,e.setTransform(r,0,0,r,0,0),e.clearRect(0,0,T,a);const w=i,C=i+m;s.forEach((y,P)=>{const p=10+P*(o+f),F=z.get(y.offset);F.forEach((h,Y)=>{if(h.endTime<w||h.time>C)return;const j=(h.time-w)*l,g=(h.endTime-w)*l,L=Math.max(S,g-j);if(y.dataType==="bool"){const b=p+o,B=p,O=h.value===1?B:b;e.beginPath(),e.moveTo(j,O),e.lineTo(g,O),e.strokeStyle="#2b6cb0",e.lineWidth=2,e.stroke();const A=F[Y+1];if(A&&A.value!==h.value){const q=A.value===1?B:b;e.beginPath(),e.moveTo(g,O),e.lineTo(g,q),e.stroke()}}else{const b=Math.min(5,Math.max(.5,L/2-.5));e.beginPath(),e.moveTo(j+b,p),e.lineTo(g-b,p),e.lineTo(g,p+o/2),e.lineTo(g-b,p+o),e.lineTo(j+b,p+o),e.lineTo(j,p+o/2),e.closePath(),e.fillStyle="#90cdf4",e.strokeStyle="#2b6cb0",e.fill(),e.stroke(),String(h.value).length*7<L&&(e.fillStyle="#000",e.font="11px sans-serif",e.textAlign="center",e.textBaseline="middle",e.fillText(String(h.value),j+L/2,p+o/2))}})})},[l,i,s,z,a,o,f,S,T,m,M]),c.useEffect(()=>{const t=R.current;if(!t)return;const e=()=>{const r=t.scrollLeft/l;Math.abs(r-i)>.1&&v(Math.min(u,Math.max(0,r)))};return t.addEventListener("scroll",e,{passive:!0}),()=>t.removeEventListener("scroll",e)},[l,u,i]),c.useEffect(()=>{const t=R.current;if(!t)return;const e=i*l;Math.abs(t.scrollLeft-e)>1&&(t.scrollLeft=e)},[i,l]);const _=()=>{v(t=>Math.max(0,t-m*.2))},I=()=>{v(t=>Math.min(u,t+m*.2))},Z=()=>{if(M<=0)return;const t=T/M;E(Math.max(2,Math.min(1e3,t))),v(0)},V=c.useMemo(()=>{const t=i,e=i+m,r=Q(m,8),w=Math.floor(t/r)*r,C=[];for(let y=w;y<=e+r/2;y+=r){const P=(y-t)*l;C.push({time:y,x:P})}return C},[i,m,l]);return n.jsxs("div",{style:{fontFamily:"sans-serif",display:"flex",flexDirection:"column"},children:[n.jsxs("div",{style:{display:"flex",gap:8,marginBottom:12,flexWrap:"wrap",alignItems:"center"},children:[n.jsx("button",{onClick:()=>E(t=>Math.max(2,t/1.25)),style:{padding:"6px 12px"},children:"Zoom Out (–)"}),n.jsx("button",{onClick:()=>E(t=>Math.min(1e3,t*1.25)),style:{padding:"6px 12px"},children:"Zoom In (+)"}),n.jsx("button",{onClick:Z,style:{padding:"6px 12px"},children:"Fit All"}),n.jsxs("div",{children:["Scale: ",l.toFixed(2)," px/ms"]}),n.jsxs("div",{children:["View: ",m.toFixed(1)," ms"]}),n.jsxs("div",{children:["Pos: ",i.toFixed(1)," ms"]})]}),n.jsx("div",{style:{display:"flex",flexDirection:"column",border:"1px solid #ddd",borderRadius:4},children:n.jsxs("div",{style:{display:"flex"},children:[n.jsx("div",{style:{width:k,backgroundColor:"#fafafa",borderRight:"1px solid #eee",display:"flex",flexDirection:"column",justifyContent:"flex-start",paddingTop:10,gap:"16px"},children:s.map(t=>n.jsx("div",{style:{height:o,lineHeight:`${o}px`,textAlign:"right",paddingRight:8,color:"#444",fontSize:"12px",fontWeight:"normal",whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:t.name??`Offset ${t.offset}`},t.offset))}),n.jsxs("div",{style:{width:"100%"},children:[n.jsx("div",{style:{width:"100%",overflow:"hidden",height:30,backgroundColor:"#fafafa",borderBottom:"1px solid #eee",position:"relative",paddingLeft:k},ref:N,children:V.map(t=>n.jsxs("div",{style:{position:"absolute",left:t.x,top:0,transform:"translateX(-50%)",textAlign:"center",fontSize:"11px",color:"#555",whiteSpace:"nowrap"},children:[n.jsx("div",{style:{position:"absolute",bottom:-8,left:"50%",transform:"translateX(-50%)",width:1,height:8,backgroundColor:"#ccc"}}),t.time," ms"]},t.time))}),n.jsx("div",{ref:R,style:{flex:1,overflowX:"auto",overflowY:"hidden",height:a,position:"relative",backgroundColor:"#fff"},children:n.jsx("canvas",{ref:W,style:{display:"block",height:a,width:"100%"}})})]})]})}),n.jsx("div",{style:{marginTop:12},children:n.jsx("input",{type:"range",min:0,max:u*l,step:1,value:i*l,onChange:t=>v(Number(t.target.value)/l),style:{width:"100%",height:12,borderRadius:6,background:`linear-gradient(to right, #3182ce 0%, #3182ce ${u>0?i*l/(u*l)*100:0}%, #e2e8f0 ${u>0?i*l/(u*l)*100:0}%, #e2e8f0 100%)`,outline:"none",WebkitAppearance:"none",appearance:"none",cursor:"pointer"}})}),n.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginTop:8},children:[n.jsx("button",{onClick:_,disabled:i<=0,style:{padding:"4px 16px",opacity:i<=0?.5:1},children:"◀◀"}),n.jsx("button",{onClick:I,disabled:i>=u,style:{padding:"4px 16px",opacity:i>=u?.5:1},children:"▶▶"})]})]})},D={"offset-rows":"_offset-rows_nun66_1"},ne=({})=>{const[s]=G(o=>[o.oscillographicOffsets,o.toggleSend],J),a=c.useMemo(()=>Object.entries(s).map(([o,f])=>({offset:Number(o),name:f.name,times:f.timePoints,values:f.values,dataType:f.dataType})),[s]);return console.log("Данные на странице анализатора: ",a),n.jsxs("div",{className:D["offset-rows"],style:{overflowX:"auto",maxWidth:"100%",padding:6},children:[a.length!==0&&n.jsx(U,{signals:a}),a.length===0&&"Нет осцилографированных данных"]})};export{ne as default};
