import{r as v,j as a}from"./index-CTcq2oam.js";import{u as K}from"./store-DOuGKdhk.js";import{s as Q}from"./shallow-BxbNKkIL.js";function U(o,n,t){const s=[];for(let l=0;l<o.times.length;l++){const c=o.times[l],C=l<o.times.length-1?o.times[l+1]:t,S=Math.max(c+n,C);s.push({time:c,endTime:S,value:o.values[l],dataType:o.dataType})}return s}function Z(o,n=8){if(o<=0)return 1;const t=o/n,s=Math.pow(10,Math.floor(Math.log10(t))),l=[1,2,5].map(c=>c*s);for(const c of l)if(t<=c)return c;return 10*s}const D={"main-block":"_main-block_4w5ja_3"},H=()=>{const o=v.useRef(null),[n,t]=v.useState(1e3);return v.useEffect(()=>{const s=o.current;if(!s)return;const l=()=>t(s.clientWidth);l();const c=new ResizeObserver(l);return c.observe(s),()=>c.disconnect()},[]),{containerWidth:n,containerRef:o}},ee=(o,n,t,s,l,c,C)=>{const{containerWidth:S,containerRef:Y}=H(),[V,$]=v.useState(null),w=v.useRef(null),[x,F]=v.useState(o),[p,P]=v.useState(0),E=v.useMemo(()=>n.reduce((i,e)=>{const j=e.times[e.times.length-1]??0;return Math.max(i,j)},0),[n]),W=v.useMemo(()=>{const i=n.map(e=>e.times[0]).filter(Boolean);return i.length?Math.min(...i):0},[n]),_=S/x,L=Math.ceil(Math.max(0,E-_));v.useEffect(()=>{p>L&&P(L),p<W&&P(W)},[L,p]);const O=v.useMemo(()=>{const i=new Map;for(const e of n)i.set(e.offset,U(e,c,E));return i},[n,c,E]);return v.useEffect(()=>{const i=w.current;if(!i)return;const e=i.getContext("2d");if(!e)return;const j=window.devicePixelRatio||1;i.width=S*j,i.height=s*j,e.setTransform(j,0,0,j,0,0),e.clearRect(0,0,S,s);const d=p,k=p+_,R=Z(k-d,8),z=Math.floor(d/R)*R;e.strokeStyle="#eee",e.fillStyle="#333",e.font="12px sans-serif",e.textAlign="center",e.textBaseline="top";for(let y=z;y<k;y+=R){const g=(y-d)*x;e.beginPath(),e.moveTo(g,0),e.lineTo(g,s-20),e.stroke(),e.fillText(`${y} ms`,g,s-18)}n.forEach((y,g)=>{const b=10+g*(t+l),f=O.get(y.offset);if(y.dataType==="bool")f.forEach((r,m)=>{if(r.endTime<d||r.time>k)return;const u=(r.time-d)*x,M=(r.endTime-d)*x,h=b,N=b+t,T=r.value===1?h:N;e.beginPath(),e.moveTo(u,T),e.lineTo(M,T),e.strokeStyle="#2b6cb0",e.lineWidth=2,e.stroke();const A=f[m+1];if(A&&A.value!==r.value){const I=A.value===1?h:N;e.beginPath(),e.moveTo(M,T),e.lineTo(M,I),e.stroke()}});else if(y.dataType==="analog"){if(f.length===0)return;const r=f.findIndex(T=>T.time>=d),m=f.findIndex(T=>T.time>k);let u=[];if(r===-1?u=[f[f.length-2],f[f.length-1]]:m===-1?u=f.slice(Math.max(0,r-1)):u=f.slice(Math.max(0,r-1),m+1),u.length<2)return;const M=u.map(T=>Number(T.value)),h=Math.min(...M),N=Math.max(...M);e.beginPath(),e.strokeStyle="#e53e3e",e.lineWidth=2,u.forEach((T,A)=>{const I=(T.time-d)*x,J=N===h?.5:(Number(T.value)-h)/(N-h),q=b+t-J*t;A===0?e.moveTo(I,q):e.lineTo(I,q)}),e.stroke()}else f.forEach(r=>{if(r.endTime<d||r.time>k)return;const m=(r.time-d)*x,u=(r.endTime-d)*x,M=Math.max(C,u-m),h=Math.min(5,Math.max(.5,M/2-.5));e.beginPath(),e.moveTo(m+h,b),e.lineTo(u-h,b),e.lineTo(u,b+t/2),e.lineTo(u-h,b+t),e.lineTo(m+h,b+t),e.lineTo(m,b+t/2),e.closePath(),e.fillStyle="#90cdf4",e.strokeStyle="#2b6cb0",e.fill(),e.stroke(),String(r.value).length*7<M&&(e.fillStyle="#000",e.font="11px sans-serif",e.textAlign="center",e.textBaseline="middle",e.fillText(String(r.value),m+M/2,b+t/2))})})},[x,p,n,s,t,l,S,_,O]),v.useEffect(()=>{const i=w.current;if(!i)return;const e=d=>{const k=i.getBoundingClientRect(),R=d.clientX-k.left,z=d.clientY-k.top;let y=!1;n.forEach((g,b)=>{const f=10+b*(t+l);O.get(g.offset).forEach(m=>{const u=(m.time-p)*x,M=(m.endTime-p)*x,h=f,N=f+t;R>=u&&R<=M&&z>=h&&z<=N&&($({x:d.clientX,y:d.clientY,content:`offset: ${g.offset}
start: ${m.time} ms
end: ${m.endTime} ms
value: ${m.value}`}),y=!0)})}),y||$(null)},j=()=>$(null);return i.addEventListener("mousemove",e),i.addEventListener("mouseleave",j),()=>{i.removeEventListener("mousemove",e),i.removeEventListener("mouseleave",j)}},[n,x,p,t,l,O]),{canvasRef:w,pxPerMs:x,scrollMs:p,setScrollMs:P,setPxPerMs:F,maxEndTime:E,maxScrollMs:L,minStartTime:W,containerRef:Y,handleFitAll:()=>{E<=0||(F(20),P(0))},viewDurationMs:_,tooltip:V}},X={"control-panel":"_control-panel_c31wo_3","control-btn":"_control-btn_c31wo_29"},te=({viewDurationMs:o,scrollMs:n,pxPerMs:t,setPxPerMs:s,handleFitAll:l})=>a.jsxs("div",{className:X["control-panel"],children:[a.jsx("button",{onClick:()=>s(c=>Math.max(15,Math.ceil(c/1.25))),className:X["control-btn"],children:"Отдалить (–)"}),a.jsx("button",{onClick:()=>s(c=>Math.min(100,Math.ceil(c*1.25))),className:X["control-btn"],children:"Приблизить (+)"}),a.jsx("button",{onClick:l,className:X["control-btn"],children:"Сбросить"}),a.jsxs("div",{children:["Пикселей на мс: ",t.toFixed(2)," px/ms"]}),a.jsxs("div",{children:["Cколько мс: ",o.toFixed(1)," ms"]}),a.jsxs("div",{children:["Стартовая позиция в мс: ",n.toFixed(1)," ms"]})]}),ne="_labels_2x3kd_15",se="_canvas_2x3kd_57",B={"signal-tap-content":"_signal-tap-content_2x3kd_3",labels:ne,"signal-label":"_signal-label_2x3kd_29","canvas-wrapper":"_canvas-wrapper_2x3kd_57",canvas:se},oe=({labelWidth:o,rowHeight:n,signals:t,containerRef:s,canvasRef:l})=>a.jsx("div",{className:B["signal-tap-content"],children:a.jsxs("div",{style:{display:"flex",gap:"20px"},children:[a.jsx("div",{style:{width:o},className:B.labels,children:t.map(c=>a.jsx("div",{style:{height:n,lineHeight:`${n}px`},className:B["signal-label"],children:c.name??`Offset ${c.offset}`},c.offset))}),a.jsx("div",{style:{width:"100%"},children:a.jsx("div",{ref:s,className:B["canvas-wrapper"],children:a.jsx("canvas",{ref:l,className:B.canvas})})})]})}),le="_slider_1mjjb_3",G={"slider-container":"_slider-container_1mjjb_3",slider:le},ce=({minStartTime:o,maxScrollMs:n,scrollMs:t,setScrollMs:s})=>a.jsx("div",{className:G["slider-container"],children:a.jsx("input",{type:"range",min:o,max:n,step:1,value:t,onChange:l=>s(Number(l.target.value)),className:G.slider})}),ae=({signals:o,height:n=500,rowHeight:t=20,ySpacing:s=16,defaultDurationMs:l=1,initialPxPerMs:c=20,minBlockWidthPx:C=2,labelWidth:S=140})=>{const{canvasRef:Y,containerRef:V,pxPerMs:$,scrollMs:w,setScrollMs:x,setPxPerMs:F,minStartTime:p,handleFitAll:P,maxScrollMs:E,viewDurationMs:W,tooltip:_}=ee(c,o,t,n,s,l,C);return a.jsxs("div",{className:D["main-block"],children:[a.jsx(te,{scrollMs:w,pxPerMs:$,setPxPerMs:F,handleFitAll:P,viewDurationMs:W}),a.jsx(oe,{labelWidth:S,rowHeight:t,signals:o,containerRef:V,canvasRef:Y}),a.jsx(ce,{minStartTime:p,maxScrollMs:E,scrollMs:w,setScrollMs:x}),_&&a.jsx("div",{style:{position:"fixed",top:_.y+10,left:_.x+10,background:"rgba(0,0,0,0.8)",color:"white",padding:"4px 8px",borderRadius:"4px",fontSize:"12px",whiteSpace:"pre-line",pointerEvents:"none",zIndex:1e3},children:_.content})]})},ie={"offset-rows":"_offset-rows_nun66_1"},ue=({})=>{const[o]=K(t=>[t.oscillographicOffsets,t.toggleSend],Q),n=v.useMemo(()=>Object.entries(o).map(([t,s])=>({offset:Number(t),name:s.name,times:s.timePoints,values:s.values,dataType:s.dataType})),[o]);return a.jsxs("div",{className:ie["offset-rows"],style:{overflowX:"auto",maxWidth:"100%",padding:6},children:[n.length!==0&&a.jsx(ae,{signals:n}),n.length===0&&"Нет осцилографированных данных"]})};export{ue as default};
