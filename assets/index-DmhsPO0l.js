import{r as u,j as n}from"./index-B0Ay5m52.js";import{u as Q}from"./store-BBCztm3Y.js";import{s as U}from"./shallow-o7oRt2SV.js";function Z(r,f=1,l){const c=[],p=r.times.length;for(let m=0;m<p;m++){const z=r.times[m];let x=m<p-1?r.times[m+1]:void 0;x===void 0&&l!==void 0&&(x=l),x=x??z+f;let y=x-z;y<=0&&(y=f),c.push({time:z,offset:r.offset,value:r.values[m],duration:y,endTime:x,dataType:r.dataType})}return c}function D(r,f=8){if(r<=0)return 1;const l=r/f,c=Math.pow(10,Math.floor(Math.log10(l))),p=[1,2,5].map(m=>m*c);for(const m of p)if(l<=m)return m;return 10*c}const H=({signals:r,initialPxPerMs:f=20,minBlockWidthPx:l=2,blockHeight:c=18,ySpacing:p=8,leftMargin:m=60,rightMargin:z=20,topMargin:x=8,defaultDurationMs:y=1,showGrid:W=!0,labelWidth:A=140})=>{const P=u.useMemo(()=>r.reduce((e,t)=>{const s=t.times.length-1;if(s<0)return e;const i=t.times[s]+y;return Math.max(e,i)},0),[r,y]),$=u.useMemo(()=>r.flatMap(e=>Z(e,y,P)),[r,y,P]),g=u.useMemo(()=>$.length?Math.min(...$.map(e=>e.time)):0,[$]),C=Math.max(1,P-g),S=u.useMemo(()=>{const e=Array.from(new Set(r.map(t=>t.offset)));return e.sort((t,s)=>t-s),e},[r]),Y=S.length?Math.max(...S):0,k=u.useMemo(()=>{const e=new Map;for(const t of $){const s=e.get(t.offset)??[];s.push(t),e.set(t.offset,s)}for(const t of e.values())t.sort((s,i)=>s.time-i.time);return e},[$]),q=u.useMemo(()=>{if(typeof document>"u")return A;try{const t=document.createElement("canvas").getContext("2d");if(!t)return A;t.font="12px Inter, Roboto, system-ui, sans-serif";let s=0;for(const a of r){const b=(a==null?void 0:a.name)??`Offset ${a.offset}`,o=t.measureText(b).width;o>s&&(s=o)}return Math.ceil(s+16)}catch{return A}},[r,A]),G=Math.max(A,q),O=m+G,[v,R]=u.useState(f),[w,L]=u.useState(null),J=Math.max(200,Math.ceil(C*v)+O+z+2),N=(S.length||Y+1)*(c+p)+x+40,_=u.useRef(null);u.useEffect(()=>{const e=_.current;if(!e)return;const t=s=>{s.preventDefault();const i=s.deltaY<0?1.1:1/1.1;R(a=>Math.max(6,Math.min(1e3,a*i)))};return e.addEventListener("wheel",t,{passive:!1}),()=>e.removeEventListener("wheel",t)},[]);const V=D(C,8),K=5,F=e=>{var s;const t=(s=_.current)==null?void 0:s.getBoundingClientRect();return t?{x:e.clientX-t.left,y:e.clientY-t.top}:{x:0,y:0}};return n.jsxs("div",{style:{fontFamily:"Inter, Roboto, system-ui, sans-serif"},children:[n.jsxs("div",{style:{display:"flex",gap:12,alignItems:"center",marginBottom:8},children:[n.jsxs("div",{style:{display:"flex",gap:6,alignItems:"center"},children:[n.jsx("button",{onClick:()=>R(e=>Math.max(6,e/1.25)),children:"–"}),n.jsx("input",{type:"range",min:15,max:400,value:v,onChange:e=>R(Number(e.target.value))}),n.jsx("button",{onClick:()=>R(e=>Math.min(1e3,e*1.25)),children:"+"})]}),n.jsxs("div",{style:{color:"#333"},children:["px / ms: ",n.jsx("b",{children:v.toFixed(1)})]}),n.jsxs("div",{style:{color:"#666"},children:["time span:"," ",n.jsxs("b",{children:[g," — ",Math.ceil(P)," ms"]})]}),n.jsxs("div",{style:{color:"#666"},children:["records: ",n.jsx("b",{children:$.length})]})]}),n.jsx("div",{style:{overflow:"auto",border:"1px solid #e2e8f0",padding:6},children:n.jsxs("svg",{ref:_,width:J,height:N,style:{background:"#fff"},children:[W&&n.jsx("g",{children:Array.from({length:Math.ceil(C/V)+2}).map((e,t)=>{const s=t*V,i=g+s,a=O+s*v;return n.jsxs("g",{children:[n.jsx("line",{x1:a,y1:x,x2:a,y2:N-28,stroke:"#eee",strokeDasharray:"2,2"}),n.jsxs("text",{x:a,y:N-10,fontSize:11,textAnchor:"middle",fill:"#333",children:[i," ms"]})]},t)})}),S.map((e,t)=>{const s=r.find(b=>b.offset===e),i=x+t*(c+p)+c/1.2,a=(s==null?void 0:s.name)??`Offset ${e}`;return n.jsxs("text",{x:8,y:i,fontSize:12,fill:"#444",children:[n.jsx("title",{children:a}),a]},e)}),S.map(e=>{var b;const t=k.get(e)??[],s=S.indexOf(e),i=x+s*(c+p);return((b=r.find(o=>o.offset===e))==null?void 0:b.dataType)==="bool"?n.jsx("g",{children:t.map((o,d)=>{const j=O+(o.time-g)*v,M=O+(o.endTime-g)*v,h=Math.max(l,M-j),X=i+c,B=i,T=o.value===1?B:X;return n.jsxs("g",{children:[n.jsx("line",{x1:j,y1:T,x2:j+h,y2:T,stroke:"#2b6cb0",strokeWidth:2,onMouseMove:E=>{const I=F(E);L({x:I.x,y:I.y,text:`Offset: ${e}
Value: ${o.value}
Time: ${o.time} — ${o.endTime}`})},onMouseLeave:()=>L(null)}),d<t.length-1&&t[d+1].value!==o.value&&n.jsx("line",{x1:j+h,y1:T,x2:j+h,y2:t[d+1].value===1?B:X,stroke:"#2b6cb0",strokeWidth:2,onMouseMove:E=>{const I=F(E);L({x:I.x,y:I.y,text:`Transition at ${o.endTime} ms
${o.value} → ${t[d+1].value}`})},onMouseLeave:()=>L(null)}),n.jsx("rect",{x:j,y:i,width:Math.max(4,h),height:c,fill:"transparent"})]},`b-${e}-${o.time}`)})},`bool-row-${e}`):n.jsx("g",{children:t.map(o=>{const d=O+(o.time-g)*v,j=O+(o.endTime-g)*v,M=Math.max(l,j-d),h=Math.min(K,Math.max(.5,M/2-.5)),X=[[d+h,i],[d+M-h,i],[d+M,i+c/2],[d+M-h,i+c],[d+h,i+c],[d,i+c/2]].map(T=>T.join(",")).join(" "),B=String(o.value).length*7+4<M;return n.jsxs("g",{children:[n.jsx("polygon",{points:X,fill:"#90cdf4",stroke:"#2b6cb0",onMouseMove:T=>{const E=F(T);L({x:E.x,y:E.y,text:`Offset: ${e}
Value: ${o.value}
Time: ${o.time} — ${o.endTime}`})},onMouseLeave:()=>L(null)}),B&&n.jsx("text",{x:d+M/2,y:i+c/2+4,fontSize:11,textAnchor:"middle",fill:"#000",children:o.value})]},`n-${e}-${o.time}`)})},`row-n-${e}`)}),w&&n.jsxs("g",{pointerEvents:"none",children:[n.jsx("rect",{x:w.x+10,y:w.y+10,rx:4,ry:4,fill:"#000",opacity:.85,width:220,height:56}),n.jsx("text",{x:w.x+14,y:w.y+26,fontSize:11,fill:"#fff",children:w.text.split(`
`).map((e,t)=>n.jsx("tspan",{x:w.x+14,dy:t===0?0:14,children:e},t))})]})]})})]})},ee={"offset-rows":"_offset-rows_nun66_1"},oe=({})=>{const[r]=Q(l=>[l.oscillographicOffsets,l.toggleSend],U),f=u.useMemo(()=>Object.entries(r).map(([l,c])=>({offset:Number(l),name:c.name,times:c.timePoints,values:c.values,dataType:c.dataType})),[r]);return n.jsxs("div",{className:ee["offset-rows"],style:{overflowX:"auto",maxWidth:"100%",padding:6},children:[f.length!==0&&n.jsx(H,{signals:f}),f.length===0&&"Нет осцилографированных данных"]})};export{oe as default};
