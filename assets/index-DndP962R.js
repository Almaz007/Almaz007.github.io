import{r as u,j as i}from"./index-CBoGlCcz.js";import{u as K}from"./store-C-vFn5v_.js";import{s as Q}from"./shallow-BdsKm1Xc.js";function U(o,s,t){const n=[];for(let c=0;c<o.times.length;c++){const l=o.times[c],w=c<o.times.length-1?o.times[c+1]:t,x=Math.max(l+s,w);n.push({time:l,endTime:x,value:o.values[c],dataType:o.dataType})}return n}function Z(o,s=8){if(o<=0)return 1;const t=o/s,n=Math.pow(10,Math.floor(Math.log10(t))),c=[1,2,5].map(l=>l*n);for(const l of c)if(t<=l)return l;return 10*n}const D={"main-block":"_main-block_4w5ja_3"},H=()=>{const o=u.useRef(null),[s,t]=u.useState(1e3);return u.useEffect(()=>{const n=o.current;if(!n)return;const c=()=>t(n.clientWidth);c();const l=new ResizeObserver(c);return l.observe(n),()=>l.disconnect()},[]),{containerWidth:s,containerRef:o}},ee=(o,s,t,n,c,l=1,w)=>{const{containerWidth:x,containerRef:R}=H(),T=u.useRef(null),[m,S]=u.useState(o),[f,g]=u.useState(0),y=u.useMemo(()=>s.reduce((v,e)=>{const P=e.times[e.times.length-1]??0;return Math.max(v,P+l)},0),[s,l]),C=u.useMemo(()=>{const v=s.map(e=>e.times[0]).filter(Boolean);return v.length?Math.min(...v):0},[s]),k=x/m,E=Math.ceil(Math.max(0,y-k));console.log(y),u.useEffect(()=>{f>E&&g(E),f<C&&g(C)},[E,f]);const W=u.useMemo(()=>{const v=new Map;for(const e of s)v.set(e.offset,U(e,l,y));return v},[s,l,y]);return u.useEffect(()=>{const v=T.current;if(!v)return;const e=v.getContext("2d");if(!e)return;const P=window.devicePixelRatio||1;v.width=x*P,v.height=n*P,e.setTransform(P,0,0,P,0,0),e.clearRect(0,0,x,n);const d=f,N=f+k,F=Z(N-d,8),G=Math.floor(d/F)*F;e.strokeStyle="#eee",e.fillStyle="#333",e.font="12px sans-serif",e.textAlign="center",e.textBaseline="top";for(let $=G;$<N;$+=F){const L=($-d)*m;e.beginPath(),e.moveTo(L,0),e.lineTo(L,n-20),e.stroke(),e.fillText(`${$} ms`,L,n-18)}s.forEach(($,L)=>{const M=10+L*(t+c),h=W.get($.offset);if($.dataType==="bool")h.forEach((r,_)=>{if(r.endTime<d||r.time>N)return;const p=(r.time-d)*m,a=(r.endTime-d)*m,j=M,A=M+t,B=r.value===1?j:A;e.beginPath(),e.moveTo(p,B),e.lineTo(a,B),e.strokeStyle="#2b6cb0",e.lineWidth=2,e.stroke();const b=h[_+1];if(b&&b.value!==r.value){const X=b.value===1?j:A;e.beginPath(),e.moveTo(a,B),e.lineTo(a,X),e.stroke()}});else if($.dataType==="analog"){if(h.length===0)return;const r=h.findIndex(b=>b.time>=d),_=h.findIndex(b=>b.time>N);let p=[];if(r===-1?p=[h[h.length-2],h[h.length-1]]:_===-1?p=h.slice(Math.max(0,r-1)):p=h.slice(Math.max(0,r-1),_+1),p.length<2)return;const a=[...p];a[0].time>d&&a.unshift({...a[0],time:d}),a[a.length-1].time<N&&a.push({...a[a.length-1],time:N});const j=a.map(b=>Number(b.value)),A=Math.min(...j),B=Math.max(...j);e.beginPath(),e.strokeStyle="#e53e3e",e.lineWidth=2,a.forEach((b,X)=>{const Y=(b.time-d)*m,J=B===A?.5:(Number(b.value)-A)/(B-A),V=M+t-J*t;X===0?e.moveTo(Y,V):e.lineTo(Y,V)}),e.stroke()}else h.forEach(r=>{if(r.endTime<d||r.time>N)return;const _=(r.time-d)*m,p=(r.endTime-d)*m,a=Math.max(w,p-_),j=Math.min(5,Math.max(.5,a/2-.5));e.beginPath(),e.moveTo(_+j,M),e.lineTo(p-j,M),e.lineTo(p,M+t/2),e.lineTo(p-j,M+t),e.lineTo(_+j,M+t),e.lineTo(_,M+t/2),e.closePath(),e.fillStyle="#90cdf4",e.strokeStyle="#2b6cb0",e.fill(),e.stroke(),String(r.value).length*7<a&&(e.fillStyle="#000",e.font="11px sans-serif",e.textAlign="center",e.textBaseline="middle",e.fillText(String(r.value),_+a/2,M+t/2))})})},[m,f,s,n,t,c,x,k,W]),{canvasRef:T,pxPerMs:m,scrollMs:f,setScrollMs:g,setPxPerMs:S,maxEndTime:y,maxScrollMs:E,minStartTime:C,containerRef:R,handleFitAll:()=>{y<=0||(S(20),g(0))},viewDurationMs:k,recordsByOffset:W}},z={"control-panel":"_control-panel_c31wo_3","control-btn":"_control-btn_c31wo_29"},te=({viewDurationMs:o,scrollMs:s,pxPerMs:t,setPxPerMs:n,handleFitAll:c})=>i.jsxs("div",{className:z["control-panel"],children:[i.jsx("button",{onClick:()=>n(l=>Math.max(15,Math.ceil(l/1.25))),className:z["control-btn"],children:"Отдалить (–)"}),i.jsx("button",{onClick:()=>n(l=>Math.min(100,Math.ceil(l*1.25))),className:z["control-btn"],children:"Приблизить (+)"}),i.jsx("button",{onClick:c,className:z["control-btn"],children:"Сбросить"}),i.jsxs("div",{children:["Пикселей на мс: ",t.toFixed(2)," px/ms"]}),i.jsxs("div",{children:["Cколько мс: ",o.toFixed(1)," ms"]}),i.jsxs("div",{children:["Стартовая позиция в мс: ",s.toFixed(1)," ms"]})]}),ne="_labels_2x3kd_15",se="_canvas_2x3kd_57",O={"signal-tap-content":"_signal-tap-content_2x3kd_3",labels:ne,"signal-label":"_signal-label_2x3kd_29","canvas-wrapper":"_canvas-wrapper_2x3kd_57",canvas:se},oe=({labelWidth:o,rowHeight:s,signals:t,containerRef:n,canvasRef:c})=>i.jsx("div",{className:O["signal-tap-content"],children:i.jsxs("div",{style:{display:"flex",gap:"20px"},children:[i.jsx("div",{style:{width:o},className:O.labels,children:t.map(l=>i.jsx("div",{style:{height:s,lineHeight:`${s}px`},className:O["signal-label"],children:l.name??`Offset ${l.offset}`},l.offset))}),i.jsx("div",{style:{width:"100%"},children:i.jsx("div",{ref:n,className:O["canvas-wrapper"],children:i.jsx("canvas",{ref:c,className:O.canvas})})})]})}),le="_slider_1mjjb_3",q={"slider-container":"_slider-container_1mjjb_3",slider:le},ce=({minStartTime:o,maxScrollMs:s,scrollMs:t,setScrollMs:n})=>i.jsx("div",{className:q["slider-container"],children:i.jsx("input",{type:"range",min:o,max:s,step:1,value:t,onChange:c=>n(Number(c.target.value)),className:q.slider})}),ie=({canvasRef:o,rowHeight:s,signals:t,recordsByOffset:n,scrollMs:c,pxPerMs:l,ySpacing:w})=>{const[x,R]=u.useState(null);return u.useEffect(()=>{const T=o.current;if(!T)return;const m=f=>{const g=T.getBoundingClientRect(),y=f.clientX-g.left,C=f.clientY-g.top;let k=!1;t.forEach((E,W)=>{const I=10+W*(s+w);n.get(E.offset).forEach(e=>{const P=(e.time-c)*l,d=(e.endTime-c)*l,N=I,F=I+s;y>=P&&y<=d&&C>=N&&C<=F&&(R({x:f.clientX,y:f.clientY,content:`offset: ${E.offset}
start: ${e.time} ms
end: ${e.endTime} ms
value: ${e.value}`}),k=!0)})}),k||R(null)},S=()=>R(null);return T.addEventListener("mousemove",m),T.addEventListener("mouseleave",S),()=>{T.removeEventListener("mousemove",m),T.removeEventListener("mouseleave",S)}},[t,l,c,s,w,n]),x&&i.jsx("div",{style:{position:"fixed",top:x.y+10,left:x.x+10,background:"rgba(0,0,0,0.8)",color:"white",padding:"4px 8px",borderRadius:"4px",fontSize:"12px",whiteSpace:"pre-line",pointerEvents:"none",zIndex:1e3},children:x.content})},ae=({signals:o,height:s=500,rowHeight:t=20,ySpacing:n=16,defaultDurationMs:c=1,initialPxPerMs:l=20,minBlockWidthPx:w=2,labelWidth:x=140})=>{const{canvasRef:R,containerRef:T,pxPerMs:m,scrollMs:S,setScrollMs:f,setPxPerMs:g,minStartTime:y,handleFitAll:C,maxScrollMs:k,viewDurationMs:E,recordsByOffset:W}=ee(l,o,t,s,n,c,w);return i.jsxs("div",{className:D["main-block"],children:[i.jsx(te,{scrollMs:S,pxPerMs:m,setPxPerMs:g,handleFitAll:C,viewDurationMs:E}),i.jsx(oe,{labelWidth:x,rowHeight:t,signals:o,containerRef:T,canvasRef:R}),i.jsx(ce,{minStartTime:y,maxScrollMs:k,scrollMs:S,setScrollMs:f}),i.jsx(ie,{canvasRef:R,rowHeight:t,signals:o,recordsByOffset:W,scrollMs:S,pxPerMs:m,ySpacing:n})]})},re={"offset-rows":"_offset-rows_nun66_1"},ue=({})=>{const[o]=K(t=>[t.oscillographicOffsets,t.toggleSend],Q),s=u.useMemo(()=>Object.entries(o).map(([t,n])=>({offset:Number(t),name:n.name,times:n.timePoints,values:n.values,dataType:n.dataType})),[o]);return i.jsxs("div",{className:re["offset-rows"],style:{overflowX:"auto",maxWidth:"100%",padding:6},children:[s.length!==0&&i.jsx(ae,{signals:s}),s.length===0&&"Нет осцилографированных данных"]})};export{ue as default};
