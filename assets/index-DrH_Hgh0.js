import{r as u,j as i}from"./index-BIjqghSP.js";import{u as K}from"./store-DrIrsYCp.js";import{s as Q}from"./shallow-D61vvQMa.js";function U(o,s,t){const n=[];for(let c=0;c<o.times.length;c++){const l=o.times[c],R=c<o.times.length-1?o.times[c+1]:t,x=Math.max(l+s,R);n.push({time:l,endTime:x,value:o.values[c],dataType:o.dataType})}return n}function Z(o,s=8){if(o<=0)return 1;const t=o/s,n=Math.pow(10,Math.floor(Math.log10(t))),c=[1,2,5].map(l=>l*n);for(const l of c)if(t<=l)return l;return 10*n}const D={"main-block":"_main-block_4w5ja_3"},H=()=>{const o=u.useRef(null),[s,t]=u.useState(1e3);return u.useEffect(()=>{const n=o.current;if(!n)return;const c=()=>t(n.clientWidth);c();const l=new ResizeObserver(c);return l.observe(n),()=>l.disconnect()},[]),{containerWidth:s,containerRef:o}},ee=(o,s,t,n,c,l=1,R)=>{const{containerWidth:x,containerRef:C}=H(),b=u.useRef(null),[m,g]=u.useState(o),[f,k]=u.useState(0),y=u.useMemo(()=>s.reduce((v,e)=>{const P=e.times[e.times.length-1]??0;return Math.max(v,P+l)},0),[s,l]),E=u.useMemo(()=>{const v=s.map(e=>e.times[0]).filter(Boolean);return v.length?Math.min(...v):0},[s]),N=x/m,M=Math.ceil(Math.max(0,y-N));console.log("signal: ",s),console.log("maxEndTime: ",y),console.log("minStartTime: ",E),console.log("maxScrollMs: ",M),u.useEffect(()=>{f>M&&k(M),f<E&&k(E)},[M,f]);const W=u.useMemo(()=>{const v=new Map;for(const e of s)v.set(e.offset,U(e,l,y));return v},[s,l,y]);return u.useEffect(()=>{const v=b.current;if(!v)return;const e=v.getContext("2d");if(!e)return;const P=window.devicePixelRatio||1;v.width=x*P,v.height=n*P,e.setTransform(P,0,0,P,0,0),e.clearRect(0,0,x,n);const d=f,w=f+N,F=Z(w-d,8),G=Math.floor(d/F)*F;e.strokeStyle="#eee",e.fillStyle="#333",e.font="12px sans-serif",e.textAlign="center",e.textBaseline="top";for(let $=G;$<w;$+=F){const L=($-d)*m;e.beginPath(),e.moveTo(L,0),e.lineTo(L,n-20),e.stroke(),e.fillText(`${$} ms`,L,n-18)}s.forEach(($,L)=>{const _=10+L*(t+c),h=W.get($.offset);if($.dataType==="bool")h.forEach((r,j)=>{if(r.endTime<d||r.time>w)return;const p=(r.time-d)*m,a=(r.endTime-d)*m,S=_,A=_+t,B=r.value===1?S:A;e.beginPath(),e.moveTo(p,B),e.lineTo(a,B),e.strokeStyle="#2b6cb0",e.lineWidth=2,e.stroke();const T=h[j+1];if(T&&T.value!==r.value){const X=T.value===1?S:A;e.beginPath(),e.moveTo(a,B),e.lineTo(a,X),e.stroke()}});else if($.dataType==="analog"){if(h.length===0)return;const r=h.findIndex(T=>T.time>=d),j=h.findIndex(T=>T.time>w);let p=[];if(r===-1?p=[h[h.length-2],h[h.length-1]]:j===-1?p=h.slice(Math.max(0,r-1)):p=h.slice(Math.max(0,r-1),j+1),p.length<2)return;const a=[...p];a[0].time>d&&a.unshift({...a[0],time:d}),a[a.length-1].time<w&&a.push({...a[a.length-1],time:w});const S=a.map(T=>Number(T.value)),A=Math.min(...S),B=Math.max(...S);e.beginPath(),e.strokeStyle="#e53e3e",e.lineWidth=2,a.forEach((T,X)=>{const Y=(T.time-d)*m,J=B===A?.5:(Number(T.value)-A)/(B-A),V=_+t-J*t;X===0?e.moveTo(Y,V):e.lineTo(Y,V)}),e.stroke()}else h.forEach(r=>{if(r.endTime<d||r.time>w)return;const j=(r.time-d)*m,p=(r.endTime-d)*m,a=Math.max(R,p-j),S=Math.min(5,Math.max(.5,a/2-.5));e.beginPath(),e.moveTo(j+S,_),e.lineTo(p-S,_),e.lineTo(p,_+t/2),e.lineTo(p-S,_+t),e.lineTo(j+S,_+t),e.lineTo(j,_+t/2),e.closePath(),e.fillStyle="#90cdf4",e.strokeStyle="#2b6cb0",e.fill(),e.stroke(),String(r.value).length*7<a&&(e.fillStyle="#000",e.font="11px sans-serif",e.textAlign="center",e.textBaseline="middle",e.fillText(String(r.value),j+a/2,_+t/2))})})},[m,f,s,n,t,c,x,N,W]),{canvasRef:b,pxPerMs:m,scrollMs:f,setScrollMs:k,setPxPerMs:g,maxEndTime:y,maxScrollMs:M,minStartTime:E,containerRef:C,handleFitAll:()=>{y<=0||(g(20),k(0))},viewDurationMs:N,recordsByOffset:W}},z={"control-panel":"_control-panel_c31wo_3","control-btn":"_control-btn_c31wo_29"},te=({viewDurationMs:o,scrollMs:s,pxPerMs:t,setPxPerMs:n,handleFitAll:c})=>i.jsxs("div",{className:z["control-panel"],children:[i.jsx("button",{onClick:()=>n(l=>Math.max(15,Math.ceil(l/1.25))),className:z["control-btn"],children:"Отдалить (–)"}),i.jsx("button",{onClick:()=>n(l=>Math.min(100,Math.ceil(l*1.25))),className:z["control-btn"],children:"Приблизить (+)"}),i.jsx("button",{onClick:c,className:z["control-btn"],children:"Сбросить"}),i.jsxs("div",{children:["Пикселей на мс: ",t.toFixed(2)," px/ms"]}),i.jsxs("div",{children:["Cколько мс: ",o.toFixed(1)," ms"]}),i.jsxs("div",{children:["Стартовая позиция в мс: ",s.toFixed(1)," ms"]})]}),ne="_labels_2x3kd_15",se="_canvas_2x3kd_57",O={"signal-tap-content":"_signal-tap-content_2x3kd_3",labels:ne,"signal-label":"_signal-label_2x3kd_29","canvas-wrapper":"_canvas-wrapper_2x3kd_57",canvas:se},oe=({labelWidth:o,rowHeight:s,signals:t,containerRef:n,canvasRef:c})=>i.jsx("div",{className:O["signal-tap-content"],children:i.jsxs("div",{style:{display:"flex",gap:"20px"},children:[i.jsx("div",{style:{width:o},className:O.labels,children:t.map(l=>i.jsx("div",{style:{height:s,lineHeight:`${s}px`},className:O["signal-label"],children:l.name??`Offset ${l.offset}`},l.offset))}),i.jsx("div",{style:{width:"100%"},children:i.jsx("div",{ref:n,className:O["canvas-wrapper"],children:i.jsx("canvas",{ref:c,className:O.canvas})})})]})}),le="_slider_1mjjb_3",q={"slider-container":"_slider-container_1mjjb_3",slider:le},ce=({minStartTime:o,maxScrollMs:s,scrollMs:t,setScrollMs:n})=>i.jsx("div",{className:q["slider-container"],children:i.jsx("input",{type:"range",min:o,max:s,step:1,value:t,onChange:c=>n(Number(c.target.value)),className:q.slider})}),ie=({canvasRef:o,rowHeight:s,signals:t,recordsByOffset:n,scrollMs:c,pxPerMs:l,ySpacing:R})=>{const[x,C]=u.useState(null);return u.useEffect(()=>{const b=o.current;if(!b)return;const m=f=>{const k=b.getBoundingClientRect(),y=f.clientX-k.left,E=f.clientY-k.top;let N=!1;t.forEach((M,W)=>{const I=10+W*(s+R);n.get(M.offset).forEach(e=>{const P=(e.time-c)*l,d=(e.endTime-c)*l,w=I,F=I+s;y>=P&&y<=d&&E>=w&&E<=F&&(C({x:f.clientX,y:f.clientY,content:`offset: ${M.offset}
start: ${e.time} ms
end: ${e.endTime} ms
value: ${e.value}`}),N=!0)})}),N||C(null)},g=()=>C(null);return b.addEventListener("mousemove",m),b.addEventListener("mouseleave",g),()=>{b.removeEventListener("mousemove",m),b.removeEventListener("mouseleave",g)}},[t,l,c,s,R,n]),x&&i.jsx("div",{style:{position:"fixed",top:x.y+10,left:x.x+10,background:"rgba(0,0,0,0.8)",color:"white",padding:"4px 8px",borderRadius:"4px",fontSize:"12px",whiteSpace:"pre-line",pointerEvents:"none",zIndex:1e3},children:x.content})},ae=({signals:o,height:s=500,rowHeight:t=20,ySpacing:n=16,defaultDurationMs:c=1,initialPxPerMs:l=20,minBlockWidthPx:R=2,labelWidth:x=140})=>{const{canvasRef:C,containerRef:b,pxPerMs:m,scrollMs:g,setScrollMs:f,setPxPerMs:k,minStartTime:y,handleFitAll:E,maxScrollMs:N,viewDurationMs:M,recordsByOffset:W}=ee(l,o,t,s,n,c,R);return console.log(o),i.jsxs("div",{className:D["main-block"],children:[i.jsx(te,{scrollMs:g,pxPerMs:m,setPxPerMs:k,handleFitAll:E,viewDurationMs:M}),i.jsx(oe,{labelWidth:x,rowHeight:t,signals:o,containerRef:b,canvasRef:C}),i.jsx(ce,{minStartTime:y,maxScrollMs:N,scrollMs:g,setScrollMs:f}),i.jsx(ie,{canvasRef:C,rowHeight:t,signals:o,recordsByOffset:W,scrollMs:g,pxPerMs:m,ySpacing:n})]})},re={"offset-rows":"_offset-rows_nun66_1"},ue=({})=>{const[o]=K(t=>[t.oscillographicOffsets,t.toggleSend],Q),s=u.useMemo(()=>Object.entries(o).map(([t,n])=>({offset:Number(t),name:n.name,times:n.timePoints,values:n.values,dataType:n.dataType})),[o]);return i.jsxs("div",{className:re["offset-rows"],style:{overflowX:"auto",maxWidth:"100%",padding:6},children:[s.length!==0&&i.jsx(ae,{signals:s}),s.length===0&&"Нет осцилографированных данных"]})};export{ue as default};
