import{r as _,j as s,c as y}from"./index-DzeFnCym.js";import{u as D}from"./store-twiYqyd7.js";import{d as v}from"./helpers-fab74NUc.js";import{c as z,s as j}from"./shallow-vEXG7Jwy.js";import{B as F}from"./Button-D4XObys_.js";import{u as N}from"./store-C4C6f62k.js";import{u as C}from"./store-BhBwS6bq.js";const k="_wrapper_zxo5y_1",A="_form_zxo5y_17",B="_drag_zxo5y_29",E="_label_zxo5y_43",T="_input_zxo5y_49",$="_info_zxo5y_93",U="_btns_zxo5y_103",d={wrapper:k,form:A,drag:B,"action-title":"_action-title_zxo5y_35",label:E,input:T,"file-list":"_file-list_zxo5y_63","download-label":"_download-label_zxo5y_73",info:$,btns:U,"button-reset":"_button-reset_zxo5y_111","button-submit":"_button-submit_zxo5y_113","dnd-tile":"_dnd-tile_zxo5y_135"},S=({handleSubmit:r,title:f})=>{const[o,t]=_.useState([]),[c,l]=_.useState(!1),i=n=>{n.preventDefault(),n.target.files&&n.target.files[0]&&t([n.target.files[0]])},g=()=>{t([])},m=function(n){n.preventDefault(),l(!0)},u=function(n){n.preventDefault(),l(!1)},h=function(n){var e;n.preventDefault(),l(!1),(e=n.dataTransfer)!=null&&e.files&&n.dataTransfer.files[0]&&t([n.dataTransfer.files[0]])};return s.jsxs("div",{className:y(d.wrapper,{[d.drag]:c}),children:[s.jsx("h2",{className:d["dnd-tile"],children:f}),s.jsxs("form",{className:y(d.form),onReset:g,onDragEnter:m,onDragOver:m,onDragLeave:u,onDrop:h,children:[s.jsx("h2",{className:d["action-title"],children:"Перетащите файлы сюда"}),s.jsx("p",{children:"или"}),s.jsxs("label",{className:d.label,children:[s.jsx("span",{className:d["download-label"],children:"Загрузите файл"}),s.jsx("input",{className:d.input,type:"file",multiple:!1,onChange:i})]}),o.length>0&&s.jsxs("div",{className:d.info,children:[s.jsx("ul",{className:d["file-list"],children:s.jsx("li",{children:o[0].name})}),s.jsxs("div",{className:d.btns,children:[s.jsx("button",{className:d["button-reset"],type:"reset",children:"Отменить"}),s.jsx("button",{className:d["button-submit"],onClick:n=>r(n,o),children:"Отправить"})]})]})]})]})},W=z((r,f)=>({ws:null,status:"disconnected",error:null,messages:[],strForDownload:[],parseOscilografFile:async o=>{const{strForDownload:t}=f();let c=await o.arrayBuffer();const l=new DataView(c),i={};for(let u=0;u+16<=l.byteLength;u+=16){const h=l.getUint32(u,!0);if(h===0)return;const n=l.getUint32(u+4,!0),e=l.getUint32(u+8,!0),a=l.getUint32(u+12,!0),p=`номер: ${h}, метка: ${n}, смещение: ${e}, значение: ${a}`;t.push(p),i[e]||(i[e]={timePoints:[],values:[]}),i[e].timePoints.push(n),i[e].values.push(a)}t.push(`endPart

`),r({strForDownload:t});const g=D.getState(),m=l.byteLength===1216;if(m){const n=`dataLogicAnalyzer_${new Date().toISOString().replace("T","_").replace(/:/g,"-").split(".")[0]}.txt`;v(t.join(`
`),n,"text/plain"),r({strForDownload:[]})}g.updateOscillographicData(i,m)},connect:o=>{let{ws:t,parseOscilografFile:c,status:l}=f();t||(r({status:"connecting",error:null}),t=new WebSocket(o),r({ws:t}),t.onopen=()=>{r({error:null,status:"connected"}),console.log("WebSocket connected")},t.onmessage=async i=>{i.data instanceof Blob?(r(g=>({messages:[...g.messages,`Получен бинарный пакет ${g.messages.length+1}`]})),await c(i.data)):(console.log("Получено с сервера:",i.data),r(g=>({messages:[...g.messages,i.data.toString()]})))},t.onerror=()=>{r({error:"Connection error",status:"disconnected"})},t.onclose=()=>{console.log("WebSocket closed. Status was:",l),t=null,r({ws:null,status:"disconnected"})})},disconnect:()=>{const{ws:o}=f();o&&(o.close(),r({ws:null,status:"disconnected"}))},sendMessage:o=>{const{ws:t}=f();t&&(r(c=>({messages:[...c.messages,o]})),t.send(o))},sendFile:o=>{const{ws:t}=f();t&&(r(c=>({messages:[...c.messages,"Файл отправлен"]})),t.send(o))},sendConfig:o=>{const{ws:t}=f();t&&(r(c=>({messages:[...c.messages,"Конфиг отправлен"]})),t.send(o))}})),L="_row_q0ihq_1",O={row:L},Y=()=>{const r=C(e=>e.sendFirmware),[f,o,t,c,l,i,g]=W(e=>[e.status,e.error,e.messages,e.connect,e.disconnect,e.sendConfig,e.sendFile],j),m=N(e=>e.config,j),u=()=>{const e=new TextEncoder().encode(JSON.stringify(m));if(e.length===0){console.log("конфиг не отправлен");return}const a=new TextEncoder().encode("flexibleLogic,"),p=new Uint8Array(a.length+e.length);p.set(a,0),p.set(e,a.length),i(p)},h=async(e,a)=>{if(e.preventDefault(),!a||a.length===0)return;const p=await a[0].arrayBuffer(),w=new Uint8Array(p),x=new TextEncoder().encode("firmware,"),b=new Uint8Array(x.length+w.length);b.set(x,0),b.set(w,x.length),g(b)},n=async(e,a)=>{if(e.preventDefault(),!a||a.length===0)return;const p=await a[0].arrayBuffer();r(p)};return s.jsxs("div",{children:[s.jsx("h2",{children:"WebSocket"}),s.jsxs("p",{children:["Status: ",f," ",o&&`| Error: ${o}`]}),s.jsx("button",{onClick:()=>c("wss://int-rt.ru:3010"),children:"Подключить"}),s.jsx("br",{}),s.jsx("button",{onClick:l,children:"Отключить"}),s.jsx("div",{style:{height:"300px",overflowY:"auto",border:"1px solid blue",padding:"10px",marginTop:"10px"},children:t.map((e,a)=>s.jsx("p",{children:e},a))}),s.jsx("br",{}),s.jsxs("div",{className:O.row,children:[s.jsx(S,{handleSubmit:h,title:"Отправка прошивки по web-socket"}),s.jsx(S,{handleSubmit:n,title:"Отправка прошивки по ble"}),s.jsxs("div",{children:[s.jsx(F,{disabled:!m.scripts.length,onClick:u,text:"загрузить гибкую логику"}),s.jsx("br",{}),!m.scripts.length&&s.jsx("div",{children:"необходимо сформировать гибкую логику"})]})]})]})};export{Y as default};
