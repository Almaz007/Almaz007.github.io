import{r as a,j as n}from"./index-CZyyuwVj.js";import{u as q}from"./store-Dc4Mx0dT.js";import{s as G}from"./shallow-DyXbvbMH.js";function J(i,d,s){const f=[],p=i.times.map((l,x)=>({time:l,value:i.values[x]}));p.sort((l,x)=>l.time-x.time);for(let l=0;l<p.length;l++){const x=p[l].time,k=l<p.length-1?p[l+1].time:s,R=Math.max(x+d,k);f.push({time:x,endTime:R,value:p[l].value,dataType:i.dataType})}return f}function K(i,d=8){if(i<=0)return 1;const s=i/d,f=Math.pow(10,Math.floor(Math.log10(s))),p=[1,2,5].map(l=>l*f);for(const l of p)if(s<=l)return l;return 10*f}const Q=({signals:i,height:d=500,rowHeight:s=20,ySpacing:f=16,defaultDurationMs:p=1,initialPxPerMs:l=20,minBlockWidthPx:x=2,labelWidth:k=140})=>{const R=a.useRef(null),C=a.useRef(null),N=a.useRef(null),[c,P]=a.useState(l),[o,j]=a.useState(0),[u,X]=a.useState(1e3);a.useEffect(()=>{const t=C.current;if(!t)return;const e=()=>X(t.clientWidth);e();const r=new ResizeObserver(e);return r.observe(t),()=>r.disconnect()},[]);const T=a.useMemo(()=>i.reduce((t,e)=>{const r=e.times[e.times.length-1]??0;return Math.max(t,r+p)},0),[i,p]),m=u/c,v=Math.max(0,T-m);a.useEffect(()=>{o>v&&j(v)},[v,o]);const z=a.useMemo(()=>{const t=new Map;for(const e of i)t.set(e.offset,J(e,p,T));return t},[i,p,T]);a.useEffect(()=>{const t=R.current;if(!t)return;const e=t.getContext("2d");if(!e)return;const r=window.devicePixelRatio||1;t.width=u*r,t.height=d*r,e.setTransform(r,0,0,r,0,0),e.clearRect(0,0,u,d);const S=o,E=o+m;i.forEach((g,L)=>{const h=10+L*(s+f),F=z.get(g.offset);F.forEach((y,V)=>{if(y.endTime<S||y.time>E)return;const w=(y.time-S)*c,b=(y.endTime-S)*c,O=Math.max(x,b-w);if(g.dataType==="bool"){const M=h+s,B=h,A=y.value===1?B:M;e.beginPath(),e.moveTo(w,A),e.lineTo(b,A),e.strokeStyle="#2b6cb0",e.lineWidth=2,e.stroke();const W=F[V+1];if(W&&W.value!==y.value){const Y=W.value===1?B:M;e.beginPath(),e.moveTo(b,A),e.lineTo(b,Y),e.stroke()}}else{const M=Math.min(5,Math.max(.5,O/2-.5));e.beginPath(),e.moveTo(w+M,h),e.lineTo(b-M,h),e.lineTo(b,h+s/2),e.lineTo(b-M,h+s),e.lineTo(w+M,h+s),e.lineTo(w,h+s/2),e.closePath(),e.fillStyle="#90cdf4",e.strokeStyle="#2b6cb0",e.fill(),e.stroke(),String(y.value).length*7<O&&(e.fillStyle="#000",e.font="11px sans-serif",e.textAlign="center",e.textBaseline="middle",e.fillText(String(y.value),w+O/2,h+s/2))}})})},[c,o,i,z,d,s,f,x,u,m,T]),a.useEffect(()=>{const t=C.current;if(!t)return;const e=()=>{const r=t.scrollLeft/c;Math.abs(r-o)>.1&&j(Math.min(v,Math.max(0,r)))};return t.addEventListener("scroll",e,{passive:!0}),()=>t.removeEventListener("scroll",e)},[c,v,o]),a.useEffect(()=>{const t=C.current;if(!t)return;const e=o*c;Math.abs(t.scrollLeft-e)>1&&(t.scrollLeft=e)},[o,c]);const $=()=>{j(t=>Math.max(0,t-m*.2))},_=()=>{j(t=>Math.min(v,t+m*.2))},I=()=>{if(T<=0)return;const t=u/T;P(Math.max(2,Math.min(1e3,t))),j(0)},Z=a.useMemo(()=>{const t=o,e=o+m,r=K(m,8),S=Math.floor(t/r)*r,E=[];for(let g=S;g<=e+r/2;g+=r){const L=(g-t)*c;E.push({time:g,x:L})}return E},[o,m,c]);return n.jsxs("div",{style:{fontFamily:"sans-serif",display:"flex",flexDirection:"column"},children:[n.jsxs("div",{style:{display:"flex",gap:8,marginBottom:12,flexWrap:"wrap",alignItems:"center"},children:[n.jsx("button",{onClick:()=>P(t=>Math.max(2,t/1.25)),style:{padding:"6px 12px"},children:"Zoom Out (–)"}),n.jsx("button",{onClick:()=>P(t=>Math.min(1e3,t*1.25)),style:{padding:"6px 12px"},children:"Zoom In (+)"}),n.jsx("button",{onClick:I,style:{padding:"6px 12px"},children:"Fit All"}),n.jsxs("div",{children:["Scale: ",c.toFixed(2)," px/ms"]}),n.jsxs("div",{children:["View: ",m.toFixed(1)," ms"]}),n.jsxs("div",{children:["Pos: ",o.toFixed(1)," ms"]})]}),n.jsx("div",{style:{display:"flex",flexDirection:"column",border:"1px solid #ddd",borderRadius:4},children:n.jsxs("div",{style:{display:"flex"},children:[n.jsx("div",{style:{width:k,backgroundColor:"#fafafa",borderRight:"1px solid #eee",display:"flex",flexDirection:"column",justifyContent:"flex-start",paddingTop:10,gap:"16px"},children:i.map(t=>n.jsx("div",{style:{height:s,lineHeight:`${s}px`,textAlign:"right",paddingRight:8,color:"#444",fontSize:"12px",fontWeight:"normal",whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:t.name??`Offset ${t.offset}`},t.offset))}),n.jsxs("div",{style:{width:"100%"},children:[n.jsx("div",{style:{width:"100%",overflow:"hidden",height:30,backgroundColor:"#fafafa",borderBottom:"1px solid #eee",position:"relative",paddingLeft:k},ref:N,children:Z.map(t=>n.jsxs("div",{style:{position:"absolute",left:t.x,top:0,transform:"translateX(-50%)",textAlign:"center",fontSize:"11px",color:"#555",whiteSpace:"nowrap"},children:[n.jsx("div",{style:{position:"absolute",bottom:-8,left:"50%",transform:"translateX(-50%)",width:1,height:8,backgroundColor:"#ccc"}}),t.time," ms"]},t.time))}),n.jsx("div",{ref:C,style:{flex:1,overflowX:"auto",overflowY:"hidden",height:d,position:"relative",backgroundColor:"#fff"},children:n.jsx("canvas",{ref:R,style:{display:"block",height:d,width:"100%"}})})]})]})}),n.jsx("div",{style:{marginTop:12},children:n.jsx("input",{type:"range",min:0,max:u,step:1,value:o*c,onChange:t=>j(Number(t.target.value)/c),style:{width:"100%",height:12,borderRadius:6,background:`linear-gradient(to right, #3182ce 0%, #3182ce ${u>0?o*c/u*100:0}%, #e2e8f0 ${u>0?o*c/u*100:0}%, #e2e8f0 100%)`,outline:"none",WebkitAppearance:"none",appearance:"none",cursor:"pointer"}})}),n.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginTop:8},children:[n.jsx("button",{onClick:$,disabled:o<=0,style:{padding:"4px 16px",opacity:o<=0?.5:1},children:"◀◀"}),n.jsx("button",{onClick:_,disabled:o>=v,style:{padding:"4px 16px",opacity:o>=v?.5:1},children:"▶▶"})]})]})},U={"offset-rows":"_offset-rows_nun66_1"},te=({})=>{const[i]=q(s=>[s.oscillographicOffsets,s.toggleSend],G),d=a.useMemo(()=>Object.entries(i).map(([s,f])=>({offset:Number(s),name:f.name,times:f.timePoints,values:f.values,dataType:f.dataType})),[i]);return console.log("Данные на странице анализатора: ",d),n.jsxs("div",{className:U["offset-rows"],style:{overflowX:"auto",maxWidth:"100%",padding:6},children:[d.length!==0&&n.jsx(Q,{signals:d}),d.length===0&&"Нет осцилографированных данных"]})};export{te as default};
