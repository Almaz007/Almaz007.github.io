import{r as l,j as a}from"./index-DhmrXgrl.js";import{u as U}from"./store-CkJDDazH.js";import{s as Z}from"./shallow-MFyToQzh.js";function te(s,o,n){const t=[];for(let i=0;i<s.times.length;i++){const c=s.times[i],u=i<s.times.length-1?s.times[i+1]:n,x=Math.max(c+o,u);t.push({time:c,endTime:x,value:s.values[i],dataType:s.dataType,typeView:s.typeView})}return t}function ne(s,o=8){if(s<=0)return 1;const n=s/o,t=Math.pow(10,Math.floor(Math.log10(n))),i=[1,2,5].map(c=>c*t);for(const c of i)if(n<=c)return c;return 10*t}const se={"main-block":"_main-block_8el9a_2"},oe=()=>{const s=l.useRef(null),[o,n]=l.useState(1e3);return l.useEffect(()=>{const t=s.current;if(!t)return;const i=()=>n(t.clientWidth);i();const c=new ResizeObserver(i);return c.observe(t),()=>c.disconnect()},[]),{containerWidth:o,containerRef:s}},K=1e-6,ce=(s,o,n,t,i,c=1,u)=>{const{containerWidth:x,containerRef:R}=oe(),_=l.useRef(null),b=l.useRef(null),[d,w]=l.useState(()=>Math.max(K,s)),[j,C]=l.useState(0),[A,O]=l.useState(0);l.useEffect(()=>{w(r=>r===s?r:s)},[s]),l.useEffect(()=>{const r=()=>O(e=>e+1);return window.addEventListener("resize",r),window.addEventListener("orientationchange",r),()=>{window.removeEventListener("resize",r),window.removeEventListener("orientationchange",r)}},[]);const M=l.useMemo(()=>o.reduce((r,e)=>{const F=e.times[e.times.length-1]??0;return Math.max(r,F+c)},0),[o,c]),$=l.useMemo(()=>{const r=o.map(e=>e.times[0]).filter(e=>typeof e=="number");return r.length?Math.min(...r):0},[o]),g=d>K?x/d:1/0,I=l.useMemo(()=>Math.ceil(Math.max(0,M-g)),[M,g]);l.useEffect(()=>{C(r=>Math.min(I,Math.max($,r)))},[I,$]);const k=l.useMemo(()=>{const r=new Map;for(const e of o)r.set(e.offset,te(e,c,M));return r},[o,c,M]);l.useEffect(()=>{const r=_.current;if(!r)return;const e=r.getContext("2d");if(!e)return;const F=window.devicePixelRatio||1;r.style.width=`${x}px`,r.style.height=`${t}px`,r.width=Math.max(1,Math.round(x*F)),r.height=Math.max(1,Math.round(t*F)),e.setTransform(F,0,0,F,0,0),e.clearRect(0,0,x,t);const p=j,V=Number.isFinite(g)&&g>0?j+g:j+1,P=ne(V-p,8);if(!(P>0))return;const D=()=>{e.clearRect(0,0,x,t);const H=Math.floor(p/P)*P;e.strokeStyle="#eee",e.fillStyle="#333",e.font="12px sans-serif",e.textAlign="center",e.textBaseline="top";for(let L=H;L<V;L+=P){const B=(L-p)*d;e.beginPath(),e.moveTo(B,0),e.lineTo(B,t-20),e.stroke(),e.fillText(`${L} ms`,B,t-18)}o.forEach((L,B)=>{const S=10+B*(n+i),v=k.get(L.offset);if(!(!v||v.length===0))if(L.typeView==="line"){e.lineWidth=2,e.strokeStyle="#2b6cb0";for(let h=0;h<v.length;h++){const f=v[h];if(f.endTime<p||f.time>V)continue;const y=(f.time-p)*d,m=(f.endTime-p)*d,E=S,N=S+n,z=f.value===1?E:N;e.beginPath(),e.moveTo(y,z),e.lineTo(m,z),e.stroke();const T=v[h+1];if(T&&T.value!==f.value){const q=T.value===1?E:N;e.beginPath(),e.moveTo(m,z),e.lineTo(m,q),e.stroke()}}}else if(L.typeView==="point"){if(v.length<2)return;const h=v.findIndex(T=>T.time>=p),f=v.findIndex(T=>T.time>V);let y=[];if(h===-1&&f===-1?y=v.slice(Math.max(0,v.length-2)):h===-1?y=v.slice(0,f+1):f===-1?y=v.slice(Math.max(0,h-1)):y=v.slice(Math.max(0,h-1),f+1),y.length<2)return;const m=[...y];m[0].time>p&&m.unshift({...m[0],time:p}),m[m.length-1].time<V&&m.push({...m[m.length-1],time:V});const E=m.map(T=>Number(T.value||0)),N=Math.min(...E),z=Math.max(...E);e.beginPath(),e.strokeStyle="#2b6cb0",e.lineWidth=2,m.forEach((T,q)=>{const G=(T.time-p)*d,ee=z===N?.5:(Number(T.value)-N)/(z-N),J=S+n-ee*n;q===0?e.moveTo(G,J):e.lineTo(G,J)}),e.stroke()}else v.forEach(h=>{if(h.endTime<p||h.time>V)return;const f=(h.time-p)*d,y=(h.endTime-p)*d,m=Math.max(u,y-f),E=Math.min(5,Math.max(.5,m/2-.5));e.beginPath(),e.moveTo(f+E,S),e.lineTo(y-E,S),e.lineTo(y,S+n/2),e.lineTo(y-E,S+n),e.lineTo(f+E,S+n),e.lineTo(f,S+n/2),e.closePath(),e.fillStyle="#90cdf4",e.strokeStyle="#2b6cb0",e.fill(),e.stroke();const N=String(h.value);e.font="13px sans-serif",e.measureText(N).width+6<m&&(e.fillStyle="#000",e.textAlign="center",e.textBaseline="middle",e.fillText(N,f+m/2,S+n/2))})})};return b.current&&cancelAnimationFrame(b.current),b.current=requestAnimationFrame(D),()=>{b.current&&cancelAnimationFrame(b.current),b.current=null}},[d,j,k,t,n,i,x,u,A,g,o]);const Y=l.useCallback(()=>{M<=0||(w(20),C(()=>Math.min(I,$)))},[x,M]);return{canvasRef:_,pxPerMs:d,scrollMs:j,setScrollMs:C,setPxPerMs:w,maxEndTime:M,maxScrollMs:I,minStartTime:$,containerRef:R,handleFitAll:Y,viewDurationMs:g,recordsByOffset:k}},X={"control-panel":"_control-panel_1791d_2","control-btn":"_control-btn_1791d_15"},ie=({viewDurationMs:s,scrollMs:o,pxPerMs:n,setPxPerMs:t,handleFitAll:i})=>a.jsxs("div",{className:X["control-panel"],children:[a.jsx("button",{onClick:()=>t(c=>Math.max(15,Math.ceil(c/1.25))),className:X["control-btn"],children:"Отдалить (–)"}),a.jsx("button",{onClick:()=>t(c=>Math.min(100,Math.ceil(c*1.25))),className:X["control-btn"],children:"Приблизить (+)"}),a.jsx("button",{onClick:i,className:X["control-btn"],children:"Сбросить"}),a.jsxs("div",{children:["Пикселей на мс: ",n.toFixed(2)," px/ms"]}),a.jsxs("div",{children:["Cколько мс: ",s.toFixed(1)," ms"]}),a.jsxs("div",{children:["Стартовая позиция в мс: ",o.toFixed(1)," ms"]})]}),re="_labels_1mr8r_8",ae="_canvas_1mr8r_40",W={"signal-tap-content":"_signal-tap-content_1mr8r_2",labels:re,"signal-label":"_signal-label_1mr8r_15","canvas-wrapper":"_canvas-wrapper_1mr8r_40",canvas:ae,"view-type-change":"_view-type-change_1mr8r_76"},le=({labelWidth:s,rowHeight:o,signals:n,containerRef:t,canvasRef:i})=>{const[c]=U(u=>[u.changeViewTypeForOffset],Z);return a.jsx("div",{className:W["signal-tap-content"],children:a.jsxs("div",{style:{display:"flex",gap:"20px"},children:[a.jsx("div",{style:{width:s},className:W.labels,children:n.map(u=>a.jsxs("div",{style:{height:o,lineHeight:`${o}px`},className:W["signal-label"],children:[a.jsx("div",{children:u.name??`Offset ${u.offset}`}),a.jsx("div",{onClick:()=>c(u.offset),className:W["view-type-change"],children:"изменить"})]},u.offset))}),a.jsx("div",{style:{width:"100%"},children:a.jsx("div",{ref:t,className:W["canvas-wrapper"],children:a.jsx("canvas",{ref:i,className:W.canvas})})})]})})},me="_slider_10mso_2",Q={"slider-container":"_slider-container_10mso_2",slider:me},de=({minStartTime:s,maxScrollMs:o,scrollMs:n,setScrollMs:t})=>a.jsx("div",{className:Q["slider-container"],children:a.jsx("input",{type:"range",min:s,max:o,step:1,value:n,onChange:i=>t(Number(i.target.value)),className:Q.slider})}),fe=({canvasRef:s,rowHeight:o,signals:n,recordsByOffset:t,scrollMs:i,pxPerMs:c,ySpacing:u})=>{const[x,R]=l.useState(null);return l.useEffect(()=>{const _=s.current;if(!_)return;const b=w=>{const j=_.getBoundingClientRect(),C=w.clientX-j.left,A=w.clientY-j.top;let O=!1;n.forEach((M,$)=>{const g=10+$*(o+u);t.get(M.offset).forEach(k=>{const Y=(k.time-i)*c,r=(k.endTime-i)*c,e=g,F=g+o;C>=Y&&C<=r&&A>=e&&A<=F&&(R({x:w.clientX,y:w.clientY,content:`offset: ${M.offset}
start: ${k.time} ms
end: ${k.endTime} ms
value: ${k.value}`}),O=!0)})}),O||R(null)},d=()=>R(null);return _.addEventListener("mousemove",b),_.addEventListener("mouseleave",d),()=>{_.removeEventListener("mousemove",b),_.removeEventListener("mouseleave",d)}},[n,c,i,o,u,t]),x&&a.jsx("div",{style:{position:"fixed",top:x.y+10,left:x.x+10,background:"rgba(0,0,0,0.8)",color:"white",padding:"4px 8px",borderRadius:"4px",fontSize:"12px",whiteSpace:"pre-line",pointerEvents:"none",zIndex:1e3},children:x.content})},ue=({signals:s,height:o=500,rowHeight:n=25,ySpacing:t=16,defaultDurationMs:i=1,initialPxPerMs:c=40,minBlockWidthPx:u=2,labelWidth:x=250})=>{const{canvasRef:R,containerRef:_,pxPerMs:b,scrollMs:d,setScrollMs:w,setPxPerMs:j,minStartTime:C,handleFitAll:A,maxScrollMs:O,viewDurationMs:M,recordsByOffset:$}=ce(c,s,n,o,t,i,u);return console.log(s),a.jsxs("div",{className:se["main-block"],children:[a.jsx(ie,{scrollMs:d,pxPerMs:b,setPxPerMs:j,handleFitAll:A,viewDurationMs:M}),a.jsx(le,{labelWidth:x,rowHeight:n,signals:s,containerRef:_,canvasRef:R}),a.jsx(de,{minStartTime:C,maxScrollMs:O,scrollMs:d,setScrollMs:w}),a.jsx(fe,{canvasRef:R,rowHeight:n,signals:s,recordsByOffset:$,scrollMs:d,pxPerMs:b,ySpacing:t})]})},xe={"offset-rows":"_offset-rows_qfoc5_1"},ye=({})=>{const[s]=U(n=>[n.oscillographicOffsets,n.toggleSend],Z),o=l.useMemo(()=>Object.entries(s).map(([n,t])=>({offset:Number(n),name:t.name,times:t.timePoints,values:t.values,dataType:t.dataType,typeView:t.typeView})),[s]);return a.jsxs("div",{className:xe["offset-rows"],style:{overflowX:"auto",maxWidth:"100%",padding:6},children:[o.length!==0&&a.jsx(ue,{signals:o}),o.length===0&&"Нет осцилографированных данных"]})};export{ye as default};
