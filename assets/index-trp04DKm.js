import{r,j as l}from"./index-B0Ui_1a1.js";import{u as H}from"./store-CDbgZjVZ.js";import{s as ee}from"./shallow-CZ82ZxTi.js";function te(s,o,t){const n=[];for(let a=0;a<s.times.length;a++){const c=s.times[a],w=a<s.times.length-1?s.times[a+1]:t,f=Math.max(c+o,w);n.push({time:c,endTime:f,value:s.values[a],dataType:s.dataType})}return n}function ne(s,o=8){if(s<=0)return 1;const t=s/o,n=Math.pow(10,Math.floor(Math.log10(t))),a=[1,2,5].map(c=>c*n);for(const c of a)if(t<=c)return c;return 10*n}const se={"main-block":"_main-block_4w5ja_3"},oe=()=>{const s=r.useRef(null),[o,t]=r.useState(1e3);return r.useEffect(()=>{const n=s.current;if(!n)return;const a=()=>t(n.clientWidth);a();const c=new ResizeObserver(a);return c.observe(n),()=>c.disconnect()},[]),{containerWidth:o,containerRef:s}},K=1e-6,ce=(s,o,t,n,a,c=1,w)=>{const{containerWidth:f,containerRef:R}=oe(),T=r.useRef(null),b=r.useRef(null),[d,_]=r.useState(()=>Math.max(K,s)),[j,C]=r.useState(0),[W,O]=r.useState(0);r.useEffect(()=>{_(i=>i===s?i:s)},[s]),r.useEffect(()=>{const i=()=>O(e=>e+1);return window.addEventListener("resize",i),window.addEventListener("orientationchange",i),()=>{window.removeEventListener("resize",i),window.removeEventListener("orientationchange",i)}},[]);const y=r.useMemo(()=>o.reduce((i,e)=>{const L=e.times[e.times.length-1]??0;return Math.max(i,L+c)},0),[o,c]),$=r.useMemo(()=>{const i=o.map(e=>e.times[0]).filter(e=>typeof e=="number");return i.length?Math.min(...i):0},[o]),S=d>K?f/d:1/0,I=r.useMemo(()=>Math.ceil(Math.max(0,y-S)),[y,S]);r.useEffect(()=>{C(i=>Math.min(I,Math.max($,i)))},[I,$]);const E=r.useMemo(()=>{const i=new Map;for(const e of o)i.set(e.offset,te(e,c,y));return i},[o,c,y]);r.useEffect(()=>{const i=T.current;if(!i)return;const e=i.getContext("2d");if(!e)return;const L=window.devicePixelRatio||1;i.style.width=`${f}px`,i.style.height=`${n}px`,i.width=Math.max(1,Math.round(f*L)),i.height=Math.max(1,Math.round(n*L)),e.setTransform(L,0,0,L,0,0),e.clearRect(0,0,f,n);const v=j,z=Number.isFinite(S)&&S>0?j+S:j+1,X=ne(z-v,8);if(!(X>0))return;const U=()=>{e.clearRect(0,0,f,n);const Z=Math.floor(v/X)*X;e.strokeStyle="#eee",e.fillStyle="#333",e.font="12px sans-serif",e.textAlign="center",e.textBaseline="top";for(let F=Z;F<z;F+=X){const B=(F-v)*d;e.beginPath(),e.moveTo(B,0),e.lineTo(B,n-20),e.stroke(),e.fillText(`${F} ms`,B,n-18)}o.forEach((F,B)=>{const g=10+B*(t+a),h=E.get(F.offset);if(!(!h||h.length===0))if(F.dataType==="bool"){e.lineWidth=2,e.strokeStyle="#2b6cb0";for(let x=0;x<h.length;x++){const u=h[x];if(u.endTime<v||u.time>z)continue;const p=(u.time-v)*d,m=(u.endTime-v)*d,k=g,N=g+t,A=u.value===1?k:N;e.beginPath(),e.moveTo(p,A),e.lineTo(m,A),e.stroke();const M=h[x+1];if(M&&M.value!==u.value){const q=M.value===1?k:N;e.beginPath(),e.moveTo(m,A),e.lineTo(m,q),e.stroke()}}}else if(F.dataType==="analog"){if(h.length<2)return;const x=h.findIndex(M=>M.time>=v),u=h.findIndex(M=>M.time>z);let p=[];if(x===-1&&u===-1?p=h.slice(Math.max(0,h.length-2)):x===-1?p=h.slice(0,u+1):u===-1?p=h.slice(Math.max(0,x-1)):p=h.slice(Math.max(0,x-1),u+1),p.length<2)return;const m=[...p];m[0].time>v&&m.unshift({...m[0],time:v}),m[m.length-1].time<z&&m.push({...m[m.length-1],time:z});const k=m.map(M=>Number(M.value||0)),N=Math.min(...k),A=Math.max(...k);e.beginPath(),e.strokeStyle="#e53e3e",e.lineWidth=2,m.forEach((M,q)=>{const G=(M.time-v)*d,D=A===N?.5:(Number(M.value)-N)/(A-N),J=g+t-D*t;q===0?e.moveTo(G,J):e.lineTo(G,J)}),e.stroke()}else h.forEach(x=>{if(x.endTime<v||x.time>z)return;const u=(x.time-v)*d,p=(x.endTime-v)*d,m=Math.max(w,p-u),k=Math.min(5,Math.max(.5,m/2-.5));e.beginPath(),e.moveTo(u+k,g),e.lineTo(p-k,g),e.lineTo(p,g+t/2),e.lineTo(p-k,g+t),e.lineTo(u+k,g+t),e.lineTo(u,g+t/2),e.closePath(),e.fillStyle="#90cdf4",e.strokeStyle="#2b6cb0",e.fill(),e.stroke();const N=String(x.value);e.font="11px sans-serif",e.measureText(N).width+6<m&&(e.fillStyle="#000",e.textAlign="center",e.textBaseline="middle",e.fillText(N,u+m/2,g+t/2))})})};return b.current&&cancelAnimationFrame(b.current),b.current=requestAnimationFrame(U),()=>{b.current&&cancelAnimationFrame(b.current),b.current=null}},[d,j,E,n,t,a,f,w,W,S,o]);const Y=r.useCallback(()=>{y<=0||(_(20),C(()=>Math.min(I,$)))},[f,y]);return{canvasRef:T,pxPerMs:d,scrollMs:j,setScrollMs:C,setPxPerMs:_,maxEndTime:y,maxScrollMs:I,minStartTime:$,containerRef:R,handleFitAll:Y,viewDurationMs:S,recordsByOffset:E}},V={"control-panel":"_control-panel_c31wo_3","control-btn":"_control-btn_c31wo_29"},ae=({viewDurationMs:s,scrollMs:o,pxPerMs:t,setPxPerMs:n,handleFitAll:a})=>l.jsxs("div",{className:V["control-panel"],children:[l.jsx("button",{onClick:()=>n(c=>Math.max(15,Math.ceil(c/1.25))),className:V["control-btn"],children:"Отдалить (–)"}),l.jsx("button",{onClick:()=>n(c=>Math.min(100,Math.ceil(c*1.25))),className:V["control-btn"],children:"Приблизить (+)"}),l.jsx("button",{onClick:a,className:V["control-btn"],children:"Сбросить"}),l.jsxs("div",{children:["Пикселей на мс: ",t.toFixed(2)," px/ms"]}),l.jsxs("div",{children:["Cколько мс: ",s.toFixed(1)," ms"]}),l.jsxs("div",{children:["Стартовая позиция в мс: ",o.toFixed(1)," ms"]})]}),ie="_labels_2x3kd_15",le="_canvas_2x3kd_57",P={"signal-tap-content":"_signal-tap-content_2x3kd_3",labels:ie,"signal-label":"_signal-label_2x3kd_29","canvas-wrapper":"_canvas-wrapper_2x3kd_57",canvas:le},re=({labelWidth:s,rowHeight:o,signals:t,containerRef:n,canvasRef:a})=>l.jsx("div",{className:P["signal-tap-content"],children:l.jsxs("div",{style:{display:"flex",gap:"20px"},children:[l.jsx("div",{style:{width:s},className:P.labels,children:t.map(c=>l.jsx("div",{style:{height:o,lineHeight:`${o}px`},className:P["signal-label"],children:c.name??`Offset ${c.offset}`},c.offset))}),l.jsx("div",{style:{width:"100%"},children:l.jsx("div",{ref:n,className:P["canvas-wrapper"],children:l.jsx("canvas",{ref:a,className:P.canvas})})})]})}),me="_slider_1mjjb_3",Q={"slider-container":"_slider-container_1mjjb_3",slider:me},de=({minStartTime:s,maxScrollMs:o,scrollMs:t,setScrollMs:n})=>l.jsx("div",{className:Q["slider-container"],children:l.jsx("input",{type:"range",min:s,max:o,step:1,value:t,onChange:a=>n(Number(a.target.value)),className:Q.slider})}),ue=({canvasRef:s,rowHeight:o,signals:t,recordsByOffset:n,scrollMs:a,pxPerMs:c,ySpacing:w})=>{const[f,R]=r.useState(null);return r.useEffect(()=>{const T=s.current;if(!T)return;const b=_=>{const j=T.getBoundingClientRect(),C=_.clientX-j.left,W=_.clientY-j.top;let O=!1;t.forEach((y,$)=>{const S=10+$*(o+w);n.get(y.offset).forEach(E=>{const Y=(E.time-a)*c,i=(E.endTime-a)*c,e=S,L=S+o;C>=Y&&C<=i&&W>=e&&W<=L&&(R({x:_.clientX,y:_.clientY,content:`offset: ${y.offset}
start: ${E.time} ms
end: ${E.endTime} ms
value: ${E.value}`}),O=!0)})}),O||R(null)},d=()=>R(null);return T.addEventListener("mousemove",b),T.addEventListener("mouseleave",d),()=>{T.removeEventListener("mousemove",b),T.removeEventListener("mouseleave",d)}},[t,c,a,o,w,n]),f&&l.jsx("div",{style:{position:"fixed",top:f.y+10,left:f.x+10,background:"rgba(0,0,0,0.8)",color:"white",padding:"4px 8px",borderRadius:"4px",fontSize:"12px",whiteSpace:"pre-line",pointerEvents:"none",zIndex:1e3},children:f.content})},fe=({signals:s,height:o=500,rowHeight:t=20,ySpacing:n=16,defaultDurationMs:a=1,initialPxPerMs:c=20,minBlockWidthPx:w=2,labelWidth:f=140})=>{const{canvasRef:R,containerRef:T,pxPerMs:b,scrollMs:d,setScrollMs:_,setPxPerMs:j,minStartTime:C,handleFitAll:W,maxScrollMs:O,viewDurationMs:y,recordsByOffset:$}=ce(c,s,t,o,n,a,w);return console.log(s),l.jsxs("div",{className:se["main-block"],children:[l.jsx(ae,{scrollMs:d,pxPerMs:b,setPxPerMs:j,handleFitAll:W,viewDurationMs:y}),l.jsx(re,{labelWidth:f,rowHeight:t,signals:s,containerRef:T,canvasRef:R}),l.jsx(de,{minStartTime:C,maxScrollMs:O,scrollMs:d,setScrollMs:_}),l.jsx(ue,{canvasRef:R,rowHeight:t,signals:s,recordsByOffset:$,scrollMs:d,pxPerMs:b,ySpacing:n})]})},xe={"offset-rows":"_offset-rows_nun66_1"},be=({})=>{const[s]=H(t=>[t.oscillographicOffsets,t.toggleSend],ee),o=r.useMemo(()=>Object.entries(s).map(([t,n])=>({offset:Number(t),name:n.name,times:n.timePoints,values:n.values,dataType:n.dataType})),[s]);return l.jsxs("div",{className:xe["offset-rows"],style:{overflowX:"auto",maxWidth:"100%",padding:6},children:[o.length!==0&&l.jsx(fe,{signals:o}),o.length===0&&"Нет осцилографированных данных"]})};export{be as default};
