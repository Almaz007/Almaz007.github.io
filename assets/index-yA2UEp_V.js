import{r as _,j as e,c as y}from"./index-_yyRYU0c.js";import{u as v}from"./store-CdHI7myA.js";import{c as D,s as j}from"./shallow-BzaUNWfH.js";import{B as z}from"./Button-B7xuBvS2.js";import{u as N}from"./store-Qwkj2A8Y.js";import{u as C}from"./store-DDBd9R2X.js";import"./helpers-fab74NUc.js";const k="_wrapper_zxo5y_1",F="_form_zxo5y_17",B="_drag_zxo5y_29",E="_label_zxo5y_43",A="_input_zxo5y_49",T="_info_zxo5y_93",U="_btns_zxo5y_103",d={wrapper:k,form:F,drag:B,"action-title":"_action-title_zxo5y_35",label:E,input:A,"file-list":"_file-list_zxo5y_63","download-label":"_download-label_zxo5y_73",info:T,btns:U,"button-reset":"_button-reset_zxo5y_111","button-submit":"_button-submit_zxo5y_113","dnd-tile":"_dnd-tile_zxo5y_135"},S=({handleSubmit:a,title:u})=>{const[t,s]=_.useState([]),[r,i]=_.useState(!1),f=o=>{o.preventDefault(),o.target.files&&o.target.files[0]&&s([o.target.files[0]])},l=()=>{s([])},g=function(o){o.preventDefault(),i(!0)},x=function(o){o.preventDefault(),i(!1)},m=function(o){var n;o.preventDefault(),i(!1),(n=o.dataTransfer)!=null&&n.files&&o.dataTransfer.files[0]&&s([o.dataTransfer.files[0]])};return e.jsxs("div",{className:y(d.wrapper,{[d.drag]:r}),children:[e.jsx("h2",{className:d["dnd-tile"],children:u}),e.jsxs("form",{className:y(d.form),onReset:l,onDragEnter:g,onDragOver:g,onDragLeave:x,onDrop:m,children:[e.jsx("h2",{className:d["action-title"],children:"Перетащите файлы сюда"}),e.jsx("p",{children:"или"}),e.jsxs("label",{className:d.label,children:[e.jsx("span",{className:d["download-label"],children:"Загрузите файл"}),e.jsx("input",{className:d.input,type:"file",multiple:!1,onChange:f})]}),t.length>0&&e.jsxs("div",{className:d.info,children:[e.jsx("ul",{className:d["file-list"],children:e.jsx("li",{children:t[0].name})}),e.jsxs("div",{className:d.btns,children:[e.jsx("button",{className:d["button-reset"],type:"reset",children:"Отменить"}),e.jsx("button",{className:d["button-submit"],onClick:o=>a(o,t),children:"Отправить"})]})]})]})]})},W=D((a,u)=>({ws:null,status:"disconnected",error:null,messages:[],parseOscilografFile:async t=>{const s=await t.arrayBuffer(),r=new DataView(s);console.log(s);const i={};for(let l=0;l+16<=r.byteLength;l+=16){const g=r.getUint32(l,!0);if(g===0)return;const x=r.getUint32(l+4,!0),m=r.getUint32(l+8,!0),o=r.getUint32(l+12,!0);console.log(`номер: ${g}, метка: ${x}, смещение: ${m}, значение: ${o}`),i[m]||(i[m]={timePoints:[],values:[]}),i[m].timePoints.push(x),i[m].values.push(o)}v.getState().updateOscillographicData(i)},connect:t=>{let{ws:s,parseOscilografFile:r,status:i}=u();s||(a({status:"connecting",error:null}),s=new WebSocket(t),a({ws:s}),s.onopen=()=>{a({error:null,status:"connected"}),console.log("WebSocket connected")},s.onmessage=async f=>{f.data instanceof Blob?(a(l=>({messages:[...l.messages,"Получен бинарный пакет"]})),await r(f.data)):(console.log("Получено с сервера:",f.data),a(l=>({messages:[...l.messages,f.data.toString()]})))},s.onerror=()=>{a({error:"Connection error",status:"disconnected"})},s.onclose=()=>{console.log("WebSocket closed. Status was:",i),s=null,a({ws:null})})},disconnect:()=>{const{ws:t}=u();t&&(t.close(),a({ws:null,status:"disconnected"}))},sendMessage:t=>{const{ws:s}=u();s&&(a(r=>({messages:[...r.messages,t]})),s.send(t))},sendFile:t=>{const{ws:s}=u();s&&(a(r=>({messages:[...r.messages,"Файл отправлен"]})),s.send(t))},sendConfig:t=>{const{ws:s}=u();s&&(a(r=>({messages:[...r.messages,"Конфиг отправлен"]})),s.send(t))}})),$="_row_q0ihq_1",O={row:$},Y=()=>{const a=C(n=>n.sendFirmware),[u,t,s,r,i,f,l]=W(n=>[n.status,n.error,n.messages,n.connect,n.disconnect,n.sendConfig,n.sendFile],j),g=N(n=>n.config,j),x=()=>{const n=new TextEncoder().encode(JSON.stringify(g));if(n.length===0){console.log("конфиг не отправлен");return}const c=new TextEncoder().encode("flexibleLogic,"),h=new Uint8Array(c.length+n.length);h.set(c,0),h.set(n,c.length),f(h)},m=async(n,c)=>{if(n.preventDefault(),!c||c.length===0)return;const h=await c[0].arrayBuffer(),w=new Uint8Array(h),p=new TextEncoder().encode("firmware,"),b=new Uint8Array(p.length+w.length);b.set(p,0),b.set(w,p.length),l(b)},o=async(n,c)=>{if(n.preventDefault(),!c||c.length===0)return;const h=await c[0].arrayBuffer();a(h)};return e.jsxs("div",{children:[e.jsx("h2",{children:"WebSocket"}),e.jsxs("p",{children:["Status: ",u," ",t&&`| Error: ${t}`]}),e.jsx("button",{onClick:()=>r("wss://int-rt.ru:3010"),children:"Подключить"}),e.jsx("br",{}),e.jsx("button",{onClick:i,children:"Отключить"}),e.jsx("div",{style:{height:"300px",overflowY:"auto",border:"1px solid blue",padding:"10px",marginTop:"10px"},children:s.map((n,c)=>e.jsx("p",{children:n},c))}),e.jsx("br",{}),e.jsxs("div",{className:O.row,children:[e.jsx(S,{handleSubmit:m,title:"Отправка прошивки по web-socket"}),e.jsx(S,{handleSubmit:o,title:"Отправка прошивки по ble"}),e.jsxs("div",{children:[e.jsx(z,{disabled:!g.scripts.length,onClick:x,text:"загрузить гибкую логику"}),e.jsx("br",{}),!g.scripts.length&&e.jsx("div",{children:"необходимо сформировать гибкую логику"})]})]})]})};export{Y as default};
