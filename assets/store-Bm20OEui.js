import{c as D}from"./shallow-8MTDicKX.js";import{c as I,v as T}from"./helpers-fab74NUc.js";function L(s){const a=new Uint8Array(4);return a[3]=s>>24&255,a[2]=s>>16&255,a[1]=s>>8&255,a[0]=s&255,a}function O(s,a,e){const r=new ArrayBuffer(12),c=new DataView(r);return c.setUint32(0,s,!0),c.setUint32(4,a,!0),c.setUint32(8,e,!0),new Uint8Array(r)}const R=s=>new Promise(a=>setTimeout(a,s)),N=D((s,a)=>({device:null,characteristics:{},logs:[],uuids:{serviceUuid1:"00000115-0000-1000-8000-00805f9b34fb",sendCharacteristicUuid:"00000116-0000-1000-8000-00805f9b34fb",chartCharacteristicUiid:"00000117-0000-1000-8000-00805f9b34fb",firmware_service_UUID:"0000ff00-0000-1000-8000-00805f9b34fb",firmware_service_data_chararcteristic_UUID:"0000ff11-0000-1000-8000-00805f9b34fb",firmware_service_controll_chararcteristic_UUID:"0000ff22-0000-1000-8000-00805f9b34fb",pwa_config_service_UUID:"00000101-0000-1000-8000-00805f9b34fb",pwa_config_service_rx_chararcteristic_UUID:"00000102-0000-1000-8000-00805f9b34fb",pwa_config_service_tx_chararcteristic_UUID:"00000103-0000-1000-8000-00805f9b34fb",oscill_service_UUID:"00000118-0000-1000-8000-00805f9b34fb",oscill_service_rx_chararcteristic_UUID:"00000119-0000-1000-8000-00805f9b34fb",oscill_service_tx_chararcteristic_UUID:"00000120-0000-1000-8000-00805f9b34fb"},modemParameters:{timestamp:0,timestampSubSeconds:0,latitude:0,longitude:0,altitude:0,is_valid:0,fix:0,gp_sats_in_use:0,gl_sats_in_use:0,bd_sats_in_use:0,gp_sats_in_view:0,gl_sats_in_view:0,bd_sats_in_view:0,ppsFlag:0},clearLogs(){s({logs:[]})},connect:async()=>{const{addLog:e,requestBluetoothDevice:r,connectDeviceAndCacheCharacteristic:c,startNotifications:i}=a();try{await r(),await c(),await i()}catch(t){e(`Error: ${t==null?void 0:t.message}`,"err")}},boundHandleDisconnection:()=>{const{device:e,addLog:r}=a();r(`"${e.name}"  bluetooth device disconnected`)},addLog:(e,r="")=>{const{logs:c}=a(),i={id:T(),message:e,type:r};s({logs:[...c,i]})},requestBluetoothDevice:async()=>{const{addLog:e,boundHandleDisconnection:r,uuids:c}=a();e("Requesting bluetooth device...");const i=await navigator.bluetooth.requestDevice({acceptAllDevices:!0,optionalServices:[c.serviceUuid1,c.pwa_config_service_UUID,c.firmware_service_UUID,c.oscill_service_UUID]});e(`${i.name} bluetooth device selected`),i.addEventListener("gattserverdisconnected",r),s({device:i})},connectDeviceAndCacheCharacteristic:async()=>{const{uuids:e,addLog:r,device:c}=a();r("Connecting to GATT server...");const i=await c.gatt.connect();r("GATT server connected, getting services...");const t=await i.getPrimaryService(e.serviceUuid1),l=await i.getPrimaryService(e.firmware_service_UUID),_=await i.getPrimaryService(e.pwa_config_service_UUID),U=await i.getPrimaryService(e.oscill_service_UUID);r("Services founded, getting characteristics...");const g=await _.getCharacteristic(e.pwa_config_service_rx_chararcteristic_UUID),f=await _.getCharacteristic(e.pwa_config_service_tx_chararcteristic_UUID),n=await l.getCharacteristic(e.firmware_service_data_chararcteristic_UUID),o=await l.getCharacteristic(e.firmware_service_controll_chararcteristic_UUID),w=await t.getCharacteristic(e.chartCharacteristicUiid),h=await t.getCharacteristic(e.sendCharacteristicUuid),u=await U.getCharacteristic(e.oscill_service_tx_chararcteristic_UUID);r("Characteristics found"),s({characteristics:{pwa_config_service_rx_chararcteristic:g,pwa_config_service_tx_chararcteristic:f,oscill_service_tx_chararcteristic:u,firmware_service_data_chararcteristic:n,firmware_service_controll_chararcteristic:o,sendCharacteristic:h,chartCharacteristic:w}})},handleChartCharacteristicChanged:e=>{const{addLog:r}=a(),c=new TextDecoder().decode(e.target.value);console.log(c),r(c,"in")},handleModemParametrsChanged:e=>{const{addLog:r}=a(),c=new Uint8Array(e.target.value.buffer),i=new DataView(c.buffer,c.byteOffset,c.byteLength);let t=0;const l=i.getUint32(t,!0);t+=4;let _=i.getUint32(t,!0);_=_/169356432,t+=4;const g=i.getInt32(t,!0)/65536;t+=4;const n=i.getInt32(t,!0)/65536;t+=4;const w=i.getInt32(t,!0)/65536;t+=4;const h=i.getUint8(t);t+=1;const u=i.getUint8(t);t+=1;const b=i.getUint8(t);t+=1;const y=i.getUint8(t);t+=1;const m=i.getUint8(t);t+=1;const d=i.getUint8(t);t+=1;const C=i.getUint8(t);t+=1;const p=i.getUint8(t);t+=1;const v=i.getUint8(t);t+=1,s({modemParameters:{timestamp:l,timestampSubSeconds:_,latitude:g,longitude:n,altitude:w,is_valid:h,fix:u,gp_sats_in_use:b,gl_sats_in_use:y,bd_sats_in_use:m,gp_sats_in_view:d,gl_sats_in_view:C,bd_sats_in_view:p,ppsFlag:v}}),r("modem parametrs received","in")},handleTerminalChanged:e=>{const{addLog:r}=a(),c=new TextDecoder().decode(e.target.value);c.includes("\r")&&console.log("–ø–µ—Ä–µ–Ω–æ—Å —Å—Ç—Ä–æ–∫–∏ –µ—Å—Ç—å"),r(c,"in")},handeFirmwareResponse:e=>{const r=new Uint8Array(e.target.value.buffer);console.log("Notification:",r)},startNotifications:async()=>{const{addLog:e,characteristics:{pwa_config_service_tx_chararcteristic:r,chartCharacteristic:c},handleChartCharacteristicChanged:i}=a();e("Starting notifications..."),await r.startNotifications(),c.addEventListener("characteristicvaluechanged",i),e("Notifications started")},send:async e=>{const{characteristics:{sendCharacteristic:r},device:c,addLog:i}=a();try{if(e=String(e||""),!e)throw new Error("–Ω–µ–ª—å–∑—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—É—Å—Ç—ã–µ –¥–∞–Ω–Ω—ã–µ");if(!c||!r)throw new Error("–Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤—É");await r.writeValue(new TextEncoder().encode(`${e}\r`)),i(e,"out")}catch(t){i(`Error: ${t.message}`,"err")}},sendFirmware:async e=>{const{characteristics:{firmware_service_controll_chararcteristic:r,firmware_service_data_chararcteristic:c},addLog:i}=a();console.log("firmware send start");const t=128,l=12,_=e.byteLength+l,U=Math.ceil(_/t),g=new Uint8Array(e),f={0:"NO_ERROR",1:"MEMORY_CAPA_EXCEED",2:"STATE_ERROR",3:"HASH_ERROR",4:"WRONG_LENGTH",5:"TIMEOUT",6:"UNKNOWN"};try{let n=!1,o=6;if(await r.startNotifications(),r.addEventListener("characteristicvaluechanged",d=>{const p=d.target.value,v=new Uint8Array(p.buffer),E=v[0];if(console.log("–æ—Ç–≤–µ—Ç –æ—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞",v),E===5){o=v[1],n=!0;const A=f[o]||"UNKNOWN";i(`–û—à–∏–±–∫–∞ OTA: ${o} (${A})`,"err")}}),console.log("–¥–æ—à–ª–∏ –¥–æ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤–∫–ª—é—á–µ–Ω–∏—è ble –º–æ–¥–∞"),await r.writeValue(new Uint8Array([0,0])),n)throw new Error(`–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –≤–µ—Ä–Ω—É–ª–æ –æ—à–∏–±–∫—É ${f[o]}`);console.log("–¥–æ—à–ª–∏ –¥–æ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ä–∞–∑–º–µ—Ä–∞ –ø—Ä–æ—à–∏–≤–∫–∏");const w=new Uint8Array(5);if(w[0]=1,w.set(L(_),1),await r.writeValue(w),n)throw new Error(`–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –≤–µ—Ä–Ω—É–ª–æ –æ—à–∏–±–∫—É ${f[o]}`);const h=I(g),u=_-l,b=3405645573,y=new Uint8Array([...O(b,u,h),...g]);if(console.log("–¥–æ—à–ª–∏ –¥–æ –Ω–∞—á–∞–ª–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ä–∞–∑–º–µ—Ä–∞ –ø—Ä–æ—à–∏–≤–∫–∏"),await r.writeValue(new Uint8Array([2])),n)throw new Error(`–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –≤–µ—Ä–Ω—É–ª–æ –æ—à–∏–±–∫—É ${f[o]}`);console.log("–¥–æ—à–ª–∏ –¥–æ –æ—Ç–ø—Ä–∞–≤–∫–∏  –ø—Ä–æ—à–∏–≤–∫–∏");for(let d=0;d<U;d++){if(n)throw new Error(`OTA –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ, –∫–æ–¥ –æ—à–∏–±–∫–∏ ${o}`);await c.writeValue(y.slice(t*d,t*d+t)),await R(5)}console.log("–¥–æ—à–ª–∏ –¥–æ –æ—Ç–ø—Ä–∞–≤–∫–∏  –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏");const m=new Uint8Array(1);if(m[0]=3,await r.writeValue(m),n)throw new Error(`–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –≤–µ—Ä–Ω—É–ª–æ –æ—à–∏–±–∫—É ${o}`);if(console.log("–¥–æ—à–ª–∏ –¥–æ –æ—Ç–ø—Ä–∞–≤–∫–∏  —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –Ω–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫—É"),await r.writeValue(new Uint8Array([4])),n)throw new Error(`–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –≤–µ—Ä–Ω—É–ª–æ –æ—à–∏–±–∫—É ${o}`);i("OTA –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ üöÄ","in")}catch(n){i(`–û—à–∏–±–∫–∞ OTA: ${n.message}`,"err")}},sendConfig:async e=>{const{characteristics:{pwa_config_service_rx_chararcteristic:r},device:c,addLog:i}=a();try{if(!e)throw new Error("–Ω–µ–ª—å–∑—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—É—Å—Ç—ã–µ –¥–∞–Ω–Ω—ã–µ");if(!c||!r)throw new Error("–Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤—É");await r.writeValue(new TextEncoder().encode(e))}catch(t){i(`Error: ${t.message}`,"err")}}}));D((s,a)=>({offsetsByTypes:{bool:[],int:[],float:[],analog:[]},offsetsOsc:[],setOscOffsets(e){s({offsetsOsc:e})},setOffsets(e,r){s({offsetsByTypes:{...a().offsetsByTypes,[r]:[...e]}})}}));export{N as u};
