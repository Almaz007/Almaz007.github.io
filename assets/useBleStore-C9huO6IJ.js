import{c as f}from"./shallow-DyjSOCTL.js";import{v as D}from"./v4-C6aID195.js";const E=f((r,s)=>({offsetsByTypes:{bool:[],int:[],float:[],analog:[]},offsetsOsc:[],setOscOffsets(t){r({offsetsOsc:t})},setOffsets(t,c){r({offsetsByTypes:{...s().offsetsByTypes,[c]:[...t]}})}})),T=f((r,s)=>({device:null,characteristics:{},logs:[],uuids:{serviceUuid1:"00000115-0000-1000-8000-00805f9b34fb",sendCharacteristicUuid:"00000116-0000-1000-8000-00805f9b34fb",chartCharacteristicUiid:"00000117-0000-1000-8000-00805f9b34fb",pwa_config_service_UUID:"00000101-0000-1000-8000-00805f9b34fb",pwa_config_service_rx_chararcteristic_UUID:"00000102-0000-1000-8000-00805f9b34fb",pwa_config_service_tx_chararcteristic_UUID:"00000103-0000-1000-8000-00805f9b34fb",oscill_service_UUID:"00000118-0000-1000-8000-00805f9b34fb",oscill_service_rx_chararcteristic_UUID:"00000119-0000-1000-8000-00805f9b34fb",oscill_service_tx_chararcteristic_UUID:"00000120-0000-1000-8000-00805f9b34fb"},modemParameters:{timestamp:0,timestampSubSeconds:0,latitude:0,longitude:0,altitude:0,is_valid:0,fix:0,gp_sats_in_use:0,gl_sats_in_use:0,bd_sats_in_use:0,gp_sats_in_view:0,gl_sats_in_view:0,bd_sats_in_view:0,ppsFlag:0},clearLogs(){r({logs:[]})},connect:async()=>{const{addLog:t,requestBluetoothDevice:c,connectDeviceAndCacheCharacteristic:a,startNotifications:i}=s();try{await c(),await a(),await i()}catch(e){t(`Error: ${e==null?void 0:e.message}`,"err")}},boundHandleDisconnection:()=>{const{device:t,addLog:c}=s();c(`"${t.name}"  bluetooth device disconnected`)},addLog:(t,c="")=>{const{logs:a}=s(),i={id:D(),message:t,type:c};r({logs:[...a,i]})},requestBluetoothDevice:async()=>{const{addLog:t,boundHandleDisconnection:c,uuids:a}=s();t("Requesting bluetooth device...");const i=await navigator.bluetooth.requestDevice({acceptAllDevices:!0,optionalServices:[a.oscill_service_UUID,a.pwa_config_service_UUID,a.serviceUuid1]});t(`${i.name} bluetooth device selected`),i.addEventListener("gattserverdisconnected",c),r({device:i})},connectDeviceAndCacheCharacteristic:async()=>{const{uuids:t,addLog:c,device:a}=s();c("Connecting to GATT server...");const i=await a.gatt.connect();c("GATT server connected, getting services...");const e=await i.getPrimaryService(t.serviceUuid1),o=await i.getPrimaryService(t.pwa_config_service_UUID);c("Services founded, getting characteristics...");const n=await o.getCharacteristic(t.pwa_config_service_rx_chararcteristic_UUID),_=await o.getCharacteristic(t.pwa_config_service_tx_chararcteristic_UUID),d=await e.getCharacteristic(t.chartCharacteristicUiid),g=await e.getCharacteristic(t.sendCharacteristicUuid);c("Characteristics found"),r({characteristics:{pwa_config_service_rx_chararcteristic:n,pwa_config_service_tx_chararcteristic:_,sendCharacteristic:g,chartCharacteristic:d}})},handleChartCharacteristicChanged:t=>{const{addLog:c}=s(),a=new TextDecoder().decode(t.target.value);console.log(a),c(a,"in")},handleModemParametrsChanged:t=>{const{addLog:c}=s(),a=new Uint8Array(t.target.value.buffer),i=new DataView(a.buffer,a.byteOffset,a.byteLength);let e=0;const o=i.getUint32(e,!0);e+=4;let n=i.getUint32(e,!0);n=n/169356432,e+=4;const d=i.getInt32(e,!0)/65536;e+=4;const l=i.getInt32(e,!0)/65536;e+=4;const u=i.getInt32(e,!0)/65536;e+=4;const h=i.getUint8(e);e+=1;const v=i.getUint8(e);e+=1;const w=i.getUint8(e);e+=1;const U=i.getUint8(e);e+=1;const b=i.getUint8(e);e+=1;const p=i.getUint8(e);e+=1;const m=i.getUint8(e);e+=1;const C=i.getUint8(e);e+=1;const y=i.getUint8(e);e+=1,r({modemParameters:{timestamp:o,timestampSubSeconds:n,latitude:d,longitude:l,altitude:u,is_valid:h,fix:v,gp_sats_in_use:w,gl_sats_in_use:U,bd_sats_in_use:b,gp_sats_in_view:p,gl_sats_in_view:m,bd_sats_in_view:C,ppsFlag:y}}),c("modem parametrs received","in")},handleTerminalChanged:t=>{const{addLog:c}=s(),a=new TextDecoder().decode(t.target.value);a.includes("\r")&&console.log("перенос строки есть"),c(a,"in")},startNotifications:async()=>{const{addLog:t,characteristics:{pwa_config_service_tx_chararcteristic:c,chartCharacteristic:a,handleChartCharacteristicChanged:i}}=s();t("Starting notifications..."),await c.startNotifications(),a.addEventListener("characteristicvaluechanged",i),t("Notifications started")},send:async t=>{const{characteristics:{sendCharacteristic:c},device:a,addLog:i}=s();try{if(t=String(t||""),!t)throw new Error("нельзя отправить пустые данные");if(!a||!c)throw new Error("необходимо подключиться к устройству");await c.writeValue(new TextEncoder().encode(`${t}\r`)),i(t,"out")}catch(e){i(`Error: ${e.message}`,"err")}},sendConfig:async t=>{const{characteristics:{pwa_config_service_rx_chararcteristic:c},device:a,addLog:i}=s();try{if(!t)throw new Error("нельзя отправить пустые данные");if(!a||!c)throw new Error("необходимо подключиться к устройству");await c.writeValue(new TextEncoder().encode(t)),i("конфигурация была отпралена","out")}catch(e){i(`Error: ${e.message}`,"err")}}}));export{T as a,E as u};
